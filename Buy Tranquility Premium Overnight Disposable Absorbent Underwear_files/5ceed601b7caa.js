if(!MINIBC)var MINIBC={};(function($,mbc){mbc.remoteUrl="https://apps.minibc.com";mbc.request=function(data,path,method,dataType,domain,options){data.storeID="Vnd1NW5XUmovTmdRRFhzWXdXUjBMQT09LmtDMzdObDdtYUNtSXNURW8vRHU3Snc9PQEQUALSEQUALS";data.token="5ceed601b7caa";if(!domain)domain=mbc.remoteUrl;options=options||{};var defaults={url:domain+path,type:method,async:true,data:data,dataType:dataType};if(options){$.each(options,function(key,val){defaults[key]=val})}return $.ajax(defaults)};mbc.getUrlParam=function(name){var search=window.location.search,regex=new RegExp("(\\?|&)"+name+"=([^&]+)","g");if(!search||search.length<=0)return false;var results=regex.exec(search);if(results&&results.length>2){return results[2]}return false};mbc.getCustomerToken=function(clientId){var deferred=new $.Deferred;$.ajax({url:"/customer/current.jwt?app_client_id="+clientId,type:"POST",dataType:"json",global:false}).pipe(function(resp){deferred.resolve(resp.token)},function(err){deferred.reject(err)});return deferred.promise()};mbc.verifyCustomerToken=function(appId,token){return mbc.request({customer_token:token,id:appId},"/auth/customer/verify","POST","json")};mbc.getCookie=function(cname){var name=cname+"=";var ca=document.cookie.split(";");for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)==" ")c=c.substring(1);if(c.indexOf(name)!=-1)return c.substring(name.length,c.length)}return""};mbc.getURLParameter=function(name){return decodeURIComponent((new RegExp("[?|&]"+name+"="+"([^&;]+?)(&|#|;|$)").exec(location.search)||[null,""])[1].replace(/\+/g,"%20"))||null};mbc.Log=function(){var logLevel="debug";var levels=["debug","info","warn","error"];var features={console:false,consoleDebug:false,consoleInfo:false,consoleWarn:false,consoleError:false};var appName;var detectBrowserFeatures=function(){features.console=typeof console!=="undefined";if(features.console){features.consoleDebug=typeof console.debug!=="undefined";features.consoleInfo=typeof console.info!=="undefined";features.consoleWarn=typeof console.warn!=="undefined";features.consoleError=typeof console.error!=="undefined";features.consoleLog=typeof console.log!=="undefined"}};var formatMessage=function(message,type){var formatted="";if(appName){formatted+="["+appName+"]"}else{formatted+="[core]"}formatted+="["+type+"] ";formatted+=message;return formatted};var logToConsole=function(type){if(!features.console){return false}var verboseIndex=levels.indexOf(type);var verboseLevelIndex=levels.indexOf(logLevel);return verboseIndex>=verboseLevelIndex};this.setAppName=function(name){appName=name};this.setVerbosity=function(level){if(levels.indexOf(level)>-1){logLevel=level}else{this.error('Invalid verbosity level "'+level+'".')}};this.debug=function(message){if(logToConsole("debug")){var formatted=formatMessage(message,"debug");if(features.consoleDebug){console.debug(formatted)}else{this.log(formatted,true)}}};this.info=function(message){if(logToConsole("info")){var formatted=formatMessage(message,"info");if(features.consoleInfo){console.info(formatted)}else{this.log(formatted,true)}}};this.warn=function(message){if(logToConsole("warn")){var formatted=formatMessage(message,"warn");if(features.consoleWarn){console.warn(formatted)}else{this.log(formatted,true)}}};this.error=function(message){if(logToConsole("error")){var formatted=formatMessage(message,"error");if(features.consoleError){console.error(formatted)}else{this.log(formatted,true)}}};this.log=function(message,isFormatted){if(features.consoleLog){var formatted;if(!isFormatted){formatted=formatMessage(message,"log")}else{formatted=message}console.log(formatted)}};detectBrowserFeatures()};mbc.Events={}})(window.jQuery,MINIBC);
if(window.XDomainRequest){jQuery.ajaxTransport(function(s){if(s.crossDomain&&s.async){if(s.timeout){s.xdrTimeout=s.timeout;delete s.timeout}var xdr;return{send:function(_,complete){function callback(status,statusText,responses,responseHeaders){xdr.onload=xdr.onerror=xdr.ontimeout=xdr.onprogress;xdr=undefined;complete(status,statusText,responses,responseHeaders)}xdr=new XDomainRequest;xdr.open(s.type,s.url);xdr.onload=function(){callback(200,"OK",{text:xdr.responseText},"Content-Type: "+xdr.contentType)};xdr.onerror=function(){callback(404,"Not Found")};xdr.onprogress=function(){return};xdr.ontimeout=function(){callback(0,"timeout")};xdr.timeout=s.xdrTimeout||Number.MAX_VALUE;setTimeout(function(){xdr.send(s.hasContent&&s.data?s.data:null)},0)},abort:function(){if(xdr){xdr.onerror=jQuery.noop;xdr.abort()}}}}})}
(function($,mbcEvent){mbcEvent.Checkout={HandleResponse:jQuery.Event("checkout.handle_response"),_AfterHandleResponse:jQuery.Event("checkout.after_handle_response"),ConfirmPaymentProvider:jQuery.Event("checkout.confirm_payment_provider")}})(window.jQuery,MINIBC.Events);
if(!"ExpressCheckout"in window){var ExpressCheckout={}}(function($,mbcEvents){var _signedIn=0;var _digitalOrder=0;var _currentStep="AccountDetails";var useAddressValidation=false;var _chooseShipping=false;var _chooseBilling=false;if(typeof window.ExpressCheckout!="undefined"){if(typeof window.ExpressCheckout.currentStep!="undefined"){_signedIn=ExpressCheckout.signedIn;_digitalOrder=ExpressCheckout.digitalOrder;_currentStep=ExpressCheckout.currentStep;_chooseShipping=ExpressCheckout.ChooseShippingAddress;_chooseBilling=ExpressCheckout.ChooseBillingAddress}if(typeof window.AVS!="undefined"&&typeof window.AVS.displayErrorModal!="undefined"){useAddressValidation=true}}ExpressCheckout={completedSteps:new Array,currentStep:"AccountDetails",signedIn:0,digitalOrder:0,createAccount:0,anonymousCheckout:0,checkoutLogin:0,init:function(){if($("#CheckoutStepAccountDetails").css("display")==="none"){ExpressCheckout.currentStep="BillingAddress"}else{$("#BillingDetailsLabel").html(lang.ExpressCheckoutStepBillingAccountDetails)}$(".ExpressCheckoutBlock").hover(function(){if($(this).hasClass("ExpressCheckoutBlockCompleted")){$(this).css("cursor","pointer")}},function(){$(this).css("cursor","default")});$(".ExpressCheckoutTitle").click(function(){if($(this).hasClass("ExpressCheckoutBlockCompleted")){$(this).find(".ChangeLink").click()}});$(document).ajaxError(function(event,request,settings){ExpressCheckout.HideLoadingIndicators();alert(lang.ExpressCheckoutLoadError)})},Login:function(){$("#CheckoutLoginError").hide();ExpressCheckout.anonymousCheckout=0;ExpressCheckout.createAccount=0;if(ExpressCheckout.validateEmailAddress($("#login_email").val())===false){alert(lang.LoginEnterValidEmail);$("#login_email").focus();$("#login_email").select();return false}if($("#login_pass").val()===""){alert(lang.LoginEnterPassword);$("#login_pass").focus();return false}ExpressCheckout.ShowLoadingIndicator("#LoginForm");$.ajax({url:"remote.php",type:"post",dataType:"json",data:"w=expressCheckoutLogin&"+$("#LoginForm").serialize(),success:ExpressCheckout.HandleResponse});return false},HandleResponse:function(response){ExpressCheckout.HideLoadingIndicators();var _response=$("html").triggerHandler(mbcEvents.HandleResponse,[response]);if(typeof _response!=="undefined"){if(_response===false){return false}}else{_response=response}$.when(_response).done(function(respObj){if(typeof respObj!=="undefined")response=respObj;if(response.completedSteps!==undefined){$.each(response.completedSteps,function(){var value=document.createTextNode(this.message);$("#CheckoutStep"+this.id+" .ExpressCheckoutCompletedContent").html(value);$("#CheckoutStep"+this.id).addClass("ExpressCheckoutBlockCompleted");ExpressCheckout.completedSteps[ExpressCheckout.completedSteps.length]=this.id})}if(response.stepContent!==undefined){$.each(response.stepContent,function(){$("#CheckoutStep"+this.id+" .ExpressCheckoutContent").html(this.content);$("#CheckoutStep"+this.id+" .ExpressCheckoutContent .FormField.JSHidden").show()})}ExpressCheckout.HandleResponseStatus(response)})},HandleResponseStatus:function(response){$("html").trigger("checkout:handle_response_status",[response]);if(response.status===0){if(response.errorContainer){$(response.errorContainer).html(response.errorMessage).show()}else{if(typeof response.errorMessage!=="undefined"){alert(response.errorMessage)}}}if(response.changeStep){ExpressCheckout.ChangeStep(response.changeStep);ExpressCheckout.ResetNextSteps()}if(response.focus){try{$(response.focus).focus().select()}catch(e){}}},GuestCheckout:function(){var type;$("#CreateAccountForm").show();$("#CheckoutLoginError").hide();if($("#CheckoutGuestForm").css("display")!=="none"&&!$("#checkout_type_register:checked").val()){type="guest";ExpressCheckout.anonymousCheckout=1;ExpressCheckout.createAccount=0}else{type="account";ExpressCheckout.anonymousCheckout=0;ExpressCheckout.createAccount=1}ExpressCheckout.ShowLoadingIndicator("#CheckoutGuestForm");$.ajax({url:"remote.php",type:"post",dataType:"json",data:{w:"expressCheckoutGetAddressFields",type:type},success:ExpressCheckout.HandleResponse})},ResetNextSteps:function(){var steps=ExpressCheckout.GetSteps();var beginReset=false;var newCompleted=[];$.each(steps,function(i,step){if(step===ExpressCheckout.currentStep){newCompleted[newCompleted.length]=step;beginReset=true}else if(beginReset===true){$("#CheckoutStep"+step).removeClass("ExpressCheckoutBlockCompleted");$("#CheckoutStep"+step+" .ExpressCheckoutCompletedContent").html("")}});ExpressCheckout.completedSteps=newCompleted},ChangeStep:function(step){var topAcc2;$("#bottom_payment_button").removeAttr("disabled");if(typeof step==="undefined"){step=ExpressCheckout.CalculateNextStep(ExpressCheckout.currentStep)}if(step===ExpressCheckout.currentStep){return false}$("#CheckoutStep"+ExpressCheckout.currentStep+" .ExpressCheckoutContent").slideUp("slow");$("#CheckoutStep"+ExpressCheckout.currentStep).addClass("ExpressCheckoutBlockCollapsed");if($.inArray(ExpressCheckout.currentStep,ExpressCheckout.completedSteps)!==-1){$("#CheckoutStep"+ExpressCheckout.currentStep).addClass("ExpressCheckoutBlockCompleted")}$("#CheckoutStep"+step+" .ExpressCheckoutContent").slideDown("slow",function(){if($.inviewport!==undefined){var checkoutInViewport=$(this).find(".ExpressCheckoutTitle").is(":in-viewport");if(!checkoutInViewport){topAcc2=$(this).offset().top;$("html, body").animate({scrollTop:topAcc2-90},600)}}});$("#CheckoutStep"+step).removeClass("ExpressCheckoutBlockCollapsed");ExpressCheckout.currentStep=step;return false},GetSteps:function(){var steps=new Array;if(ExpressCheckout.signedIn===0){steps[steps.length]="AccountDetails"}steps[steps.length]="BillingAddress";if(!ExpressCheckout.digitalOrder){steps[steps.length]="ShippingAddress";steps[steps.length]="ShippingProvider"}steps[steps.length]="Confirmation";steps[steps.length]="PaymentDetails";return steps},CalculateNextStep:function(currentStep){var steps=ExpressCheckout.GetSteps();var nextStep="";$.each(steps,function(i,step){if(step===currentStep){nextStep=steps[i+1]}});if(nextStep){return nextStep}},ChooseBillingAddress:function(){var addressType;if(!$("#BillingAddressTypeExisting:checked").val()||$("#ChooseBillingAddress").css("display")==="none"){if((ExpressCheckout.anonymousCheckout||ExpressCheckout.createAccount)&&!ExpressCheckout.ValidateNewAccount(true)){return false}if(!ExpressCheckout.ValidateNewAddress("billing")){return false}addressType="new"}else if($(".SelectBillingAddress select option:selected").val()===-1){alert(lang.ExpressCheckoutChooseBilling);$(".SelectBillingAddress select").focus();return false}else{addressType="existing"}var createAppend="";if(ExpressCheckout.createAccount){createAppend="&createAccount=1"}$("noscript").remove();$.ajax({url:"remote.php",type:"post",dataType:"json",data:"w=saveExpressCheckoutBillingAddress&"+$("#NewBillingAddress").serialize()+"&BillingAddressType="+addressType+createAppend,success:ExpressCheckout.HandleResponse});return false},ChooseShippingAddress:function(copyBilling){var addressType;if(!$("#ShippingAddressTypeExisting:checked").val()||$("#ChooseShippingAddress").css("display")==="none"){if(!ExpressCheckout.ValidateNewAddress("shipping")){return false}addressType="new"}else if($(".SelectShippingAddress select option:selected").val()===-1){alert(lang.ExpressCheckoutChooseShipping);$(".SelectShippingAddress select").focus();return false}else{addressType="existing"}$.ajax({url:"remote.php",type:"post",dataType:"json",data:"w=saveExpressCheckoutShippingAddress&"+$("#NewShippingAddress").serialize()+"&ShippingAddressType="+addressType,success:ExpressCheckout.HandleResponse});return false},SetBillingAndShippingAddress:function(){if($(".SelectBillingAddress select option:selected").html()===null){return}billingAddress=$(".SelectBillingAddress select option:selected").html().substring(0,58);$("#CheckoutStepBillingAddress .ExpressCheckoutCompletedContent").html(billingAddress+"...");$("#CheckoutStepBillingAddress").addClass("ExpressCheckoutBlockCompleted");ExpressCheckout.ChooseShippingAddress();return false},ChooseShippingProvider:function(){var shippingValid=true;if(!$("#CheckoutStepShippingProvider .ShippingProviderList input[type=radio]:checked").val()){alert(lang.ExpressCheckoutChooseShipper);$("#CheckoutStepShippingProvider .ShippingProviderList input[type=radio]").get(0).focus();shippingValid=false;return false}if(shippingValid===false){return false}$.ajax({url:"remote.php",type:"post",dataType:"json",data:"w=saveExpressCheckoutShippingProvider&"+$("#CheckoutStepShippingProvider form").serialize(),success:ExpressCheckout.HandleResponse});return false},ShowLoadingIndicator:function(step){if(typeof step=="undefined"){step="body"}$(step).find(".ExpressCheckoutBlock input[type=submit]").each(function(){$(this).attr("oldValue",$(this).val());$(this).val(lang.ExpressCheckoutLoading);$(this).attr("disabled",true)});$(step).find(".LoadingIndicator").show();$("body").css("cursor","wait")},HideLoadingIndicators:function(){HideLoadingIndicator();$(".ExpressCheckoutBlock input[type=submit]").each(function(){if($(this).attr("oldValue")&&$(this).attr("disabled")===true){$(this).val($(this).attr("oldValue"));$(this).attr("disabled",false)}});$(".LoadingIndicator").hide();$("body").css("cursor","default")},LoadOrderConfirmation:function(){postVars.w="expressCheckoutShowConfirmation";$.ajax({url:"remote.php",type:"post",dataType:"json",data:postVars,success:ExpressCheckout.HandleResponse})},HidePaymentForm:function(){$("#CheckoutStepPaymentDetails").hide();$("#CheckoutStepPaymentDetails .ExpressCheckoutContent").html("")},LoadPaymentForm:function(provider){$.ajax({url:"remote.php",data:"w=expressCheckoutLoadPaymentForm&"+$("#CheckoutStepConfirmation form").serialize(),dataType:"json",type:"post",success:ExpressCheckout.HandleResponse})},ShowSingleMethodPaymentForm:function(){$("#CheckoutStepPaymentDetails").show();ShowContinueButton()},ValidateNewAccount:function(){var password,confirmPassword,formfield=FormField.GetValues(CustomCheckoutFormNewAccount);for(var i=0;i<formfield.length;i++){if(formfield[i].privateId==="EmailAddress"){if(ExpressCheckout.validateEmailAddress(formfield[i].value)===false){alert(lang.LoginEnterValidEmail);FormField.Focus(formfield[i].field);return false}}if(formfield[i].privateId==="Password"){if(!ExpressCheckout.createAccount){continue}password=formfield[i]}else if(formfield[i].privateId==="ConfirmPassword"){if(!ExpressCheckout.createAccount){continue}confirmPassword=formfield[i]}var rtn=FormField.Validate(formfield[i].field);if(!rtn.status){alert(rtn.msg);FormField.Focus(formfield[i].field);return false}}if(ExpressCheckout.createAccount&&password&&password.value!==confirmPassword.value){alert(lang.AccountPasswordsDontMatch);FormField.Focus(confirmPassword.field);return false}return true},BuildAddressLine:function(type){var formId,i;var fieldList={FirstName:"",LastName:"",Company:"",AddressLine1:"",City:"",State:"",Zip:"",Country:""};if(type==="billing"){formId=CustomCheckoutFormBillingAddress}else{formId=CustomCheckoutFormShippingAddress}var formfields=FormField.GetValues(formId);var addressLine="";for(i=0;i<formfields.length;i++){fieldList[formfields[i].privateId]=formfields[i].value}for(var i in fieldList){var val=fieldList[i];if(val!==""){if(addressLine!==""&&i!=="LastName"){addressLine+=", "}else if(i==="LastName"){addressLine+=" "}addressLine+=val}}return addressLine},ValidateNewAddress:function(lowerType,resultOnly){var formId;if(resultOnly!==true){resultOnly=false}if(lowerType==="billing"){formId=CustomCheckoutFormBillingAddress}else{formId=CustomCheckoutFormShippingAddress}var formfields=FormField.GetValues(formId);var hasErrors=false;for(var i=0;i<formfields.length;i++){var rtn=FormField.Validate(formfields[i].field);if(!rtn.status){if(!resultOnly){alert(rtn.msg)}FormField.Focus(formfields[i].field);hasErrors=true;return false}}if(hasErrors===true){return false}else{return true}},validateEmailAddress:function(email){if(email.indexOf("@")===-1||email.indexOf(".")===-1){return false}return true},ToggleAddressType:function(address,type){if(type==="Select"){$(".Select"+address+"Address").show();$(".Add"+address+"Address").hide()}else{$(".Add"+address+"Address").show();$(".Select"+address+"Address").hide()}},SelectedPaymentProvider:function(){var paymentProvider="";if($("#use_store_credit").css("display")!=="none"){if($("#store_credit:checked").val()){if($("#credit_provider_list").css("display")!="none"){paymentProvider=$("#credit_provider_list input:checked")}}else{paymentProvider=$("#provider_list input:checked")}}else{paymentProvider=$("#provider_list input:checked")}return paymentProvider},ConfirmPaymentProvider:function(){if($(".CheckoutHideOrderTermsAndConditions").css("display")!=="none"&&$("#AgreeTermsAndConditions").prop("checked")!==true){alert(lang.TickArgeeTermsAndConditions);return false}if(!confirm_payment_provider()){return false}var paymentProvider=ExpressCheckout.SelectedPaymentProvider();var _response=$("html").triggerHandler("checkout.confirm_payment_provider",[paymentProvider]);if(typeof _response!=="undefined"){if(_response===false)return false}$("#bottom_payment_button").attr("disabled","disabled");if(paymentProvider!=""&&$(paymentProvider).hasClass("ProviderHasPaymentForm")){var providerName=$(".ProviderName"+paymentProvider.val()).html();$("#CheckoutStepConfirmation .ExpressCheckoutCompletedContent").html(providerName);ExpressCheckout.LoadPaymentForm($(paymentProvider).val());return false}else{ExpressCheckout.HidePaymentForm();return true}},ApplyCouponCode:function(){if($("#couponcode").val()===""){alert(lang.EnterCouponCode);$("#couponcode").focus();return false}$.ajax({url:"remote.php",data:"w=getExpressCheckoutConfirmation&"+$("#CheckoutStepConfirmation form").serialize(),dataType:"json",type:"post",success:ExpressCheckout.HandleResponse});return false},UncheckPaymentProvider:function(){$("#provider_list input").each(function(){$(this).attr("checked",false)})}};ExpressCheckout.signedIn=_signedIn;ExpressCheckout.digitalOrder=_digitalOrder;ExpressCheckout.currentStep=_currentStep;if(useAddressValidation){ExpressCheckout.ChooseShippingAddress=_chooseShipping;ExpressCheckout.ChooseBillingAddress=_chooseBilling}})(window.jQuery,MINIBC.Events.Checkout);
if(!MINIBC)var MINIBC={};(function($,mbc){mbc.Cart=function(){var self=this;var formatCartItem=function(item){var options=[];if(item.options.length>0){for(var i=0;i<item.options.length;i++){options.push({label:item.options[i].name,value:item.options[i].value})}}return{item_id:item.id,product_id:item.productId,sku:item.sku,url:item.url,cartTotal:item.extendedSalePrice,options:options,qty:item.quantity}};this.getContents=function(){var deferred=new $.Deferred;$.ajax({url:"/api/storefront/carts",headers:{Accept:"application/json"},dataType:"json",global:false,data:{include:"lineItems.physicalItems.options,lineItems.digitalItems.options"},type:"GET"}).pipe(function(carts){var itemData=[];if(carts.length>0){var cart=carts.shift();var lineItems=cart.lineItems;if(lineItems.physicalItems.length>0){for(var i=0;i<lineItems.physicalItems.length;i++){itemData.push(formatCartItem(lineItems.physicalItems[i]))}}if(lineItems.digitalItems.length>0){for(i=0;i<lineItems.digitalItems.length;i++){itemData.push(formatCartItem(lineItems.digitalItems[i]))}}}deferred.resolve(itemData)}).fail(deferred.reject);return deferred.promise()};this.emptyCart=function(){var deferred=new $.Deferred;self.getContents().then(function(items){if(items.length>0){var postData=$.map(items,function(item){return{id:item.item_id,quantity:0}});$.ajax({url:"/remote/v1/cart/update",type:"POST",dataType:"json",data:{items:postData}}).done(function(resp){if(!resp){deferred.reject()}else{if(resp.data.status=="failed"){deferred.reject(resp.data.message)}else{deferred.resolve()}}}).fail(function(){deferred.reject()})}else{deferred.resolve()}});return deferred.promise()};this.addToCart=function(data){data["action"]="add";data["qty[]"]=1;return $.ajax({method:"POST",url:"/remote/v1/cart/add",data:data})}}})(window.jQuery,MINIBC);
(function($,mbc){var CartSession=function(){var data=false;var cart=this;this.getId=function(){var progress=new $.Deferred;if(data!==false){progress.resolve(data.id)}else{cart.getContents().done(function(resp){progress.resolve(resp.id)}).fail(progress.reject)}return progress.promise()};this.getContents=function(){var progress=new $.Deferred;if(data!==false){progress.resolve(data)}else{$.ajax({url:"/api/storefront/carts",headers:{"Content-Type":"application/json"},type:"GET"}).then(function(resp){if(resp.length===0){progress.reject()}else{var cart=resp.shift();data=cart;progress.resolve(cart)}}).fail(progress.reject)}return progress.promise()};this.getCurrency=function(){var progress=new $.Deferred;if(data!==false){progress.resolve(data.currency.code)}else{cart.getContents().done(function(resp){progress.resolve(resp.currency.code)}).fail(progress.reject)}return progress.promise()};this.getLocale=function(){var progress=new $.Deferred;if(data!==false){progress.resolve(data.locale)}else{cart.getContents().done(function(resp){progress.resolve(resp.locale)}).fail(progress.reject)}return progress.promise()};this.delete=function(){var progress=new $.Deferred;cart.getId().then(function(cartId){return $.ajax({url:"/api/storefront/carts/"+cartId,headers:{"Content-Type":"application/json"},type:"DELETE"})},progress.resolve).then(progress.resolve).fail(function(e){if(e.status){if(e.status===404||e.status===403||e.status===401){progress.resolve()}}progress.reject()});return progress.promise()}};if(typeof mbc.RecurringPayments==="undefined")mbc.RecurringPayments={};mbc.RecurringPayments.CartSession=CartSession})(window.jQuery,MINIBC);
(function($,mbc){var CheckoutSession=function(){var data=false;var cart=new mbc.RecurringPayments.CartSession;var checkout=this;this.getId=function(){var progress=new $.Deferred;if(data!==false){progress.resolve(data.id)}else{cart.getId().then(function(checkoutId){progress.resolve(checkoutId)}).fail(progress.reject)}return progress.promise()};this.getContents=function(getNewData){var progress=new $.Deferred;if(data!==false&&!getNewData){progress.resolve(data)}else{checkout.getId().then(function(checkoutId){return $.ajax({url:"/api/storefront/checkouts/"+checkoutId,headers:{"Content-Type":"application/json"},data:{include:"cart.lineItems.physicalItems.options,cart.lineItems.digitalItems.options,customer,customer.customerGroup"},type:"GET"})}).then(function(resp){if(resp.id){data=resp;progress.resolve(resp)}else{progress.reject()}}).fail(progress.reject)}return progress.promise()};this.getCurrency=function(){var progress=new $.Deferred;if(data!==false){progress.resolve(data.cart.currency.code)}else{cart.getCurrency().then(function(currencyCode){progress.resolve(currencyCode)}).fail(progress.reject)}return progress.promise()};this.getLocale=function(){var progress=new $.Deferred;if(data!==false){progress.resolve(data.cart.locale)}else{cart.getLocale().then(function(locale){progress.resolve(locale)}).fail(progress.reject)}return progress.promise()};this.delete=function(){return cart.delete()};this.createOrder=function(){var progress=new $.Deferred;var orderData={customerMessage:"",useStoreCredit:false};if($("input[name=useStoreCredit]").is(":checked")){orderData.useStoreCredit=true}this.getContents(false).then(function(contents){orderData.customerMessage=contents.customerMessage;$.ajax({url:"/internalapi/v1/checkout/order",headers:{"Content-Type":"application/json","x-xsrf-token":BCData.csrf_token},type:"POST",data:JSON.stringify(orderData)}).then(function(resp){progress.resolve(resp.data.order)}).fail(function(err){var message="Failed to create order.";if(typeof err.responseJSON!=="undefined"){var errDetails=err.responseJSON;if(typeof errDetails.detail==="string"){message+=" "+errDetails.detail}}progress.reject(message)})}).fail(function(){progress.reject("Failed to retrieve checkout contents.")});return progress}};if(typeof mbc.RecurringPayments==="undefined")mbc.RecurringPayments={};mbc.RecurringPayments.CheckoutSession=CheckoutSession})(window.jQuery,MINIBC);
if(typeof MINIBC!=="undefined"){(function($,mbc){var FlexpayCheckout=function(resp,checkout){var logger=new mbc.Log;var paymentAmount=resp.flexpay.product_price;logger.setAppName("flexpay");logger.setVerbosity("info");var updatePaymentAmount=function(amount){amount="$"+amount.toFixed(2);var totalSection=$(".cart-section.optimizedCheckout-orderSummary-cartSection").last();if(totalSection.hasClass("total-due")){$("span.cart-priceItem-value > span:first-child",totalSection).text(amount)}else{var amountDueSection=totalSection.clone();amountDueSection.addClass("total-due");var orig_total=$(".orig-total");if(orig_total&&orig_total.length>0){totalSection.remove();totalSection=$(".cart-section.optimizedCheckout-orderSummary-cartSection").last()}$("span.cart-priceItem-label > span:first-child",amountDueSection).text("Due Today");$("span.cart-priceItem-value > span:first-child",amountDueSection).text(amount);$("span.cart-priceItem-value > span:first-child",totalSection).css("font-size","1rem").css("font-weight","normal");amountDueSection.insertAfter(totalSection);totalSection.addClass("orig-total");if($(".cartDrawer .cartDrawer-total").length>0){var hiddenTotal=$(".cartDrawer .cartDrawer-total:not(.mbc-cartDrawer-total)");var displayTotal=$(".cartDrawer .cartDrawer-total.mbc-cartDrawer-total");if(displayTotal.length<1){displayTotal=hiddenTotal.clone().addClass("mbc-cartDrawer-total").insertAfter(hiddenTotal);hiddenTotal.hide()}displayTotal.text(amount)}}};var initCartAfterRender=function(observer){var interval=setInterval(function(){if($(".cart-priceItem--total .cart-priceItem-value").length>0||$(".cartDrawer .cartDrawer-total:not(.mbc-cartDrawer-total)").length>0){logger.info("Rendering payment amount for the current checkout");updatePaymentAmount(paymentAmount);clearInterval(interval);var totalElement=$(".cart-priceItem--total .cart-priceItem-value");if(totalElement.length<1){totalElement=$(".cartDrawer .cartDrawer-total:not(.mbc-cartDrawer-total)")}observer.observe(totalElement[0],{childList:true,subtree:true,characterData:true})}},500)};this.init=function(){logger.info("Flexpay item found in cart, restricting payment methods.");var methodIds=resp.methods.map(function(method){return method.id});checkout.restrictPaymentMethods(methodIds);checkout.setupPaymentForm(resp.methods);var cartContentObserver=new MutationObserver(function(){logger.info("Recalculating payable amount");checkout.validateCheckout().then(function(resp){paymentAmount=resp.flexpay.product_price;updatePaymentAmount(paymentAmount)})});var observer=new MutationObserver(function(mutations){initCartAfterRender(cartContentObserver)});observer.observe($(".optimizedCheckout-contentPrimary > div")[0],{attributes:true,childList:true,characterData:true});initCartAfterRender(cartContentObserver);setInterval(function(){checkout.restrictPaymentMethods(methodIds);checkout.setupPaymentForm(resp.methods);if($(".modalOverlay .optimizedCheckout-orderSummary.cart-modal-body").length>0){if($(".modalOverlay .optimizedCheckout-orderSummary.cart-modal-body .total-due").length===0){updatePaymentAmount(paymentAmount)}}},1500)}};var PreOrderCheckout=function(resp,checkout){var logger=new mbc.Log;logger.setAppName("preorder");logger.setVerbosity("info");var updateDepositAmount=function(depositAmount){var amount="$"+depositAmount.toFixed(2);var totalSection=$(".cart-section.optimizedCheckout-orderSummary-cartSection").last();var amountDueSection=totalSection.clone();$("span.cart-priceItem-label > span:first-child",amountDueSection).text("Total Due");$("span.cart-priceItem-value > span:first-child",amountDueSection).text(amount);$("span.cart-priceItem-value > span:first-child",totalSection).css("font-size","1rem").css("font-weight","normal");amountDueSection.insertAfter(totalSection);$(".cartDrawer .cartDrawer-total").text(amount)};this.init=function(){logger.info("Preorder item found in cart, restricting payment methods.");var methodIds=[];for(var i=0;i<resp.methods.length;i++){methodIds=methodIds.concat(resp.methods[i].bc_ids)}checkout.restrictPaymentMethods(methodIds);checkout.setupPaymentForm(resp.methods);updateDepositAmount(resp.preorder.deposit);setInterval(function(){checkout.restrictPaymentMethods(methodIds);checkout.setupPaymentForm(resp.methods)},1500)}};var SubscriptionCheckout=function(resp,checkout){var logger=new mbc.Log;logger.setAppName("recurring");logger.setVerbosity("info");this.init=function(){logger.info("Subscription item found in cart, restricting payment methods.");var methodIds=[];for(var i=0;i<resp.methods.length;i++){methodIds=methodIds.concat(resp.methods[i].bc_ids)}checkout.hidePaymentFormOverlay();checkout.restrictPaymentMethods(methodIds);checkout.setupPaymentForm(resp.methods);setInterval(function(){checkout.restrictPaymentMethods(methodIds);checkout.setupPaymentForm(resp.methods)},1500)}};var PaymentCheckout=function(resp,checkout){var logger=new mbc.Log;logger.setAppName("vault");logger.setVerbosity("info");this.init=function(){logger.info("No items found that require modification to the checkout.");checkout.setupPaymentForm(resp.methods);setInterval(function(){checkout.setupPaymentForm(resp.methods)},1500)}};var Checkout=function(){var logger=new mbc.Log;logger.setAppName("checkout");logger.setVerbosity("info");var loginInst,self=this;var checkout=new mbc.RecurringPayments.CheckoutSession;this.checkoutSession=checkout;var checkoutStatus="pending";var paymentCaptured=false;var useBCPayment=false;var paymentProviders=[];var checkoutIntent="payment";var tokenizeMethodType=["credit_card","paypal"];var handler;var clientToken="";var paymentAuthToken="";var paymentMethod="credit_card";var viewedHostedError=false;var selectedGateway="";var gatewayData={};var selectors={creditCardForm:".form-ccFields",hostedCardForm:".paymentMethod--hosted",selectedPaymentMethodLabel:".checkout-form .optimizedCheckout-form-checklist-item:not(.mbc-hidden) .form-checklist-header input:checked+.optimizedCheckout-form-label .paymentProviderHeader-name",paymentMethodRadio:".checkout-form .form-checklist-header .optimizedCheckout-form-checklist-checkbox",placeOrderBtn:"#checkout-payment-continue",mbcPayPalButtonContainer:"#mbc-paypal-container",mbcPayPalLoader:"#mbc-paypal-loader",placeholderPaymentRadio:"#radio-cod",ccName:"#ccName",ccNumber:"#ccNumber",ccExpiry:"#ccExpiry",ccCvv:"#ccCvv",savePaymentOption:".mbc-saved-card-field #save-payment-method",profileSelectButton:".instrumentFieldset .instrumentSelect-button",profileSelectOption:".instrumentFieldset .instrumentSelect-option"};var boundProfileSelect="";var bindCustomSelectEvent=true;var currency="USD";var verificationProgress=false;var hostedFormResponse=[];var resetGatewayData=function(){gatewayData={}};var getCardType=function(cardNum){var cardTypes=[{niceType:"Visa",type:"visa",patterns:[4],gaps:[4,8,12],lengths:[16,18,19],code:{name:"CVV",size:3}},{niceType:"Mastercard",type:"mastercard",patterns:[[51,55],[2221,2229],[223,229],[23,26],[270,271],2720],gaps:[4,8,12],lengths:[16],code:{name:"CVC",size:3}},{niceType:"American Express",type:"american-express",patterns:[34,37],gaps:[4,10],lengths:[15],code:{name:"CID",size:4}},{niceType:"Diners Club",type:"diners-club",patterns:[[300,305],36,38,39],gaps:[4,10],lengths:[14,16,19],code:{name:"CVV",size:3}},{niceType:"Discover",type:"discover",patterns:[6011,[644,649],65],gaps:[4,8,12],lengths:[16,19],code:{name:"CID",size:3}},{niceType:"JCB",type:"jcb",patterns:[2131,1800,[3528,3589]],gaps:[4,8,12],lengths:[16,17,18,19],code:{name:"CVV",size:3}},{niceType:"UnionPay",type:"unionpay",patterns:[620,[624,626],[62100,62182],[62184,62187],[62185,62197],[62200,62205],[622010,622999],622018,[622019,622999],[62207,62209],[622126,622925],[623,626],6270,6272,6276,[627700,627779],[627781,627799],[6282,6289],6291,6292,810,[8110,8131],[8132,8151],[8152,8163],[8164,8171]],gaps:[4,8,12],lengths:[14,15,16,17,18,19],code:{name:"CVN",size:3}},{niceType:"Maestro",type:"maestro",patterns:[493698,[5e5,506698],[506779,508999],[56,59],63,67,6],gaps:[4,8,12],lengths:[12,13,14,15,16,17,18,19],code:{name:"CVC",size:3}},{niceType:"Elo",type:"elo",patterns:[401178,401179,438935,457631,457632,431274,451416,457393,504175,[506699,506778],[509e3,509999],627780,636297,636368,[650031,650033],[650035,650051],[650405,650439],[650485,650538],[650541,650598],[650700,650718],[650720,650727],[650901,650978],[651652,651679],[655e3,655019],[655021,655058]],gaps:[4,8,12],lengths:[16],code:{name:"CVE",size:3}},{niceType:"Mir",type:"mir",patterns:[[2200,2204]],gaps:[4,8,12],lengths:[16,17,18,19],code:{name:"CVP2",size:3}},{niceType:"Hiper",type:"hiper",patterns:[637095,637568,637599,637609,637612],gaps:[4,8,12],lengths:[16],code:{name:"CVC",size:3}},{niceType:"Hipercard",type:"hipercard",patterns:[606282],gaps:[4,8,12],lengths:[16],code:{name:"CVC",size:3}}];var cardType,pattern;for(var i=0;i<cardTypes.length;i++){cardType=cardTypes[i];for(var x=0;x<cardType.patterns.length;x++){pattern=cardType.patterns[x];if(typeof pattern==="string"||typeof pattern==="number"){if(cardNum.indexOf(pattern)===0){return cardType}}else{for(var y=pattern[0];y<=pattern[1];y++){if(cardNum.indexOf(y)===0){return cardType}}}}}return false};var highlightCardType=function(type,container){if(type==="none"){$(".creditCardTypes-list-item",container).removeClass("is-active not-active")}else{$(".creditCardTypes-list-item",container).removeClass("is-active").addClass("not-active");$("[data-test=credit-card-icon-"+type+"]",container).closest(".creditCardTypes-list-item").removeClass("not-active").addClass("is-active")}};var formatCardNumber=function(cardNum,type){var numbers=cardNum.split("");var formatted=numbers;for(var i=0;i<type.gaps.length;i++){if(numbers.length<=type.gaps[i]+1)break;formatted.splice(type.gaps[i]+i,0," ")}return formatted.join("")};var formatExpiryDate=function(expiry){expiry=expiry.replace(/[^\d]/g,"");var formatted=expiry.substr(0,2);if(expiry.length>2){if(expiry.length===6){formatted+=" / "+expiry.substr(-2,2)}else{formatted+=" / "+expiry.substr(2,2)}}return formatted};var bindEvents=function(){window.addEventListener("message",function(e){if(e.origin==="https://apps.minibc.com"){var messageData=e.data;if(messageData){if(messageData.ref){var refId=messageData.ref;if(hostedFormResponse[refId]){hostedFormResponse[refId].resolve(messageData)}}else if(messageData.action){if(messageData.action==="card_type_change"){var container=$("iframe[id^=mbc-payment-form]").closest(".form-checklist-item");highlightCardType(messageData.card_type,container)}else if(messageData.action==="height_change"){$("iframe[id^=mbc-payment-form]").css("height",messageData.height+"px")}}}}});$("html").on("keyup",".minibc-injected-method #ccNumber",function(){var value=$.trim(this.value).replace(/[^\d]/g,"");var cardType=getCardType(value);var container=$(this).closest(".minibc-injected-method");if(cardType!==false){highlightCardType(cardType.type,container);this.value=$.trim(formatCardNumber(value,cardType))}else{highlightCardType("none",container)}}).on("keyup",".minibc-injected-method #ccExpiry",function(){var value=$.trim(this.value).replace(/[^\d]/g,"");this.value=$.trim(formatExpiryDate(value))}).on("keypress","credit-card",function(e){if(e.keyCode===13){e.preventDefault();$(selectors.placeOrderBtn).trigger("click")}}).on("click",selectors.placeOrderBtn,function(e){var id=getGatewayId();logger.info("Place order button clicked, selected payment method: "+id);if(paymentCaptured){paymentCaptured=false;return true}var filteredProvider=paymentProviders.filter(function(provider){return provider.bc_ids.indexOf(id)>-1}).shift();if(!filteredProvider){logger.info("Selected provider is not supported.");return true}selectedGateway=filteredProvider.id;var provider=getProviderData(selectedGateway);if(provider===false){logger.error("Failed to find configuration for provider.");return true}var terms=$("#terms");if(terms.length>0){if(!terms.is(":checked")){logger.error("Shopper did not accept terms and conditions.");return true}}e.preventDefault();if(checkoutStatus!=="ready"){logger.info("Checkout is not ready yet");return false}if(checkoutStatus==="error"){logger.error("An error occurred when setting up checkout, payment is not available");return false}disableFinishOrderButton();showLoadingIndicator();logger.info("Getting checkout data.");checkout.getContents(true).then(function(checkoutData){if(checkoutData.outstandingBalance===0&&checkoutIntent==="payment"){paymentCaptured=true;enableFinishOrderButton();$(selectors.placeOrderBtn).trigger("click")}else{getPaymentDetails(id).then(function(paymentDetails){var processOrder=setupPayment(paymentDetails);var provider=getProviderData(selectedGateway);if(tokenizeMethodType.indexOf(paymentMethod)>-1){logger.info("Tokenizing payment details.");processOrder=processOrder.then(function(resp){return tokenizePayment(resp.payment,false)})}if(provider.integration!=="hosted"){if(checkoutIntent!=="payment"||paymentDetails.save_payment===true){processOrder=processOrder.then(function(resp){var payment=resp.payment?resp.payment:resp;return savePaymentDetails(payment)})}}processOrder.then(function(resp){if(resp.success||resp.method){paymentCaptured=true;checkout.getId().then(recordCheckoutId).always(processPayment)}else{logger.error("Failed to save payment details.");paymentCaptured=false;hideLoadingIndicator();enableFinishOrderButton();showPaymentErrorMessage("We encountered an error when processing your payment. Please contact us or try again at a later time.")}}).fail(function(err){paymentCaptured=false;var isGenericError=true;hideLoadingIndicator();enableFinishOrderButton();if(typeof err==="string"){if(err==="PAYPAL_POPUP_CLOSED"){logger.error("Failed to save payment details, payer closed paypal popup.");isGenericError=false}else if(err==="PAYPAL_POPUP_OPEN_FAILED"){logger.error("Failed to save payment details, paypal popup failed to open.");isGenericError=false;showPaymentErrorMessage("The PayPal popup failed to open. If you are using a popup blocker, please allow the popup in your popup blocker and click Place Order again.")}}if(isGenericError){logger.error("Failed to save payment details.");showPaymentErrorMessage("We encountered an error when processing your payment. Please contact us or try again at a later time.")}})}).fail(function(){logger.info("Payment submission stopped, payment details failed validation.");paymentCaptured=false;hideLoadingIndicator();enableFinishOrderButton()})}}).fail(function(){logger.error("Failed to retrieve checkout content.");paymentCaptured=false;hideLoadingIndicator();enableFinishOrderButton();showPaymentErrorMessage("We encountered an error when retrieving the contents of the checkout. Please contact us or try again at a later time.")})}).on("change",selectors.paymentMethodRadio,function(){if($(selectors.paymentMethodRadio+"[name=mbcPaymentProviderRadio]").length>0){togglePaymentMethodItem(this)}var id=$(selectors.paymentMethodRadio+":checked").val();var filteredProvider=paymentProviders.filter(function(provider){return provider.bc_ids.indexOf(id)>-1}).shift();if(filteredProvider){selectedGateway=filteredProvider.id;if(paymentMethod!=="vault"){paymentMethod=filteredProvider.type;if(selectedGateway.indexOf("_")>-1){var gatewayDetails=selectedGateway.split("_");if(gatewayDetails.length>1){gatewayDetails.shift();paymentMethod=gatewayDetails.join("_")}}}}});bindProfileSelectEvents();if($(".optimizedCheckout-form-checklist-checkbox:checked").length===0){$(".form-checklist-checkbox:first-child").trigger("click")}};var togglePaymentMethodItem=function(target){var bcForm,selected=$(target).closest(".form-checklist-item");resetGatewayData();if(target.name==="mbcPaymentProviderRadio"){selected.addClass("form-checklist-item--selected optimizedCheckout-form-checklist-item--selected");$(".form-checklist-body",selected).removeClass("ng-leave ng-leave-active").addClass("ng-enter ng-enter-active").delay(800).removeClass("ng-enter ng-enter-active").addClass("form-checklist-body-enter-done");var gatewayId=target.id.replace("radio-","");var gatewayConfig=getProviderData(gatewayId);var bcSelected=$(selectors.paymentMethodRadio+"[name=paymentProviderRadio]:checked");bcForm=bcSelected.closest(".form-checklist-item").find(".form-checklist-body");bcSelected.removeAttr("checked");bcSelected.closest(".form-checklist-item").addClass("mbc-hidden").removeClass("form-checklist-item--selected optimizedCheckout-form-checklist-item--selected").find(".form-checklist-body").removeClass("ng-enter ng-enter-active").addClass("ng-leave ng-leave-active");bcSelected.each(function(i,radio){radio.checked=false});bcForm.data("form-data",bcForm.html());bcForm.html("");var replaceButtonText=gatewayConfig.type==="digital_wallet"?"Continue":"Place Order";if($(selectors.placeOrderBtn).text()!==replaceButtonText){bcSelected.data("button-text",$(selectors.placeOrderBtn).text());$(selectors.placeOrderBtn).text(replaceButtonText)}}else{if(selected.hasClass("mbc-hidden")){selected.removeClass("mbc-hidden").addClass("form-checklist-item--selected optimizedCheckout-form-checklist-item--selected").find(".form-checklist-body").removeClass("ng-leave ng-leave-active").addClass("ng-enter ng-enter-active").delay(800).removeClass("ng-enter ng-enter-active").addClass("form-checklist-body-enter-done");bcForm=selected.closest(".form-checklist-item").find(".form-checklist-body");if(bcForm.html()===""){var bcFormData=bcForm.data("form-data");bcForm.html(bcFormData)}}$(".checkout-form .form-checklist-item:not(.minibc-injected-method.form-checklist-item--selected)").find(".form-checklist-body").removeClass("ng-enter ng-enter-active ng-leave ng-leave-active");$(".minibc-injected-method").removeClass("form-checklist-item--selected optimizedCheckout-form-checklist-item--selected").find(".form-checklist-body").removeClass("ng-enter ng-enter-active form-checklist-body-enter-done").addClass("ng-leave ng-leave-active");$(".minibc-injected-method input[name=mbcPaymentProviderRadio]").removeAttr("checked");$(".minibc-injected-method input[name=mbcPaymentProviderRadio]").each(function(i,radio){radio.checked=false});if(selected.find("input[type=radio]").data("button-text")!==""){var buttonText=selected.find("input[type=radio]").data("button-text");if($(selectors.placeOrderBtn).text()!==buttonText){$(selectors.placeOrderBtn).text(buttonText)}}}};var bindProfileSelectEvents=function(){if(boundProfileSelect!==selectors.profileSelectButton){$("html").on("click",selectors.profileSelectButton,function(e){e.preventDefault();toggleProfileSelectMenu()}).on("click",selectors.profileSelectOption,function(e){e.preventDefault();updateSelectedOption(this);toggleProfileSelectMenu()});boundProfileSelect=selectors.profileSelectButton}};var getGatewayId=function(){var id=$(".optimizedCheckout-form-checklist-item:not(.mbc-hidden) .optimizedCheckout-form-checklist-checkbox:checked[name=paymentProviderRadio]").attr("id");if(!id){id=$(".optimizedCheckout-form-checklist-item .optimizedCheckout-form-checklist-checkbox:checked[name=mbcPaymentProviderRadio]").attr("id")}if(id){id=id.replace("radio-","");return id}return""};var getProviderData=function(gatewayId,method){var provider=paymentProviders.filter(function(provider){return provider.id===gatewayId||method==="vault"&&provider.gateway_id===gatewayId||provider.id===gatewayId+"_"+method||provider.bc_ids.indexOf(gatewayId)>-1});if(provider.length>0){return provider.shift()}return false};var getPaymentDetails=function(gatewayId){var deferred=new $.Deferred;if(gatewayId.indexOf("_")>-1){var gatewayDetails=gatewayId.split("_");if(gatewayDetails.length>1){gatewayId=gatewayDetails.shift();if(paymentMethod!=="vault"){paymentMethod=gatewayDetails.join("_")}}}var providerData=getProviderData(gatewayId,paymentMethod);if(providerData===false){deferred.reject('Failed to find payment configuration for "'+gatewayId+'".');return deferred.promise()}var data={gateway_id:providerData.gateway_id,method:paymentMethod};if(paymentMethod==="vault"){var storedCard=$(selectors.profileSelectButton);var selectedInstrument=$(".instrumentSelect-details",storedCard);var methodId=parseInt(selectedInstrument.attr("data-id"));if(methodId>0){data.label=$(selectors.paymentMethodLabel).text();data.vault={id:methodId};deferred.resolve(data)}else{deferred.reject("Missing or invalid payment details.")}}else{data.save_payment=$(selectors.savePaymentOption).is(":checked")||"true"==="true";if(paymentMethod==="paypal"){data.paypal={};deferred.resolve(data)}else if(paymentMethod==="credit_card"){if(providerData.integration==="dropin"){data.gateway_id=providerData.gateway_id;data.credit_card={cardholder:"",number:"",expiry:"",cvv:""};deferred.resolve(data)}else{var hostedForm=document.getElementById("mbc-payment-form--"+providerData.id);var timestamp=(new Date).getTime();var refId="get_payment_"+timestamp;var hostedProgress=new $.Deferred;hostedFormResponse[refId]=hostedProgress;hostedProgress.promise().then(function(resp){if(resp.validated){var hostedData=resp.payment;hostedData.gateway_id=data.gateway_id;hostedData.method="credit_card";hostedData.save_payment=data.save_payment;deferred.resolve(hostedData)}else{deferred.reject()}});checkout.getContents(false).then(function(checkoutData){hostedForm.contentWindow.postMessage({action:"get_payment",ref:refId,checkout:checkoutData},"*")})}}else if(paymentMethod==="bank_account"){data.gateway_id=providerData.gateway_id;data.bank_account={account_type:$("#accountType").val(),account_number:$("#accountNumber").val(),routing_number:$("#routingNumber").val(),bank_name:$("#bankName").val(),mandate:$(".mandate-text").text()};deferred.resolve(data)}else if(gatewayId==="cod"){data.method="cod";data.label=$(selectors.selectedPaymentMethodLabel).text();data.cod={};deferred.resolve(data)}else{data[paymentMethod]={method:paymentMethod};deferred.resolve(data)}}return deferred.promise()};var recordCheckoutId=function(checkoutId){if(window.sessionStorage){window.sessionStorage.setItem("MBC_CHECKOUT_ID",checkoutId)}};var setupPayment=function(payment){var progress=new $.Deferred;var method=payment.method;var data={gateway_id:payment.gateway_id,method:method,intent:checkoutIntent};var response={success:false,payment:payment};checkout.getContents().then(function(checkoutData){data.checkout_id=checkoutData.id;data.currency=checkoutData.cart.currency.code;return mbc.request(data,"/apps/recurring/checkouts/payment/init","POST","json")}).then(function(resp){if(resp.success){if(resp.client_token!==""){clientToken=resp.client_token}paymentAuthToken=resp.auth_token;response.success=true;progress.resolve(response)}else{progress.reject(resp.errors)}}).fail(progress.reject);return progress.promise()};var tokenizePayment=function(payment,isPaymentProcessing){var progress=new $.Deferred;var method=payment.method;var data={gateway_id:payment.gateway_id,method:method};var cardData;if(typeof payment[method]["nonce"]!=="undefined"){data[method]=payment[method];progress.resolve(data)}else{if(payment.gateway_id==="stripe"){if(gatewayData.stripe){var stripe=gatewayData.stripe;var card=gatewayData.card;data[method]={nonce:"tokenized_with_payment",last4:"0000",expiry_month:1,expiry_year:11,save_payment:payment.save_payment};progress.resolve(data)}else{cardData=payment.credit_card;Stripe.setPublishableKey(clientToken);Stripe.card.createToken({number:cardData.number,exp_month:cardData.expiry_month,exp_year:cardData.expiry_year,cvc:cardData.cvv},function(status,response){if(response.error){progress.reject(response.error.message)}else{data[method]={cardholder:cardData.cardholder,nonce:response.id,last4:cardData.number.substr(-4,4),expiry_month:cardData.expiry_month,expiry_year:cardData.expiry_year};progress.resolve(data)}})}}else if(payment.gateway_id==="braintree"){var initError=false;if(typeof gatewayData.braintree==="undefined"){initError=true}else{if(typeof gatewayData.braintree.client!=="object"){initError=true}if(paymentMethod==="paypal"&&typeof gatewayData.braintree.paypal!=="object"){initError=true}if(paymentMethod==="bank_account"&&typeof gatewayData.braintree.bankAccount!=="object"){initError=true}}if(initError){progress.reject()}else{checkout.getContents().done(function(content){var billingAddress=content.billingAddress;if(paymentMethod==="credit_card"){cardData=payment.credit_card;var btData={creditCard:{number:cardData.number,cardholderName:cardData.cardholder,expirationMonth:cardData.expiry_month,expirationYear:cardData.expiry_year,cvv:cardData.cvv,billingAddress:{postalCode:billingAddress.postalCode,streetAddress:billingAddress.address1}}};gatewayData.braintree.client.request({endpoint:"payment_methods/credit_cards",method:"post",data:btData},function(requestErr,response){if(requestErr){progress.reject()}else{data[method]={cardholder:cardData.cardholder,nonce:response.creditCards[0].nonce,last4:cardData.number.substr(-4,4),expiry_month:cardData.expiry_month,expiry_year:cardData.expiry_year};progress.resolve(data)}})}else if(paymentMethod==="paypal"){var nonceReady=new $.Deferred;if(gatewayData.braintree.paypalNonce===""){var btPaypalData={enableShippingAddress:true,flow:payment.save_payment?"vault":"checkout",useraction:"commit",amount:content.outstandingBalance,currency:"USD",locale:"en-US"};if(content.consignments.length>0){var shippingAddress=content.consignments[0].shippingAddress;btPaypalData.shippingAddressEditable=false;btPaypalData.shippingAddressOverride={recipientName:shippingAddress.firstName+" "+shippingAddress.lastName,line1:shippingAddress.address1,line2:shippingAddress.address2,city:shippingAddress.city,countryCode:shippingAddress.countryCode,postalCode:shippingAddress.postalCode,state:shippingAddress.stateOrProvinceCode,phone:shippingAddress.phone}}gatewayData.braintree.paypal.tokenize(btPaypalData,function(tokenizeErr,payload){if(tokenizeErr){nonceReady.reject(tokenizeErr.code)}else{var payloadData=JSON.parse(JSON.stringify(data));payloadData[method]={nonce:payload.nonce,details:{payer_id:payload.details.payerId,first_name:payload.details.firstName,last_name:payload.details.lastName,email:payload.details.email}};if(payload.data&&payload.data.billingToken){payloadData[method]["details"]["billing_agreement_id"]=payload.data.billingToken}gatewayData.braintree.paypalNonce=payloadData;nonceReady.resolve()}})}else{nonceReady.resolve()}nonceReady.promise().then(function(){if(isPaymentProcessing===false){data[method]={nonce:"tokenize_with_payment",details:{payer_id:"",first_name:"",last_name:"",email:""}};progress.resolve(data)}else{if(gatewayData.braintree.paypalNonce==="error"){progress.reject()}else{var payload=JSON.parse(JSON.stringify(gatewayData.braintree.paypalNonce));gatewayData.braintree.paypalNonce="";progress.resolve(payload)}}},progress.reject)}else if(paymentMethod==="bank_account"){var bankData=payment.bank_account;var accountType=bankData.account_type.indexOf("savings")>-1?"savings":"checking";var btBankData={bankDetails:{accountNumber:bankData.account_number,routingNumber:bankData.routing_number,accountType:accountType,billingAddress:{streetAddress:billingAddress.address1,locality:billingAddress.city,region:billingAddress.stateOrProvinceCode,postalCode:billingAddress.postalCode}},mandateText:bankData.mandate};if(bankData.account_type.indexOf("business")===0){btBankData.ownershipType="business";btBankData.businessName=billingAddress.company}else{btBankData.ownershipType="personal";btBankData.firstName=billingAddress.firstName;btBankData.lastName=billingAddress.lastName}gatewayData.braintree.bankAccount.tokenize(btBankData,function(requestErr,response){if(requestErr){progress.reject()}else{data[method]={account_type:bankData.account_type,bank_name:bankData.bank_name,routing_last4:bankData.routing_number.substr(-4,4),account_last4:bankData.account_number.substr(-4,4),nonce:response.nonce};progress.resolve(data)}})}}).fail(progress.reject)}}else if(payment.gateway_id==="authorizenet"){cardData=payment.credit_card;var auth=clientToken.split(".");var authData={clientKey:auth[1],apiLoginID:auth[0]};var expMonth=cardData.expiry_month.toString();var expYear=cardData.expiry_year.toString();if(expYear.length>2){expYear=expYear.substring(expYear.length-2)}var ccData={fullName:cardData.cardholder,cardNumber:cardData.number,month:expMonth,year:expYear,cardCode:cardData.cvv};var secureData={authData:authData,cardData:ccData};Accept.dispatchData(secureData,function(resp){if(resp.messages.resultCode==="Error"){var error="Failed to tokenize payment method.";if(resp.messages.message.length>0){var message=resp.messages.message[0];error=message.code+": "+message.text}progress.reject(error)}else{data[method]={cardholder:cardData.cardholder,nonce:resp.opaqueData.dataValue,last4:cardData.number.substr(-4,4),expiry_month:cardData.expiry_month,expiry_year:cardData.expiry_year};progress.resolve(data)}})}else if(payment.gateway_id==="cardconnect"){cardData=payment.credit_card;$.ajax({url:"https://"+clientToken+"/cardsecure/api/v1/ccn/tokenize",type:"POST",dataType:"json",data:JSON.stringify({account:cardData.number}),headers:{"Content-Type":"application/json"}}).done(function(resp){if(resp.errorcode>0){progress.reject(resp.message)}else{data[method]={cardholder:cardData.cardholder,nonce:resp.token,last4:cardData.number.substr(-4,4),expiry_month:cardData.expiry_month,expiry_year:cardData.expiry_year};progress.resolve(data)}}).fail(progress.reject)}else if(payment.gateway_id==="squarev2"){gatewayData.square.client.requestCardNonce();var checkInterval=setInterval(function(){if(typeof gatewayData.square.nonceResponse==="object"){clearInterval(checkInterval);var response=gatewayData.square.nonceResponse;gatewayData.square.nonceResponse=false;if(response.errors){var error=response.errors.shift();progress.reject(error.message)}else{var returnedCard=response.cardData;if(response.billing_postal_code){checkout.getContents(false).then(function(contents){var billing=contents.billingAddress;if(billing.postalCode!==response.billing_postal_code){progress.reject("ZIP/Postal code does not match billing address.")}else{data[method]={nonce:response.nonce,last4:returnedCard.last_4,expiry_month:returnedCard.exp_month,expiry_year:returnedCard.exp_year};progress.resolve(data)}}).fail(function(){data[method]={nonce:response.nonce,last4:returnedCard.last_4,expiry_month:returnedCard.exp_month,expiry_year:returnedCard.exp_year};progress.resolve(data)})}else{data[method]={nonce:response.nonce,last4:returnedCard.last_4,expiry_month:returnedCard.exp_month,expiry_year:returnedCard.exp_year};progress.resolve(data)}}}},250)}else if(payment.gateway_id==="ewayrapid"){cardData=payment.credit_card;data[method]={cardholder:cardData.cardholder,number:eCrypt.encryptValue(cardData.number,clientToken),expiry_month:cardData.expiry_month,expiry_year:cardData.expiry_year,code:eCrypt.encryptValue(cardData.cvv,clientToken)};progress.resolve(data)}else if(payment.gateway_id==="adyen"){if(gatewayData.adyen.paymentMethod===false){progress.reject("Validation failed.")}else{var now=new Date;data[method]={nonce:JSON.stringify(gatewayData.adyen.paymentMethod),last4:"0000",expiry_month:12,expiry_year:now.getFullYear()+10};progress.resolve(data)}}else if(payment.gateway_id==="gmo"){cardData=payment.credit_card;var expiryString=cardData.expiry_year.toString();if(cardData.expiry_month<=9){expiryString+="0"}expiryString+=cardData.expiry_month.toString();Multipayment.init(clientToken);Multipayment.getToken({cardno:cardData.number,expires:expiryString,securitycode:cardData.cvv,holdername:cardData.cardholder},function(resp){if(resp.resultCode!=="000"){progress.reject()}else{data[method]={nonce:resp.tokenObject.token,last4:cardData.number.substr(-4,4),expiry_month:cardData.expiry_month,expiry_year:cardData.expiry_year};progress.resolve(data)}})}else{cardData=payment.credit_card;data[method]={cardholder:cardData.cardholder,number:cardData.number,expiry_month:cardData.expiry_month,expiry_year:cardData.expiry_year,code:cardData.cvv};progress.resolve(data)}}return progress.promise()};var processPayment=function(saveDetails){if(useBCPayment){logger.info("Processing payment with Bigcommerce.");enableFinishOrderButton();$(selectors.placeOrderBtn).trigger("click")}else{showLoadingIndicator();checkout.getId().then(recordCheckoutId);logger.info("Creating order in Bigcommerce.");var paymentProgress=checkout.createOrder().then(submitPayment);if(saveDetails){paymentProgress.then(function(){var deferred=new $.Deferred;getPaymentDetails(selectedGateway).then(setupPayment).then(function(resp){var payment=resp.payment?resp.payment:resp;return savePaymentDetails(payment)}).then(function(resp){if(resp.success){deferred.resolve()}else{deferred.reject()}}).fail(deferred.reject);return deferred.promise()})}paymentProgress.then(deleteCheckout).then(showConfirmation).fail(function(err){logger.error("Failed to process order.");paymentCaptured=false;var errorMessage="We encountered an error when processing your payment. Please contact us or try again at a later time.";if(typeof err==="string"){errorMessage=err}showPaymentErrorMessage(errorMessage);hideLoadingIndicator();enableFinishOrderButton()})}};var initHostedPayment=function(payment,orderId){var progress=new $.Deferred;checkout.getContents(true).then(function(contents){var billing=contents.billingAddress;var method=payment.method;var selectedMethodLabel=$(selectors.selectedPaymentMethodLabel).first();var gatewayId=payment.gateway_id;var data={auth_token:paymentAuthToken,checkout_id:contents.id,gateway_id:gatewayId,intent:checkoutIntent,order_id:orderId,referer:window.location.href,payment:{method:method,label:selectedMethodLabel.text(),save_payment:payment.save_payment?payment.save_payment:false,address:{first_name:billing.firstName,last_name:billing.lastName,street_1:billing.address1,street_2:billing.address2,city:billing.city,state:billing.stateOrProvince,country_iso2:billing.countryCode,zip:billing.postalCode,phone:billing.phone,email_address:billing.email}}};data.payment[method]=payment[method];mbc.request(data,"/apps/recurring/checkouts/payment/hosted/"+gatewayId+"/init","POST","json").then(progress.resolve,progress.reject)});return progress.promise()};var displayPaymentCode=function(hostedData,payment,provider){var wrapper=$(".ReactModalPortal");var overlay=$('<div class="modalOverlay" />').appendTo(wrapper);var modal=$('<div id="mbc-qr-modal" class="modal optimizedCheckout-contentPrimary modal--error" tabindex="-1" role="dialog" />').appendTo(overlay);var displayName=$("#radio-"+provider.id+"+label .paymentProviderHeader-name").text();var headingText="Payment";if(displayName){headingText+=" with "+displayName}$('<div class="modal-header"></div>').append('<h2 class="modal-header-title optimizedCheckout-headingSecondary" data-test="modal-heading">'+headingText+"</h2>").appendTo(modal);var body=$('<div class="modal-body" data-test="modal-body" />').css("text-align","center").appendTo(modal);$("<p />").text("Please scan the QR code below to complete the order.").appendTo(body);$(" <img />").attr("src",hostedData.qrcode).appendTo(body);$('<div class="modal-footer" data-test="modal-footer" />').append('<button class="button button--small" type="button">Cancel</button>').appendTo(body);checkout.getContents().then(function(contents){var checkPaymentStatus=function(){if($("#mbc-qr-modal").length>0){getHostedPaymentStatus(contents.id,{}).then(function(resp){if(resp.success){if(resp.status==="completed"){showConfirmation()}else if(resp.status==="failed"){if(resp.message){showPaymentErrorMessage(resp.message)}}else if(resp.status==="not_found"){$(".modal-footer button",modal).click()}else{timeout=setTimeout(checkPaymentStatus,1e3)}}})}else{clearTimeout(timeout)}};var timeout=setTimeout(checkPaymentStatus,1e3);$(".modal-footer button",modal).click(function(){wrapper.html("");paymentCaptured=false;hideLoadingIndicator();enableFinishOrderButton()});modal.addClass("modal--afterOpen");overlay.addClass("modalOverlay--afterOpen")})};var submitExternalPayment=function(hostedData,payment){var form=$("<form />").attr("id","external-form").attr("action",hostedData.form_url[0]).attr("method","POST").css("height",0).css("overflow","hidden").css("visibility","hidden");if(payment.method==="credit_card"){var cardData=payment.credit_card;var expString=cardData.expiry_month>9?cardData.expiry_month.toString():"0"+cardData.expiry_month;expString+=cardData.expiry_year.toString().substr(2,2);$('<input name="billing-cc-number" />').attr("value",cardData.number).appendTo(form);$('<input name="billing-cc-exp" />').attr("value",expString).appendTo(form);$('<input name="billing-cvv" />').attr("value",cardData.cvv).appendTo(form)}form.appendTo("body").submit()};var submitPayment=function(order){var progress=new $.Deferred;logger.info("submit payment details to MINIBC, order no. "+order.id);getPaymentDetails(selectedGateway).then(function(payment){var provider=getProviderData(payment.gateway_id,payment.method);var processPayment=setupPayment(payment);if(provider!==false&&provider.integration==="hosted"){processPayment.then(function(resp){return initHostedPayment(payment,order.id)}).then(function(resp){if(resp.data.form_url){submitExternalPayment(resp.data,payment)}else if(resp.data.qrcode){displayPaymentCode(resp.data,payment,provider)}}).fail(progress.reject)}else{if(tokenizeMethodType.indexOf(paymentMethod)>-1){processPayment=processPayment.then(function(resp){return tokenizePayment(resp.payment)})}processPayment.then(function(tokenizedData){if(tokenizedData.payment){tokenizedData=tokenizedData.payment}return getPaymentResponse(tokenizedData,order.id)}).then(function(resp){if(resp.success){progress.resolve()}else{if(resp.errors){progress.reject(resp.errors[0])}else{progress.reject("An error occurred when processing your payment, please try again.")}}}).fail(progress.reject)}});return progress.promise()};var getPaymentResponse=function(payment,orderId,metadata){var progress=$.Deferred();checkout.getContents(true).then(function(contents){var address=contents.billingAddress;var method=payment.method;var selectedMethodLabel=$(selectors.selectedPaymentMethodLabel).first();var data={checkout_id:contents.id,order_id:orderId,intent:checkoutIntent,gateway_id:payment.gateway_id,auth_token:paymentAuthToken,payment:{method:method,label:selectedMethodLabel.text(),address:{first_name:address.firstName,last_name:address.lastName,email_address:address.email,street_1:address.address1,street_2:address.address2,city:address.city,state:address.stateOrProvince,country_iso2:address.countryCode,phone:address.phone,zip:address.postalCode}}};data["payment"][method]=payment[method];if(metadata){data["payment"][method]["metadata"]=metadata}data["payment"]["save_payment"]=$(selectors.savePaymentOption).is(":checked");if(method==="paypal"){data["payment"]["save_payment"]=$(selectors.savePaymentOption).is(":checked")}else if(method==="vault"){data["payment"]["vault"]["customer"]=loginInst.token;data["payment"]["label"]=selectedMethodLabel.text()}mbc.request(data,"/apps/recurring/checkouts/payment","POST","json").then(function(resp){if(resp.action){if(!metadata){logger.info("Additional confirmation required for payment.");if(resp.action==="authorization"){if(payment.gateway_id==="stripe"&&Stripe.version===3){var stripe=gatewayData.stripe;var cardElement=gatewayData.card;var actionData=resp.data;var intentData;if(typeof actionData.token!=="undefined"){intentData={payment_method:actionData.token}}else{intentData={payment_method:{card:cardElement,billing_details:actionData.billing_address}}}stripe.confirmCardPayment(actionData.secret,intentData).then(function(confirmResp){if(confirmResp.paymentIntent){return getPaymentResponse(payment,orderId,confirmResp)}else if(confirmResp.error){progress.reject(confirmResp.error.message)}else{progress.reject()}},progress.reject).then(progress.resolve,progress.reject)}else if(payment.gateway_id==="razorpay"){var options=resp.data;options.handler=function(response){getPaymentResponse(payment,orderId,response).then(progress.resolve,progress.reject)};options.modal={ondismiss:function(){progress.reject()}};var client=new Razorpay(options);client.on("payment.failed",function(resp){progress.reject(resp.error.reason)});client.open()}else if(payment.gateway_id==="gmo"){displaySCAChallenge(resp.data.content).then(function(){var metadata=resp.data;delete metadata.content;return getPaymentResponse(payment,orderId,metadata)},function(){progress.reject("Authentication process has been cancelled.")}).then(progress.resolve,progress.reject)}else if(payment.gateway_id==="adyen"){var authProgress=new $.Deferred;gatewayData.adyen.additionalData=authProgress;authProgress.promise().done(function(confirmResp){return getPaymentResponse(payment,orderId,confirmResp)}).fail(function(){progress.reject()}).always(function(){gatewayData.adyen.additionalData=false});gatewayData.adyen.client.handleAction(resp.data)}}}else{logger.error("Unexpected authorization request.");progress.reject()}}else{progress.resolve(resp)}}).fail(progress.reject)}).fail(function(err){if(err.status===404){progress.resolve({success:true})}else{progress.reject(err)}});return progress.promise()};var deleteCheckout=function(){return checkout.delete()};var showConfirmation=function(){window.location.replace("/checkout/order-confirmation")};var savePaymentDetails=function(payment){var progress=new $.Deferred;checkout.getContents().then(function(content){var data={checkout_id:content.id,gateway_id:payment.gateway_id,intent:checkoutIntent,payment:{currency:content.cart.currency.code,method:payment.method}};data["payment"][payment.method]=payment[payment.method];logger.info("Save payment details.");return mbc.request(data,"/apps/recurring/checkouts/order","POST","json")}).then(progress.resolve,progress.reject).fail(progress.reject);return progress.promise()};var initModal=function(){var wrapper=$(".ReactModalPortal");if(wrapper.length===0){$('<div class="ReactModalPortal" />').appendTo("body");wrapper=$(".ReactModalPortal").first()}var overlay=$('<div class="mbc-overlay modalOverlay" />').appendTo(wrapper);var modal=$('<div class="mbc-modal modal optimizedCheckout-contentPrimary" tabindex="-1" role="dialog" />').appendTo(overlay);$('<div class="modal-header"></div>').append('<h2 class="modal-header-title optimizedCheckout-headingSecondary" data-test="modal-heading"></h2>').appendTo(modal);var body=$('<div class="modal-body" data-test="modal-body" />').appendTo(modal);$('<div class="modal-footer" data-test="modal-footer" />').appendTo(body)};var showModal=function(){var overlay=$(".mbc-overlay");var modal=$(".mbc-modal");modal.addClass("modal--afterOpen");overlay.addClass("modalOverlay--afterOpen")};var removeModal=function(){$(".mbc-overlay").remove()};var showPaymentErrorMessage=function(message){initModal();var modal=$(".mbc-modal");var body=$(".modal-body",modal);var footer=$(".modal-footer",modal);modal.addClass("modal--error");$(".modal-header-title",modal).html('<div class="icon icon--error modal-header-icon icon--small"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"></path></svg></div>Something went wrong.');$("<p />").text(message).prependTo(body);$(".modal-footer",modal).html('<button class="button button--small" type="button">Ok</button>');$(".modal-footer button",modal).click(function(){removeModal()});showModal()};var showLoadingIndicator=function(){$(selectors.placeOrderBtn).addClass("is-loading")};var hideLoadingIndicator=function(){$(selectors.placeOrderBtn).removeClass("is-loading")};var enableFinishOrderButton=function(){$(selectors.placeOrderBtn).attr("disabled",false)};var disableFinishOrderButton=function(){$(selectors.placeOrderBtn).attr("disabled",true)};var parseExpiryDate=function(expiryString){var separator=expiryString.indexOf(" / ")>-1?" / ":"/";var expiry=expiryString.split(separator);var expMonth=expiry.shift();var expYear=expiry.shift();var expYearText=expYear;if(!expMonth||!expYear){return false}if(!(expMonth.match(/[\d]{1,2}/)&&expYear.match(/[\d]{2}/))){return false}expMonth=toInteger(expMonth);expYear=toInteger(expYear);if(isNaN(expMonth)||isNaN(expYear)){return false}if(expMonth>12){return false}var now=new Date;var currentYear=now.getFullYear().toString();var century=toInteger(currentYear.substr(0,2));var year=toInteger(currentYear.substr(2,2));if(year>expYear){century+=1}expYear=toInteger(century.toString()+expYearText);return{month:expMonth,year:expYear}};var toInteger=function(string){string=string.replace(/^[0]+/g,"");return parseInt(string)};this.restrictPaymentMethods=function(methods){$(".checkoutRemote").hide().prev(":not(.customerEmail-container)").hide();$(".checkout-step--payment .form-checklist-item").each(function(i,item){var label=$(".form-checklist-header .form-label",item).attr("for");if(label){label=label.replace("radio-","");if(methods.indexOf(label)<0){$(item).hide()}else{$(item).show()}}});var selectedMethodLabel=$(".checkout-step--payment .form-checklist-item.optimizedCheckout-form-checklist-item--selected:visible input[type=radio]:checked+label");if(selectedMethodLabel.length===0){$(".checkout-step--payment .form-checklist-item:visible:first .form-checklist-header .form-label").click()}};this.hidePaymentFormOverlay=function(){$("<style />").attr("id","mbc-store_credit-hide").attr("type","text/css").html(".storeCreditOverlay{display:none}").appendTo("head")};this.getIntent=function(checkout){var intent="payment";var lineItems=checkout.cart.lineItems.physicalItems;for(var i=0;i<lineItems.length;i++){var itemOptions=lineItems[i].options;for(var j=0;j<itemOptions.length;j++){if(itemOptions[j].name.indexOf("Autoship")>=0&&itemOptions[j].value.indexOf("No, thanks")<0){intent="subscription"}}}return intent};this.validateCheckout=function(){var progress=new $.Deferred;logger.info("Validating current checkout session.");checkout.getContents(true).then(function(data){logger.info("Checkout session "+data.id);currency=data.cart.currency.code;var checkoutData={checkout:data};checkoutIntent=self.getIntent(data);return mbc.request(checkoutData,"/apps/recurring/checkouts/validate","POST","json")}).then(progress.resolve).fail(progress.reject);return progress.promise()};var generateProfileSelect=function(methods,methodType){var field=$('<div class="form-field" />');var container=$('<div class="instrumentSelect" />');var button=$('<button class="instrumentSelect-button optimizedCheckout-form-select dropdown-button form-input" />');var generateProfileOption=function(method,type,selected){selected=selected||false;var item=$('<li class="instrumentSelect-option dropdown-menu-item" />');var button=$('<button type="button" />');generateProfileOptionDetail(method,type).appendTo(button);if(selected){item.addClass("instrumentSelect-option--selected")}return item.append(button)};var generateProfileOptionDetail=function(method,type){var wrapper=$('<div class="instrumentSelect-details" />');var cardNumber=$('<div class="instrumentSelect-card" />');var icon,optionText;if(method){if(type==="paypal"){optionText=method.payer_email;icon=$('<div class="icon accountIcon-icon icon--medium"><svg height="300" viewBox="0 0 255 300" width="255" xmlns="http://www.w3.org/2000/svg"><path d="M228.03 77.2c3.6-23.02-.03-38.7-12.48-52.89C201.83 8.7 177.07 2 145.4 2H53.4c-6.47 0-11.99 4.7-12.99 11.11L2.1 256.03a7.9 7.9 0 0 0 7.8 9.14h56.78c79.33-53.38 148.45-81.4 161.35-187.97z" fill="#253B80"></path><path d="M228.02 77.2C124 73 95 98 80.5 177.52l-13.82 87.65-3.91 24.85a6.9 6.9 0 0 0 6.82 7.98h47.86c5.67 0 10.48-4.12 11.37-9.71l.48-2.43 9-57.2.59-3.15c.88-5.6 5.7-9.73 11.37-9.73h7.16c46.38 0 82.68-18.83 93.29-73.33 4.43-22.76 2.14-41.77-9.6-55.14a45.77 45.77 0 0 0-13.1-10.1z" fill="#179BD7"></path><path d="M215.33 72.14c-3.88-1.12-7.82-2-11.8-2.62a149.83 149.83 0 0 0-23.79-1.73h-72.1a11.49 11.49 0 0 0-11.36 9.73l-15.34 97.16-.44 2.84a13.1 13.1 0 0 1 12.95-11.1h27c53 0 94.5-21.53 106.62-83.82.37-1.85.67-3.64.95-5.4a64.66 64.66 0 0 0-9.98-4.2c-.9-.3-1.8-.59-2.71-.86z" fill="#222D65"></path></svg></div>')}else{optionText=method.type+" ending in "+method.last_digits;icon=getCardBrandIcon(method.type)}wrapper.attr("data-id",method.id);cardNumber.text(optionText)}else{wrapper.attr("data-id",0);if(type==="paypal"){icon=$('<div class="icon accountIcon-icon icon--medium"><svg height="25" viewBox="0 0 35 25" width="35" xmlns="http://www.w3.org/2000/svg"><path clip-rule="evenodd" d="M33 2H2L2 23H33V2ZM2 0C0.895431 0 0 0.89543 0 2V23C0 24.1046 0.89543 25 2 25H33C34.1046 25 35 24.1046 35 23V2C35 0.89543 34.1046 0 33 0H2Z" fill="#D1D7E0" fill-rule="evenodd"></path><path clip-rule="evenodd" d="M11 12C11 11.4477 11.4477 11 12 11H24C24.5523 11 25 11.4477 25 12V14C25 14.5523 24.5523 15 24 15H12C11.4477 15 11 14.5523 11 14V12Z" fill="#D1D7E0" fill-rule="evenodd"></path><path clip-rule="evenodd" d="M19 6C19.5523 6 20 6.44772 20 7V19C20 19.5523 19.5523 20 19 20H17C16.4477 20 16 19.5523 16 19V7C16 6.44772 16.4477 6 17 6H19Z" fill="#D1D7E0" fill-rule="evenodd"></path></svg></div>');cardNumber.text("Use a different account")}else{icon=getCardBrandIcon();cardNumber.text("Use a different card")}}wrapper.append(icon).append(cardNumber);if(method){if(typeof method.expiry_month==="number"&&method.expiry_month>0){var month=method.expiry_month>9?method.expiry_month.toString():"0"+method.expiry_month.toString();var expiryText="Expires "+month+"/"+method.expiry_year;$('<div class="instrumentSelect-expiry" />').text(expiryText).appendTo(wrapper)}}return wrapper};var getCardBrandIcon=function(brand){var wrapper=$('<span class="cardIcon" />');var icon,defaultIcon=$('<div class="cardIcon-icon cardIcon-icon--default icon icon--medium"></div>');if(typeof brand!=="string"||brand===""){icon=defaultIcon.clone()}else{brand=brand.toLowerCase();brand=brand.replace(" ","-");var existingIcon=$('.icon[data-test="credit-card-icon-'+brand+'"]').first();if(existingIcon.length>0){icon=existingIcon.clone()}else{icon=defaultIcon.clone()}}wrapper.append(icon);return wrapper};var defaultMethod=false,defaultMethodId=0;if(methods.length>0){defaultMethod=methods[0];defaultMethodId=defaultMethod.id}generateProfileOptionDetail(defaultMethod,methodType).appendTo(button);var dropdown=$('<div class="instrumentSelect-dropdownMenu dropdown-menu" />').css("left",0).css("display","none");for(var i=0;i<methods.length;i++){var option=generateProfileOption(methods[i],methodType,i===0);dropdown.append(option)}var newCard=generateProfileOption(null,methodType);dropdown.append(newCard);container.append(button).append(dropdown).appendTo(field);updatePaymentMethod(defaultMethodId);return field};var generateSaveCardOption=function(disabled,methodType){disabled=disabled||false;var container=$('<div class="form-field mbc-saved-card-field" />');var text=methodType==="credit_card"?"Save this card for future transactions":"Save this account for future transactions";$('<input class="form-checkbox" id="save-payment-method" name="save-payment-method" type="checkbox" />').appendTo(container);$('<label class="form-label optimizedCheckout-form-label" for="save-payment-method" />').text(text).appendTo(container);if(disabled){$(".form-checkbox",container).attr("disabled",true).attr("checked",true)}return container};var updatePaymentMethod=function(methodId){var savePaymentField=$(selectors.savePaymentOption).closest(".form-field");var formFields=$(selectors.creditCardForm);if(formFields.filter(".mbc-form_fields").length>0){formFields=formFields.filter(".mbc-form_fields")}if(methodId===0){var selectedGatewayId=getGatewayId();paymentMethod="credit_card";if(selectedGatewayId.indexOf("paypal")>-1){paymentMethod="paypal"}formFields.show();savePaymentField.show()}else{paymentMethod="vault";formFields.hide();savePaymentField.hide()}};var displaySCAChallenge=function(content){verificationProgress=new $.Deferred;var challengeProgress=new $.Deferred;initModal();var modal=$(".mbc-modal");var body=$(".modal-body",modal);var footer=$(".modal-footer",modal);modal.addClass("modal--error");$(".modal-header",modal).remove();$('<iframe id="mbc-sca-challenge" />').css("width","100%").css("height","100%").css("min-height","60vh").css("border","0 none").prependTo(body);footer.html('<button class="button button--small" type="button">Close</button>');$("button",footer).click(function(){removeModal();verificationProgress=false;challengeProgress.reject()});showModal();document.getElementById("mbc-sca-challenge").contentWindow.document.write(content);verificationProgress.promise().done(function(data){removeModal();verificationProgress=false;challengeProgress.resolve(data)});return challengeProgress.promise()};var toggleProfileSelectMenu=function(){var trigger=$(selectors.profileSelectButton);var dropdown=$(selectors.profileSelectButton).siblings(".instrumentSelect-dropdownMenu");if(dropdown.css("display")==="block"){dropdown.hide()}else{var offset=trigger.outerHeight();dropdown.css("top",offset).show()}};var updateSelectedOption=function(selectedElement){$(selectors.profileSelectOption).filter(".instrumentSelect-option--selected").removeClass("instrumentSelect-option--selected");$(selectedElement).addClass("instrumentSelect-option--selected");var selectedDetails=$(selectedElement).find(".instrumentSelect-details").first();$(selectors.profileSelectButton).find(".instrumentSelect-details").replaceWith(selectedDetails.clone());var methodId=selectedDetails.attr("data-id");methodId=methodId?parseInt(methodId):0;updatePaymentMethod(methodId)};var getHostedPaymentStatus=function(checkoutId,filter){var progress=new $.Deferred;var data=filter;if(checkoutId){data.checkout_id=checkoutId;mbc.request(data,"/apps/recurring/checkouts/payment/hosted/status","POST","json").then(progress.resolve,progress.reject)}else{checkout.getContents(true).then(function(contents){data.checkout_id=contents.id;if(contents.orderId){data.order_id=contents.orderId}mbc.request(data,"/apps/recurring/checkouts/payment/hosted/status","POST","json").then(progress.resolve,progress.reject)})}return progress.promise()};var insertPayPalForm=function(provider){var selector=provider.bc_ids.map(function(bc_id){return"#radio-"+bc_id}).join(",");var providerRadio=$(selector).filter(":checked");if(providerRadio.length>0){var contentBody=providerRadio.closest(".form-checklist-header").next(".form-checklist-body");if($(".paymentMethod--hosted",contentBody).length===0){$("<div>"+'<div class="paymentMethod paymentMethod--hosted">'+'<fieldset class="form-fieldset creditCardFieldset">'+'<div class="form-body"></div>'+"</fieldset>"+"</div>"+"</div>").appendTo(contentBody)}}};var insertHostedForm=function(provider){var selector=provider.bc_ids.map(function(bc_id){return"#radio-"+bc_id}).join(",");var providerRadio=$(selector).filter(":checked");if(providerRadio.length>0){if($("iframe#mbc-payment-form--"+provider.id).length===0){logger.info("Inserting payment form for "+provider.id);var contentBody=providerRadio.closest(".form-checklist-header").next(".form-checklist-body");var contentDiv=contentBody.find(".form-ccFields");if(contentDiv.length===0){var hostedFields=contentBody.find(".paymentMethod--hosted");if(hostedFields.length>0){$("<div>"+'<div class="paymentMethod paymentMethod--creditCard">'+'<fieldset class="form-fieldset creditCardFieldset">'+'<legend class="form-legend is-srOnly">Credit card</legend>'+'<div class="form-body">'+'<div class="form-ccFields"></div>'+"</div>"+"</fieldset>"+"</div>"+"</div>").insertAfter(hostedFields);hostedFields.hide();contentDiv=providerRadio.closest(".form-checklist-header").next(".form-checklist-body").find(".form-ccFields")}}else{var cardFieldset=$(".creditCardFieldset",contentBody);if(cardFieldset.length===0){contentBody.html("<div>"+'<div class="paymentMethod paymentMethod--creditCard">'+'<fieldset class="form-fieldset creditCardFieldset">'+'<legend class="form-legend is-srOnly">Credit card</legend>'+'<div class="form-body">'+'<div class="form-ccFields"></div>'+"</div>"+"</fieldset>"+"</div>"+"</div>");contentDiv=contentBody.find(".form-ccFields")}}var contentHeight=contentDiv.outerHeight();contentDiv.html("");$("<iframe />").attr("id","mbc-payment-form--"+provider.id).attr("src","https://apps.minibc.com/apps/recurring/checkouts/payment/hosted/form/"+provider.gateway_id+"/"+currency.toLowerCase()+"?storeID=WDhsa0ZlUGZBY3BsYWRFN2l1ZG9qQT09LitDNEF1MjN4NnFmamoydzVPa3NoYlE9PQEQUALSEQUALS&token=5ceed601b7caa").attr("frameborder","0").attr("allowtransparency","true").attr("scrolling","no").css("width","100%").css("min-height","164px").css("height",contentHeight).appendTo(contentDiv)}}};var insertPaymentMethod=function(provider){var template=provider.template;var providerId=provider.id;var methodList=$(".checkout-step.checkout-step--payment .checkout-form .form-checklist.optimizedCheckout-form-checklist");if(methodList.length===0){if($(".checkout-step.checkout-step--payment > .checkout-view-content > .loadingSpinner:visible").length>0){return}$(".checkout-step.checkout-step--payment > .checkout-view-content").html(provider.structure);methodList=$(".checkout-form .form-checklist.optimizedCheckout-form-checklist")}if($("#radio-"+providerId).length<=0){logger.info("Inserting new payment method: "+provider.id);methodList.append(template);if(provider.integration==="hosted"&&viewedHostedError===false){getHostedPaymentStatus(false,{viewed:false}).then(function(resp){if(resp.success){if(resp.status==="failed"){if(resp.message){$("#radio-"+providerId).trigger("click");showPaymentErrorMessage(resp.message);viewedHostedError=true}}}})}}};this.setupPaymentForm=function(providers){var formField=$(".form-ccFields");var isLoggedIn=loginInst.loggedIn;providers=providers||[];var selected=getGatewayId();var paymentListProgress=new $.Deferred;var paymentListReady=paymentListProgress.promise();var paymentStepContent=$(".checkout-step.checkout-step--payment > .checkout-view-content:visible");if(paymentStepContent.length>0&&paymentStepContent.not(".checkout-view-content-enter-active")&&paymentStepContent.children(".loadingSpinner:visible").length===0&&paymentStepContent.find(".loadingOverlay:visible").length===0){if(providers.length>0){setTimeout(function(){for(var i=0;i<providers.length;i++){if($(".checkout-step.checkout-step--payment > .checkout-view-content:visible").length>0){if(providers[i].template){insertPaymentMethod(providers[i])}else if(providers[i].type==="credit_card"&&providers[i].integration==="direct"){insertHostedForm(providers[i])}else if(providers[i].type==="paypal"||providers[i].gateway_id==="razorpay"){insertPayPalForm(providers[i])}}}paymentListProgress.resolve()},500)}else{paymentListProgress.resolve()}}else{paymentListProgress.resolve()}paymentListReady.then(function(){if(selected===""||$("#radio-"+selected).closest("li").is(":visible")===false){var methodId=$(".optimizedCheckout-form-checklist-item:visible").first().find(".optimizedCheckout-form-checklist-checkbox").attr("id");if(methodId){selected=methodId.replace("radio-","");$("#radio-"+selected).trigger("click")}}if(selected!==""){var filtered=providers.filter(function(prov){return prov.id===selected||prov.bc_ids.indexOf(selected)>-1});if(filtered.length>0){var provider=filtered.shift();var methods=provider.methods||[];if(methods.length===0){paymentMethod=provider.type}var radioSelector=provider.bc_ids.map(function(bc_id){return"#radio-"+bc_id}).join(",");var listItem=$(radioSelector).first().closest("li");var providerFormField=listItem.find(selectors.creditCardForm);if(providerFormField.filter(".mbc-form_fields").length>0){providerFormField=providerFormField.filter(".mbc-form_fields")}else if(provider.integration==="dropin"||provider.type==="paypal"){providerFormField=listItem.find(selectors.hostedCardForm)}if(providerFormField.length>0){formField=providerFormField}formField=formField.filter(":not(.mbc-payment-hidden)");if(formField.length>0&&formField.filter(".mbc-payment-init-done").length===0){var initPayment=false;var canInsertOption=true;if($(formField).is(".paymentMethod--hosted")&&provider.type==="credit_card"){canInsertOption=listItem.is(".minibc-injected-method")}if(canInsertOption){if(isLoggedIn&&methods.length>0){var instrumentWrapper=$(".form-fieldset.instrumentFieldset",listItem);var cardWrapper=$(".form-fieldset.creditCardFieldset",listItem);if(instrumentWrapper.length<=0){instrumentWrapper=$('<div class="form-fieldset instrumentFieldset" />');instrumentWrapper.insertBefore(cardWrapper);var select=generateProfileSelect(methods,provider.type);select.prependTo(instrumentWrapper)}}if(isLoggedIn||checkoutIntent!=="payment"){var forceSavedCard=["subscription","flexpay","preorder"].indexOf(checkoutIntent)>-1;var saveCardOption=$(formField).next(".form-field").find("#save-payment-method");if(saveCardOption.length<=0){saveCardOption=generateSaveCardOption(forceSavedCard,provider.type);if(paymentMethod==="vault"){saveCardOption.hide()}saveCardOption.insertAfter(formField)}}if(formField.is(".mbc-payment-pending-methods")){formField.removeClass("mbc-payment-pending-methods");return}}if(provider.id==="stripe"){if(typeof Stripe!=="undefined"){if(Stripe.version===3){if($("#mbc-form-stripe-fieldset",listItem).length===0){var fieldset=$('<fieldset id="mbc-form-stripe-fieldset" class="form-fieldset creditCardFieldset">'+'<legend class="form-legend is-srOnly">Credit card</legend>'+'<div class="form-body">'+'<form id="mbc-form-stripe" class="form-ccFields mbc-form_fields" style="display:block;margin:0 auto;">'+'<div id="mbc-card-element" class="form-input" style="width:100%;margin-bottom:1rem;padding-top:1rem;" />'+"</form>"+"</div>"+"</fieldset>");fieldset.insertAfter(formField);formField.addClass("mbc-payment-hidden").hide();formField=fieldset;var stripe=Stripe(provider.client_token);var elements=stripe.elements();var card=elements.create("card",{hidePostalCode:true});card.mount("#mbc-card-element");card.on("change",function(event){var container=$("#mbc-card-element").closest(".form-checklist-item");if(event.brand!=="unknown"){highlightCardType(event.brand,container)}else{highlightCardType("none",container)}});gatewayData.stripe=stripe;gatewayData.card=card;$("#mbc-form-stripe").on("submit",function(e){e.preventDefault();$(selectors.placeOrderBtn).trigger("click");return false});listItem.addClass("minibc-injected-method")}else{initPayment=true}}else{initPayment=true}}}else if(provider.id.indexOf("square")===0){var formWrapper=$(formField).parent();if($(".mbc-form-sq-input",formField).length<=0){if($(formField).parent().is(":visible")){formWrapper.addClass("paymentMethod paymentMethod--creditCard");var nextFormField=$(formField).next(".form-field");var newFormField=formField.clone();newFormField.addClass("mbc-form_fields");$("<div />").addClass("form-fieldset creditCardFieldset paymentMethod--hosted").append(newFormField).appendTo(formWrapper);formField.addClass("mbc-payment-hidden").hide();formField=newFormField;if(nextFormField.find("#save-payment-method")){nextFormField.insertAfter(formField)}if($("iframe:not(.mbc-form-sq-input)",formField).length>0){$("iframe:not(.mbc-form-sq-input)",formField).each(function(i,element){var id=$(element).attr("id");var label=$(element).siblings("label");$("<div />").attr("id","mbc-"+id).addClass("form-input mbc-form-sq-input").insertAfter(label);$(element).hide()})}else{$("input",formField).each(function(i,element){var id=$(element).attr("id");var label=$(element).siblings("label");var sqId;if(id==="ccNumber")sqId="mbc-sq-card-number";else if(id==="ccExpiry")sqId="mbc-sq-expiration-date";else if(id==="ccCvv")sqId="mbc-sq-cvv";$("<div />").attr("id",sqId).addClass("form-input mbc-form-sq-input").insertAfter(label);$(element).hide()});$(".form-field > .icon",formField).remove();$(".form-field.form-field--ccName",formField).remove();var cvvField=$(".form-field.form-ccFields-field--ccCvv",formField);$('<div class="form-field form-field--postCode" />').html('<label class="form-label optimizedCheckout-form-label">Postal Code</label><div id="mbc-sq-postal-code" class="form-input mbc-form-sq-input"></div>').insertAfter(cvvField)}var squareClient=new SqPaymentForm({applicationId:provider.client_token,inputClass:"sq-input",autoBuild:false,cardNumber:{elementId:"mbc-sq-card-number",placeholder:""},expirationDate:{elementId:"mbc-sq-expiration-date",placeholder:""},cvv:{elementId:"mbc-sq-cvv",placeholder:""},postalCode:{elementId:"mbc-sq-postal-code",placeholder:""},callbacks:{paymentFormLoaded:function(){checkout.getContents(true).done(function(content){var billingAddress=content.billingAddress;squareClient.setPostalCode(billingAddress.postalCode)})},cardNonceResponseReceived:function(errors,nonce,cardData){gatewayData.square.nonceResponse={errors:errors,nonce:nonce,cardData:cardData}}}});gatewayData.square={client:squareClient,nonceResponse:false};if(methods.length<=0){updatePaymentMethod(0)}listItem.addClass("minibc-injected-method");squareClient.build()}}else{initPayment=true}}else if(provider.id==="adyen"){if($("#mbc-form-adyen-fieldset",listItem).length===0){if(typeof AdyenCheckout!=="undefined"){var newField=$('<fieldset id="mbc-form-adyen-fieldset" class="form-fieldset creditCardFieldset"><legend class="form-legend is-srOnly">Credit card</legend><div class="form-body"><div id="mbc-form-adyen" class="form-ccFields" style="display:block;margin:1rem auto 0 auto;" /></div></fieldset>').addClass("paymentMethod--hosted");newField.insertAfter(formField);formField.addClass("mbc-payment-hidden").hide();formField=newField;var configData=provider.client_token.split(".");var config={locale:"en_US",environment:configData[0],clientKey:configData[1],paymentMethodsResponse:console.log,onChange:function(state){if(state.isValid){gatewayData.adyen.paymentMethod=state.data.paymentMethod}else{gatewayData.adyen.paymentMethod=false}},onBrand:function(brand){var cardBrand=brand.brand;var container=$("#mbc-form-adyen-fieldset").closest(".minibc-injected-method");if(cardBrand==="mc")cardBrand="mastercard";else if(cardBrand==="amex")cardBrand="american-express";else if(cardBrand==="diners")cardBrand="diners-club";else if(cardBrand==="card")cardBrand="none";highlightCardType(cardBrand,container)},onAdditionalDetails:function(state){if(gatewayData.adyen.additionalData!==false){gatewayData.adyen.additionalData.resolve({paymentDetails:state.data})}}};var instConfig={hasHolderName:true,holderNameRequired:true};var checkout=new AdyenCheckout(config);var adyenInst=checkout.create("card",instConfig).mount("#mbc-form-adyen");gatewayData.adyen={client:adyenInst,paymentMethod:false,additionalData:false};if(methods.length<=0){updatePaymentMethod(0)}listItem.addClass("minibc-injected-method")}}else{initPayment=true}}else if(provider.id==="nmi"){$("#radio-nmi").closest(".form-checklist-item").addClass("minibc-injected-method")}else if(provider.id.indexOf("braintree")===0){if(typeof gatewayData.braintree==="undefined"){gatewayData.braintree={}}var initPayPal=function(){if(typeof gatewayData.braintree.paypal==="undefined"&&typeof braintree.paypal!=="undefined"&&typeof gatewayData.braintree.client==="object"){braintree.paypal.create({client:gatewayData.braintree.client},function(paypalErr,paypal){if(paypalErr){logger.error("Failed to initialize paypal.");gatewayData.braintree.paypal=false;gatewayData.braintree.paypalNonce="error"}else{gatewayData.braintree.paypal=paypal;gatewayData.braintree.paypalNonce=""}})}};if(typeof gatewayData.braintree.client==="undefined"){braintree.client.create({authorization:provider.client_token},function(createErr,client){if(createErr){logger.error("Failed to initialize braintree client.");gatewayData.braintree.client=false}else{gatewayData.braintree.client=client}if(provider.type==="paypal"){initPayPal()}})}else{if(provider.type==="paypal"){initPayPal()}}}else{initPayment=true}if(initPayment){formField.addClass("mbc-payment-init-done")}}else if(selected==="braintreepaypal"){var sdkReady=new $.Deferred;var sdkToLoad=[];if(typeof braintree==="undefined"){sdkToLoad.push(loadSdk("https://js.braintreegateway.com/web/3.70.0/js/client.min.js"));sdkToLoad.push(loadSdk("https://js.braintreegateway.com/web/3.70.0/js/paypal-checkout.min.js"))}if(sdkToLoad.length>0){logger.info("Loading dependencies for payment method");$.when.apply($,sdkToLoad).then(function(){sdkReady.resolve()})}else{sdkReady.resolve()}if(methods.length<=0){updatePaymentMethod(0)}}}}})};var loadSdk=function(url){var progress=new $.Deferred;var script=document.createElement("script");script.onload=function(){progress.resolve()};script.src=url;document.head.appendChild(script);return progress.promise()};this.init=function(login,storeConfig){loginInst=login;logger.info("Disabling finish order button.");disableFinishOrderButton();self.validateCheckout().then(function(resp){if(resp.status>0){paymentProviders=resp.methods.map(function(method){if(method.id==="square"){method.id="squarev2"}if(!method.bc_ids){method.bc_ids=[method.id]}if(method.id==="stripe"){method.bc_ids.push("stripev3-card");method.bc_ids.push("stripeupe-card")}else if(method.id==="paypal"){method.bc_ids.push("paypalexpress")}else if(method.id==="adyen"){method.bc_ids.push("adyenv2-scheme")}return method});logger.info("checkout intent: "+checkoutIntent);if(checkoutIntent==="subscription"){handler=new SubscriptionCheckout(resp,self)}else if(resp.intent==="preorder"){handler=new PreOrderCheckout(resp,self)}else if(resp.intent==="flexpay"){handler=new FlexpayCheckout(resp,self)}else{handler=new PaymentCheckout(resp,self)}handler.init();logger.info("Binding checkout events.");bindEvents();logger.info("Enabling finish order button, checkout ready.");checkoutStatus="ready";$("body").addClass("mbc-payment-ready");enableFinishOrderButton()}else{enableFinishOrderButton()}}).fail(function(){logger.error("Failed to validate current checkout session.")}).always(function(){enableFinishOrderButton()})}};if(typeof mbc.RecurringPayments==="undefined")mbc.RecurringPayments={};mbc.RecurringPayments.Checkout=Checkout})(window.jQuery,MINIBC)}
(function($,mbc){var FinishOrder=function(){var logger=new mbc.Log;logger.setAppName("recurring");logger.setVerbosity("info");var confirmOrder=function(checkoutId){var data={checkout_id:checkoutId};return mbc.request(data,"/apps/recurring/checkouts/order/confirmation","POST","json")};var showLoadingIndicator=function(){$(".loadingNotification").removeClass("ng-hide").addClass("ng-show")};var hideLoadingIndicator=function(){$(".loadingNotification").removeClass("ng-show").addClass("ng-hide")};this.init=function(){showLoadingIndicator();if(window.sessionStorage){var checkoutId=window.sessionStorage.getItem("MBC_CHECKOUT_ID");if(checkoutId){logger.info("checkout session found: "+checkoutId);logger.info("confirming order for session "+checkoutId);window.sessionStorage.removeItem("MBC_CHECKOUT_ID");confirmOrder(checkoutId).then(function(){logger.info("Order confirmed successfully.")},function(){logger.error("Failed to confirm order for checkout session.")}).always(function(){hideLoadingIndicator()})}else{hideLoadingIndicator()}}else{hideLoadingIndicator()}}};if(typeof mbc.SavedPayments==="undefined")mbc.SavedPayments={};mbc.SavedPayments.FinishOrder=FinishOrder})(window.jQuery,MINIBC);
if(typeof MINIBC!=="undefined"){(function($,mbc){if(typeof mbc.SavedPayments==="undefined")mbc.SavedPayments={};var Unsubscribe=function(){var message;var showMessage=function(wrapper,message){$(wrapper).html("<p>"+message+"</p>")};var parseQuery=function(queryString){var query={};var pairs=(queryString[0]==="?"?queryString.substr(1):queryString).split("&");for(var i=0;i<pairs.length;i++){var pair=pairs[i].split("=");query[decodeURIComponent(pair[0])]=decodeURIComponent(pair[1]||"")}return query};this.init=function(){var wrapper=$("#minibc-unsubscribe");var params=window.location.search;if(params.indexOf("unsub")<0){window.location.replace("/");return false}params=parseQuery(params);showMessage(wrapper,"Processing request, please wait...");mbc.request({data:params.unsub},"/apps/recurring/storefront/email/unsubscribe","POST","json").done(function(resp){if(resp.success){message="You have unsubscribed from any further email communications relating to your subscriptions."}else{message="An error occurred when we attempted to unsubscribe you from our email communications. Please contact us or try again later."}showMessage(wrapper,message)}).fail(function(){showMessage(wrapper,"An error occurred when we attempted to unsubscribe you from our email communications. Please contact us or try again later.")})}};mbc.SavedPayments.Unsubscribe=Unsubscribe})(window.jQuery,MINIBC)}
if(typeof MINIBC!=="undefined"){(function($,mbc){if(typeof mbc.RecurringPayments==="undefined")mbc.RecurringPayments={};mbc.RecurringPayments.Account=function(){var self=this;var loginInst;var countries=[];var defaultGateway;var timeZones={};var gatewayEncToken="";var gatewayData={};var paymentForms={};var allSubProducts=[];var loadDefaultCSS=function(){return MINIBC.request({stencil:true},"/apps/recurring/storefront/css","post","text").done(function(resp){var customCss=$('link[href*="custom.css"]');var defaultCss=$('<style type="text/css" />');defaultCss.html(resp);if(customCss.length>0){defaultCss.insertBefore(customCss)}else{$("head").append(defaultCss)}})};var showSubscriptions=function(loginInst){var data={customer_token:loginInst.token,id:loginInst.appId};var container=".account-listItem";MINIBC.request(data,"/apps/recurring/storefront/payments","post","json").pipe(function(data){defaultGateway=data.gateway;if(data.token){gatewayEncToken=data.token}});MINIBC.request(data,"/apps/recurring/storefront/subscriptions","post","json").pipe(function(data){return renderSubscriptionList(data.subscriptions)}).then(function(){bindSubscriptionListEvent(container)}).fail(function(){var content=$("<p>",{html:"An error occurred when attempting to retrieve your subscriptions. Please try again later."}).addClass("ErrorMessage");renderPage({heading:"Subscriptions",desc:"Your subscriptions are shown below. Click 'Update Payment Method' to update your payment method or 'Cancel' to cancel your subscription.",content:content},container)})};var bindSubscriptionListEvent=function(container){$(".subscription-edit-btn").on("click",function(e){e.preventDefault();var editDropdown=$(".account-listItem[data-subscription-id="+$(this).attr("data-id")+"] .account-orderButtons");if(editDropdown.css("display")=="none"){$(this).find("i").removeClass("up-caret").addClass("active-dropdown");editDropdown.show()}else{$(this).find("i").removeClass("down-caret active-dropdown").addClass("up-caret");editDropdown.hide()}});$(".cancel-subscription").on("click",function(e){e.preventDefault();showConfirmationModal($(this).attr("data-id"),"cancel")});$(".apply-coupon").on("click",function(e){e.preventDefault();showApplyCouponForm($(this).attr("data-id"))});$(".ship-now").on("click",function(e){e.preventDefault();showConfirmationModal($(this).attr("data-id"),"ship_now")});$(".sms-notifications").on("click",function(e){e.preventDefault();showSmsNotificationsForm($(this).attr("data-id"))});$(".edit-subscription").on("click",function(e){e.preventDefault();showSubscriptionUpdateForm($(this).attr("data-id"),this)});$(".edit-subscription-details").on("click",function(e){e.preventDefault();showSubscriptionDetailsUpdateForm($(this).attr("data-id"),this)});$(".skip-subscription").on("click",function(e){e.preventDefault();showSkipRecurrenceForm($(this).attr("data-id"))});$(".button-subscription--update_address").on("click",function(e){e.preventDefault();showShippingAddressUpdateForm($(this).attr("data-id"),this)});$(".button-subscription--renew").on("click",function(e){e.preventDefault();renewSubscription($(this).attr("data-id"))});$(".button-subscription--autorenew").on("click",function(e){e.preventDefault();toggleSubscriptionAutoRenew($(this).attr("data-id"),$(this).attr("data-autorenew-enabled")==="true")});$("body").on("submit",".payment-form.form--subscription",function(e){e.preventDefault();updateSubscription(this)}).on("submit",".payment-form.payment-form--coupon",function(e){e.preventDefault();applySubscriptionCoupon(this)}).on("submit",".payment-form.form--sms-notifications",function(e){e.preventDefault();$("#sms-legal-enforce").hide();if(!$("#sms-legal-confirmation").is(":checked")){$("#sms-legal-enforce").show()}else{updateSMSNotifications(this)}}).on("submit",".payment-form.form--subscription_address",function(e){e.preventDefault();updateSubscriptionShippingAddress(this)}).on("submit",".payment-form.form--ship-now",function(e){e.preventDefault();var id=$(this).attr("data-id");shipNowAndUpdateShipments(id)}).on("submit",".payment-form.form--subscription_details",function(e){e.preventDefault();updateSubscriptionDetails(this)}).on("submit",".payment-form.form--skip-recurrence",function(e){e.preventDefault();skipSubscription(this)}).on("submit",".payment-form.form--cancel-subscription",function(e){e.preventDefault();var id=$(this).attr("data-id");cancelSubscription(id)}).on("submit",".payment-form.form--unsubscribe-sms",function(e){e.preventDefault();var id=$(this).attr("data-id");unsubscribeSMS(id)}).on("click",".payment-form .button-cancel",function(e){e.preventDefault();hideSubscriptionUpdateForm();return false}).on("click",".payment-form .button-okay",function(e){e.preventDefault();window.location.reload()}).on("click",".payment-form .btns .button-sms-unsub",function(e){e.preventDefault();showConfirmationModal($(this).attr("data-id"),"sms_unsub")}).on("click",".payment-form .next-btn-section .button--primary",function(e){e.preventDefault();showSubscriptionDetailsConfirmation(this)}).on("click",".payment-form .subscription-confirm-button-back",function(e){e.preventDefault();$("#legal-enforce").hide();hideSubscriptionDetailsConfirmation(this)}).on("change",".payment-form #recurring-product",function(e){deselectFrequencySelect(this)}).on("change",".payment-form #recurring-frequency",function(e){deselectProductSelect(this)}).on("click",".recurring-frequency-input",function(e){$(this).removeClass("inactive-input");$(this).siblings(".recurring-product-input").addClass("inactive-input")}).on("click",".recurring-product-input",function(e){$(this).removeClass("inactive-input");$(this).siblings(".recurring-frequency-input").addClass("inactive-input")}).on("mouseover",".subscription-edit-btn",function(e){$(this).find("i").removeClass("up-caret").addClass("down-caret")}).on("mouseout",".subscription-edit-btn",function(e){if(!$(this).find("i").hasClass("active-dropdown")){$(this).find("i").removeClass("down-caret").addClass("up-caret")}});$(document).click(function(e){closeEditSubscriptionDropdowns(e.target)})};var closeEditSubscriptionDropdowns=function(eventTarget){var eventTarget=$(eventTarget);var editBtns=$(".subscription-edit-btn").not(eventTarget);$.each(editBtns,function(index,editBtn){var editDropdown=$(".account-listItem[data-subscription-id="+$(editBtn).attr("data-id")+"] .account-orderButtons");if(editDropdown.css("display")=="block"){$(editBtn).find("i").removeClass("down-caret active-dropdown").addClass("up-caret");editDropdown.hide()}})};var shipNowAndUpdateShipments=function(subscriptionId){var data={subscription_id:subscriptionId,customer_token:loginInst.token,id:loginInst.appId,update_recurrence:true};$(":submit").attr("disabled",true);$(".form--ship-now").find("h2").text("Processing your order please wait..");interval_=setInterval(function(){$(".form--ship-now").find("h2").fadeIn();$(".form--ship-now").find("h2").fadeOut()},500);MINIBC.request(data,"/apps/recurring/storefront/subscriptions/"+subscriptionId+"/renew","post","json").then(function(resp){$(":submit").attr("disabled",false);clearInterval(interval_);if(resp.success){showConfirmationResponse("ship_now_success")}else if(resp.message=="skipped"){showConfirmationResponse("out_of_stock_error")}else if(resp.type=="ship_now_already_paid"){showConfirmationResponse(resp.type)}else{showConfirmationResponse("ship_now_error")}}).fail(function(){showConfirmationResponse("ship_now_error");clearInterval(interval_)})};var renderSubscriptionList=function(subscriptions){var rendered=$.Deferred();if(subscriptions.length<=0){var content=$("<p>",{html:"There are no subscriptions currently associated with your account. Please check back later or contact us if you believe there is an error with your account."}).addClass("InfoMessage");rendered.resolve(content);return rendered.promise()}var list=$("<ul />").addClass("account-list subs-list");var subProducts=subscriptions[0].subscriptionProducts;allSubProducts=subProducts;for(var i=0;i<subscriptions.length;i++){var item=renderSubscriptionItem(subscriptions[i]);item.appendTo(list)}list.css("display","none").insertAfter(".account-list");rendered.resolve(list);return rendered.promise()};var renderSubscriptionItem=function(subscription){var table=$('<table border="1" class="subscription-item"/>');var tHead=$("<thead> <tr> <td /> </tr> </thead>");var tBody=$("<tbody />");var item=$('<li class="account-listItem" />');var productWrapper=$('<div class="account-product" />');var bodyWrapper=$('<div class="account-product-body" />');var statusContainer=$('<div class="account-orderStatus" />');var btnWrapper=$('<div class="account-orderButtons" />');var statusDiv=$('<h6 class="account-orderStatus-label" />');item.attr("data-subscription-id",subscription.id).data("subscription",subscription).css("border-bottom","none");if(subscription.active){var editBtn=$('<a href="#">Edit <i class="up-caret"></i></a>');editBtn.attr("data-id",subscription.id).addClass("subscription-edit-btn");var skipBtn=$('<a href="#">Skip Shipments</a>');skipBtn.attr("data-id",subscription.id).addClass("skip-subscription");var cancelBtn=$('<a href="#">Cancel Subscription</a>');cancelBtn.attr("data-id",subscription.id).addClass("cancel-subscription");var couponBtn=$('<a href="#">Apply Coupon</a>');couponBtn.attr("data-id",subscription.id).addClass("apply-coupon");var shipNowBtn=$('<a href="#">Ship Now</a>');shipNowBtn.attr("data-id",subscription.id).addClass("ship-now");var smsBtn=$('<a href="#">SMS Reminders</a>');smsBtn.attr("data-id",subscription.id).addClass("sms-notifications");var editSubBtn=$('<a href="#">Edit Frequency or Renew Date</a>');editSubBtn.attr("data-id",subscription.id).addClass("edit-subscription-details");if(typeof subscription.card!=="undefined"&&subscription.card!==""){var editPaymentBtn=$('<a href="#">Update Payment Method</a>');editPaymentBtn.attr("data-id",subscription.id).addClass("edit-subscription");btnWrapper.append(editPaymentBtn)}var shippingBtn=$('<a href="#">Update Shipping Address</a>');shippingBtn.attr("data-id",subscription.id).addClass("button-subscription--update_address").appendTo(btnWrapper);statusDiv.text("Active");if(subscription.subscriptionType==="membership"){if(subscription.configAutoRenew){var btnText=subscription.autoRenew?"Disable Auto Renew":"Enable Auto Renew";$('<a href="#">'+btnText+"</a>").attr("data-id",subscription.id).attr("data-autorenew-enabled",subscription.autoRenew?"false":"true").addClass("button-subscription--autorenew").appendTo(btnWrapper)}$('<a href="#">Renew Now</a>').attr("data-id",subscription.id).addClass("FloatRight renew-subscription button-subscription--renew").appendTo(btnWrapper)}btnWrapper.append(editSubBtn).append(shipNowBtn).append(skipBtn).append(cancelBtn).appendTo(productWrapper);if(getDateDifference(subscription.nextPayment,subscription.frequency)<=1){}}else{statusDiv.text("Inactive").addClass("status-cancelled");item.addClass("cancelled")}var status=$("<tr> <td> <span></span> </td> </tr>");status.find("span").html("<b>Status:</b> ").append(statusDiv);var label=$('<h5 class="account-product-title" />');label.html("Subscription #"+subscription.id).appendTo(bodyWrapper);if(typeof editBtn!=="undefined")label.append(editBtn);tHead.find("td").append(label);var desc=subscription.subscriptionType==="membership"?"1 product totaling $${total}/ per ${term} ($${price}/${unit})":"1 product totaling $${price}/${unit}";desc=desc.replace("${price}",subscription.total).replace("${unit}",subscription.frequency.toLowerCase()).replace("${total}",subscription.termTotal).replace("/"," every ");if(subscription.term){desc=desc.replace("${term}",subscription.term.toLowerCase())}else{desc=desc.replace("${term}","")}var summary=$("<tr> <td></td> </tr>");$('<span class="account-product-description" />').html("<b>Summary:</b> "+desc).appendTo(summary.find("td"));var productContainer=$('<div class="account-products" />');$("<span />").html("<b>Contents:</b> "+subscription.product).appendTo(productContainer);var contents=$("<tr> <td></td> </tr>");productContainer.appendTo(contents.find("td"));var details=$('<div class="account-product-details" />');function createDetailDiv(content){var container=$('<div class="account-payment-detail" />');container.html(content);return container}var paymentMethodIcon="";if(subscription.card_type!==null){switch(subscription.card_type.toLowerCase()){case"visa":paymentMethodIcon="fa-cc-visa";break;case"mastercard":paymentMethodIcon="fa-cc-mastercard";break;case"american express":paymentMethodIcon="fa-cc-amex";break}}var paymentMethod=$("<tr> <td></td> </tr>");if(typeof subscription.card!=="undefined"&&subscription.card!==""){createDetailDiv('<span class="payment-method"><b>Payment Method:</b> '+'<i class="fab '+paymentMethodIcon+' fa-lg payment-method-icon"></i>'+'<span class="card-num">'+subscription.card.substr(-4)+'</span><span class="card-exp">'+subscription.expiry+"</span></span>").appendTo(paymentMethod.find("td"))}else if(typeof subscription.bank!=="undefined"){createDetailDiv('<span class="payment-method"><b>Payment Method:</b> <span class="bank-num">Bank Account '+subscription.bank+"</span></span>").appendTo(paymentMethod.find("td"))}var nextPayment=$("<tr> <td></td> </tr>");if(subscription.subscriptionType==="membership"&&subscription.autoRenew===false){createDetailDiv('<span class="membership-period"><b>Active Until:</b> '+subscription.nextPayment+"</span>").appendTo(nextPayment.find("td"))}else{createDetailDiv('<span class="membership-period"><b>Renewal/Shipment:</b> '+subscription.nextPayment+"</span>").appendTo(nextPayment.find("td"))}bodyWrapper.css("overflow","visible").append(btnWrapper);productWrapper.append(bodyWrapper);tBody.append(status).append(summary).append(contents);if(paymentMethod.find("td").html()!="")tBody.append(paymentMethod);tBody.append(nextPayment);table.append(tHead).append(tBody);productWrapper.append(table);productWrapper.appendTo(item);return item};var getDateDifference=function(date,frequency){var date2=new Date;var date1=new Date(date);var recurringDate=new Date;var timeDiff=date1.getTime()-date2.getTime();var hourDifference=Math.ceil(timeDiff/(1e3*3600*24));var frequencyHour=0;switch(frequency){case"7 Days":recurringDate.setDate(recurringDate.getDate()+7);break;case"14 Days":recurringDate.setDate(recurringDate.getDate()+14);break;case"Month":case"30 Days":recurringDate.setMonth(recurringDate.getMonth()+1);break;case"2 Months":case"60 Days":recurringDate.setMonth(recurringDate.getMonth()+2);break;case"90 Days":recurringDate.setMonth(recurringDate.getMonth()+3);break}var rcTimeDiff=recurringDate.getTime()-date2.getTime();var rcHourDifference=Math.ceil(rcTimeDiff/(1e3*3600*24));return rcHourDifference-hourDifference};var checkCouponExist=function(id){var data={};MINIBC.request(data,"/apps/recurring/storefront/discount/"+id,"post","json").then(function(resp){if(resp.success){$(".account-listItem[data-subscription-id="+id+"]").find(".account-product-description").append(" ($"+resp.discount+" off) ").append('<span class="coupon-description"> Applied coupon code <span style="color:#80bc00">'+resp.coupon+"</span></span>");return}});return false};var renewSubscription=function(subscriptionId){var item=$("[data-subscription-id="+subscriptionId+"]");var subscription=item.data("subscription");var confirmMessage="You are about to renew your membership for ${term} at ${price}/${unit}. Continue?".replace("${term}","1 "+subscription.term.toLowerCase()).replace("${price}","$"+subscription.total).replace("${unit}",subscription.frequency_unit);if(!confirm(confirmMessage)){return false}var data={subscription_id:subscriptionId,customer_token:loginInst.token,id:loginInst.appId,update_recurrence:true};MINIBC.request(data,"/apps/recurring/storefront/subscriptions/"+subscriptionId+"/renew","post","json").then(function(resp){if(resp.success){$(".membership-period",item).text(resp.nextPayment);subscription.nextPayment=resp.nextPayment;item.data("subscription",subscription);alert("Your subscription has been successfully renewed.")}else{var message=resp.error?resp.error:"An error occurred when we attempted to renew your subscription.";alert(message)}}).fail(function(){alert("An error occurred when we attempted to renew your subscription.")})};var skipSubscription=function(form){form=$(form);var skipAmount=form.find("#skip-spinner").val();var subscriptionId=form.find("[name=identifier]").val();var data={subscription_id:subscriptionId,customer_token:loginInst.token,id:loginInst.appId,number_of_skips:skipAmount};MINIBC.request(data,"/apps/recurring/storefront/subscriptions/"+subscriptionId+"/skip","post","json").then(function(resp){if(resp.success){showConfirmationResponse("skip_success")}else{showConfirmationResponse("skip_error")}}).fail(function(){showConfirmationResponse("skip_error")})};var toggleSubscriptionAutoRenew=function(subscriptionId,enableRenew){var data={subscription_id:subscriptionId,autoRenew:enableRenew,customer_token:loginInst.token,id:loginInst.appId};MINIBC.request(data,"/apps/recurring/storefront/subscriptions/"+subscriptionId,"post","json").then(function(resp){var message=enableRenew?"Automatic renewal has been activated for your subscription.":"Automatic renewal has been deactivated for your subscription.";alert(message);window.location.reload()}).fail(function(){alert("{{ update_subscription_error }}")})};var updateSubscription=function(form,metadata){form=$(form);metadata=metadata||{};if(!validatePaymentForm(form)){return false}var subscriptionId=form.find("[name=identifier]").val();var data={subscription_id:subscriptionId,metadata:metadata,customer:self.sessionCookie,customer_token:loginInst.token,id:loginInst.appId,address:{address1:form.find("[name=address1]").val(),address2:form.find("[name=address2]").val(),city:form.find("[name=city]").val(),state:form.find("[name=state]").val(),country:form.find("[name=country]").val(),phone:form.find("[name=phone]").val(),zip:form.find("[name=zip]").val(),first_name:form.find("[name=firstName]").val(),last_name:form.find("[name=lastName]").val()}};if($("[name=payment_select]:checked").val()==="existing"){data.profile={method_id:$("[name=method_id]").val()}}else{var ccNum=form.find("[name=cc_num]");var ccExpMonth=form.find("[name=cc_expm]");var ccExpYear=form.find("[name=cc_expy]");var ccCode=form.find("[name=cc_cvv]");data.cc_number=ccNum.val();data.cc_exp_month=ccExpMonth.val();data.cc_exp_year=ccExpYear.val();data.cc_cvv=ccCode.val()}form.find(".btns").children().attr("disabled","disabled");form.find("input[type=submit]").val("Saving");tokenizePayment(form).pipe(function(token){if(token&&token!==""){data.profile={nonce:token};if(defaultGateway==="square"){if(gatewayData.square.cardData){data.profile.last4=gatewayData.square.cardData.last_4;data.profile.exp_m=gatewayData.square.cardData.exp_month.toString();data.profile.exp_y=gatewayData.square.cardData.exp_year;if(gatewayData.square.cardData.exp_month<10){data.profile.exp_m="0"+data.profile.exp_m}if(gatewayData.square.postalCode!==""){data.address.zip=gatewayData.square.postalCode}}}else if(defaultGateway==="ewayrapid"){data.profile.exp_m=ccExpMonth.val();data.profile.exp_y=ccExpYear.val();if(typeof eCrypt!=="undefined"){data.profile.code=eCrypt.encryptValue(ccCode.val(),gatewayEncToken)}}else{data.profile.exp_m=ccExpMonth.val();data.profile.exp_y=ccExpYear.val();if(data.cc_number){data.profile.last4=data.cc_number.substr(-4,4)}}delete data.cc_number;delete data.cc_cvv}MINIBC.request(data,"/apps/recurring/storefront/subscriptions/"+subscriptionId,"post","json").then(function(resp){if(resp.action==="authorization"){if(defaultGateway==="stripe"&&Stripe.version===3){var stripe=gatewayData.stripe.client;var cardElement=gatewayData.stripe.card;var actionData=resp.data;var intentData;if(typeof actionData.token!=="undefined"){intentData={payment_method:actionData.token}}else{intentData={payment_method:{card:cardElement,billing_details:actionData.billing_details}}}stripe.confirmCardSetup(actionData.secret,intentData).then(function(confirmResp){if(confirmResp.setupIntent){updateSubscription(form,confirmResp)}else if(confirmResp.error){showConfirmationResponse("subscriptions_update_error");form.find(".btns").children().removeAttr("disabled");form.find("input[type=submit]").val("Save")}else{form.find(".btns").children().removeAttr("disabled");form.find("input[type=submit]").val("Save")}},function(){showConfirmationResponse("subscriptions_update_error");form.find(".btns").children().removeAttr("disabled");form.find("input[type=submit]").val("Save")})}}else{showConfirmationResponse("subscriptions_update_success");var wrapper=$("[data-subscription-id="+subscriptionId+"] .payment-method");wrapper.children(".card-num").html(resp.card);wrapper.children(".card-exp").html(resp.expiry);removeOverlay()}}).fail(function(){showConfirmationResponse("subscriptionss_update_error");form.find(".btns").children().removeAttr("disabled");form.find("input[type=submit]").val("Save")})}).fail(function(){alert("Failed to update card");removeOverlay()})};var updateSubscriptionDetails=function(form){form=$(form);form.find(".btns").children().attr("disabled","disabled");form.find("input[type=submit]").val("Saving");var subscriptionId=form.find("[name=identifier]").val();var recurringDate=form.find("#recurring-date").datepicker("getDate");var formattedRecurringDate="";if(recurringDate!=null)formattedRecurringDate=$.datepicker.formatDate("yy-mm-dd",recurringDate);var data={customer_token:loginInst.token,id:loginInst.appId,subscription_id:subscriptionId,frequency_product_id:form.find("#recurring-frequency").val(),recurring_date:formattedRecurringDate,product_id:form.find("#recurring-product").val()};MINIBC.request(data,"/apps/recurring/storefront/subscriptions/"+subscriptionId+"/details","post","json").then(function(resp){showConfirmationResponse("subscriptions_update_success")}).fail(function(){showConfirmationResponse("subscriptions_update_error");form.find(".btns").children().removeAttr("disabled");form.find("input[type=submit]").val("Save")})};var applySubscriptionCoupon=function(form){form=$(form);if(!validatePaymentForm(form)){return false}var coupon_code=form.find("[name=coupon]").val();var subscriptionId=form.find("[name=identifier]").val();var data={subscription_id:subscriptionId,coupon_code:coupon_code};form.find(".btns").children().attr("disabled","disabled");form.find("input[type=submit]").val("Saving");MINIBC.request(data,"/apps/recurring/storefront/coupons","post","json").then(function(resp){removeOverlay();showConfirmationResponse("coupon_success")}).fail(function(){showConfirmationResponse("coupon_error");form.find(".btns").children().removeAttr("disabled");form.find("input[type=submit]").val("Save")})};var updateSubscriptionShippingAddress=function(form){form=$(form);var subscriptionId=form.find("[name=identifier]").val();var data={customer_token:loginInst.token,id:loginInst.appId,subscription_id:subscriptionId,address:{street_1:form.find("[name=address1]").val(),street_2:form.find("[name=address2]").val(),city:form.find("[name=city]").val(),state:form.find("[name=state]").val(),country:form.find("[name=country]").val(),phone:form.find("[name=phone]").val(),zip:form.find("[name=zip]").val(),first_name:form.find("[name=firstName]").val(),last_name:form.find("[name=lastName]").val()}};form.find(".btns").children().attr("disabled","disabled");form.find("input[type=submit]").val("Saving");MINIBC.request(data,"/apps/recurring/storefront/subscriptions/"+subscriptionId+"/shipping","post","json").then(function(resp){showConfirmationResponse("shipping_address_update_success");var wrapper=$("[data-subscription-id="+subscriptionId+"] .payment-method");wrapper.children(".card-num").html(resp.card);wrapper.children(".card-exp").html(resp.expiry)}).fail(function(){showConfirmationResponse("shipping_address_update_error");form.find(".btns").children().removeAttr("disabled");form.find("input[type=submit]").val("Save")})};var updateSMSNotifications=function(form){form=$(form);var phone=form.find("[name=phone]").val();var selectedTimeZone=form.find("[name=time_zone]").val();var subscriptionId=form.find("[name=identifier]").val();phone=phone.replace(/[+ ()-]/g,"");$("#sms-notifications-form input").removeClass("field-error");if(isNaN(phone)||phone.length>13){$("#sms-phone-number").addClass("field-error");return}if(!selectedTimeZone){$("#sms-time-zones").addClass("field-error");return}var data={subscription_id:subscriptionId,customer_token:loginInst.token,id:loginInst.appId,phone:phone,time_zone:selectedTimeZone};form.find(".btns").children().attr("disabled","disabled");form.find("input[type=submit]").val("Saving");MINIBC.request(data,"/apps/recurring/storefront/"+subscriptionId+"/sms","post","json").then(function(resp){removeOverlay();showConfirmationResponse("sms_success")}).fail(function(){showConfirmationResponse("sms_error");form.find(".btns").children().removeAttr("disabled");form.find("input[type=submit]").val("Save")})};var unsubscribeSMS=function(subscriptionId){var data={subscription_id:subscriptionId,customer_token:loginInst.token,id:loginInst.appId};MINIBC.request(data,"/apps/recurring/storefront/"+subscriptionId+"/sms/unsubscribe","post","json").then(function(resp){removeOverlay();showConfirmationResponse("sms_unsub_success")}).fail(function(){showConfirmationResponse("sms_unsub_error")})};var cancelSubscription=function(subscriptionId){var data={subscription_id:subscriptionId,customer_token:loginInst.token,id:loginInst.appId};var url="/apps/recurring/storefront/subscriptions/"+subscriptionId+"/cancel";MINIBC.request(data,url,"post","json").done(function(resp){showConfirmationResponse("cancel_success");var item=$(".cancel-subscription[data-id="+subscriptionId+"]").parents(".account-listItem");item.addClass("cancelled");$(".account-orderStatus-label",item).html("Cancelled");$(".account-orderButtons",item).remove()}).fail(function(){showConfirmationResponse("cancel_error")})};var showSkipRecurrenceForm=function(id){var form=buildUpdateForm(id,"skip_recurrence");var text="Skip Recurrences for Subscription No. ${id}".replace("${id}",id).replace("Recurrences","Shipments");$("form",form).addClass("form--skip-recurrence").prepend($("<h2 />",{html:text}));form.find("input[type=submit]").attr("data-id",id);var spinner=form.find("#skip-spinner");spinner.spinner({min:1,max:5});spinner.spinner("value",1);form.appendTo("body")};var showApplyCouponForm=function(subscriptionId){var form=buildUpdateForm(subscriptionId,"apply_coupon");var text="Apply Coupon for Subscription No. ${id}".replace("${id}",subscriptionId);$("form",form).prepend($("<h2 />",{html:text}));form.appendTo("body")};var showSmsNotificationsForm=function(subscriptionId){var form=buildUpdateForm(subscriptionId,"sms_notifications");var item=$("[data-subscription-id="+subscriptionId+"]");var subscription=item.data("subscription");var text="SMS Reminders";$("form",form).addClass("form--sms-notifications").prepend($("<h2 />",{html:text}));var legalText="Legal and carrier agreement Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat."+"Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.";if(typeof subscription.smsPhone!=="undefined"){form.find("#sms-phone-number").val(subscription.smsPhone);form.find("input[type=submit]").val("Update");form.find(".button-sms-unsub").attr("data-id",subscriptionId).show()}timeZoneSelect=form.find("#sms-time-zones");for(var timeZone in timeZones){var opt=$("<option/>");opt.val(timeZone).text(timeZones[timeZone]);if(typeof subscription.smsTimeZone!=="undefined"&&subscription.smsTimeZone==timeZone)opt.attr("selected","selected");opt.appendTo(timeZoneSelect)}var optGroup=$('<optgroup label="" style="display:none;"></optgroup>');optGroup.appendTo(timeZoneSelect);form.appendTo("body")};var showSubscriptionUpdateForm=function(subscriptionId,element){var form=buildUpdateForm(subscriptionId,"credit_card");var text="Update Payment Method for Subscription No. ${id}".replace("${id}",subscriptionId);$("form",form).addClass("form--subscription").prepend($("<h2 />",{html:text}));form.appendTo("body")};var showShippingAddressUpdateForm=function(subscriptionId,element){var form=buildUpdateForm(subscriptionId,"address");var text="Update Shipping Address for Subscription No. ${id}".replace("${id}",subscriptionId);$("form",form).addClass("form--subscription_address").prepend($("<h2 />",{html:text}));form.appendTo("body")};var showSubscriptionDetailsUpdateForm=function(subscriptionId,element){var form=buildUpdateForm(subscriptionId,"subscription_details");var item=$("[data-subscription-id="+subscriptionId+"]");var subscription=item.data("subscription");var frequencySelect=form.find("#recurring-frequency");var text="Update details for Subscription No. ${id}".replace("${id}",subscriptionId);$("form",form).addClass("form--subscription_details").prepend($("<h2 />",{html:text}));form.find(".next-btn-section").attr("data-id",subscriptionId);var deselectOpt=$("<option disabled value></option>");deselectOpt.appendTo(frequencySelect);var subscriptionFrequency=subscription.frequency;subscriptionFrequency=getFrequencyText(subscriptionFrequency);var defaultOpt=$('<option selected="selected" />');defaultOpt.val(subscription.rcProductId).text(subscriptionFrequency).appendTo(frequencySelect);var relatedProducts=subscription.relatedProducts;if(Object.keys(relatedProducts).length!==0){for(var id in relatedProducts){relatedProducts[id]=getFrequencyText(relatedProducts[id]);var opt=$("<option/>");opt.val(id).text(relatedProducts[id]).appendTo(frequencySelect)}}var productsSelect=form.find("#recurring-product");var defaultOpt=$("<option disabled selected value> -- Change Product -- </option>");defaultOpt.appendTo(productsSelect);for(var id in allSubProducts){allSubProducts[id]["name"]=allSubProducts[id]["name"].replace("&reg;","®");allSubProducts[id]["frequency"]=getFrequencyText(allSubProducts[id]["frequency"]);var opt=$("<option/>");opt.val(id).text(allSubProducts[id]["name"]+" ($"+allSubProducts[id]["price"]+" / "+allSubProducts[id]["frequency"]+")").attr("data-frequency",allSubProducts[id]["frequency"]).attr("data-price",allSubProducts[id]["price"]).attr("data-name",allSubProducts[id]["name"]).appendTo(productsSelect)}form.find("#recurring-date").datepicker({dateFormat:"M dd, yy",minDate:1,maxDate:"+"+subscription.frequencyShort}).datepicker("setDate",new Date(subscription.nextPayment));$(".ui-datepicker").css("font-size","16px");form.appendTo("body")};var showSubscriptionDetailsConfirmation=function(btn){form=$(btn).closest(".payment-form");form.find("h2").text("Please confirm the details of your subscription below:");var subscriptionId=form.find(".next-btn-section").attr("data-id");var item=$("[data-subscription-id="+subscriptionId+"]");var subscription=item.data("subscription");var subscriptionTotal=subscription.total;var newTotal=form.find("#recurring-product option:selected").attr("data-price");var selectedFrequency=form.find("#recurring-frequency option:selected").text();var selectedDate=form.find("#recurring-date").val();var selectedProduct=form.find("#recurring-product").val();if(!selectedProduct||selectedProduct==""){form.find(".subscription-confirm-frequency").siblings(".subscription-confirm-heading").show();form.find(".subscription-confirm-product").siblings(".subscription-confirm-heading").hide();form.find(".subscription-confirm-product").hide();form.find(".subscription-confirm-price").siblings(".subscription-confirm-heading").hide();form.find(".subscription-confirm-price").hide()}else{selectedFrequency=form.find("#recurring-product option:selected").attr("data-frequency");if(selectedFrequency!=""){form.find(".subscription-confirm-frequency").siblings(".subscription-confirm-heading").show()}else{form.find(".subscription-confirm-frequency").siblings(".subscription-confirm-heading").hide()}selectedProduct=form.find("#recurring-product option:selected").attr("data-name");form.find(".subscription-confirm-product").siblings(".subscription-confirm-heading").show();form.find(".subscription-confirm-product").show();form.find(".subscription-confirm-price").siblings(".subscription-confirm-heading").show();form.find(".subscription-confirm-price").show()}form.find(".subscription-confirm-frequency").text(selectedFrequency);form.find(".subscription-confirm-product").text(selectedProduct);form.find(".subscription-confirm-date").text(selectedDate);form.find(".subscription-confirm-price .subscription-confirm-price-before").text("$"+subscriptionTotal);form.find(".subscription-confirm-price .subscription-confirm-price-after").text("$"+newTotal);form.find(".payment-section").hide();form.find(".next-btn-section").hide();form.find(".subscription-details-confirmation").show();form.find(".subscription-confirm-button-back").show();form.find(".submit-btn-section").show()};var hideSubscriptionDetailsConfirmation=function(btn){form=$(btn).closest(".payment-form");var subscriptionId=form.find(".next-btn-section").attr("data-id");form.find("h2").text("Update details for Subscription No. "+subscriptionId);form.find(".subscription-details-confirmation").hide();form.find(".subscription-confirm-button-back").hide();form.find(".subscription-details-legals").hide();form.find(".submit-btn-section").hide();form.find(".payment-section").show();form.find(".next-btn-section").show()};var deselectFrequencySelect=function(btn){var frequencySelect=$("#recurring-frequency");frequencySelect.prop("selectedIndex",0)};var deselectProductSelect=function(btn){var productSelect=$("#recurring-product");productSelect.prop("selectedIndex",0)};var showConfirmationModal=function(id,type){removeOverlay();var form=buildUpdateForm(id,"confirm");switch(type){case"ship_now":form.find("form").addClass("form--ship-now").attr("data-id",id);var text="Process next shipment for Subscription No. ${id} immediately?".replace("${id}",id);$("form",form).prepend($("<h2 />",{html:text}));form.appendTo("body");break;case"skip":form.find("form").addClass("form--skip-recurrence").attr("data-id",id);var text="You are about to skip the next subscription recurrence for Subscription No. ${id}. Are you sure?".replace("${id}",id);$("form",form).prepend($("<h2 />",{html:text}));form.appendTo("body");break;case"cancel":form.find("form").addClass("form--cancel-subscription").attr("data-id",id);var text="You are about to cancel your subscription. Are you sure?".replace("${id}",id);$("form",form).prepend($("<h2 />",{html:text}));form.appendTo("body");break;break;case"sms_unsub":form.find("form").addClass("form--unsubscribe-sms").attr("data-id",id);var text="You are about to unsubscribe from SMS notifications for subscription No. ${id}. Are you sure?".replace("${id}",id);$("form",form).prepend($("<h2 />",{html:text}));form.appendTo("body");break}};var showConfirmationResponse=function(type){removeOverlay();var form=buildUpdateForm(false,"confirm_response");text="Success";switch(type){case"coupon_success":text="Your coupon was applied successfully.";break;case"coupon_error":text="Your coupon could not be applied.";break;case"cancel_success":text="Your subscription was cancelled successfully.";break;case"cancel_error":text="Something went wrong when trying to cancel your subscription. Please try again later.";break;case"ship_now_success":text="Your Ship Now request has been processed successfully. A new order has been created and your credit card has been charged.";break;case"ship_now_error":text="Your Ship Now payment was declined. Please update your credit card information and try again. No order has been created.";break;case"skip_success":text="Your next shipment(s) has been successfully skipped.";break;case"ship_now_already_paid":text="Order has already been processed earlier today, to prevent duplicate order creation";break;case"skip_error":text="An error occurred when we attempted to skip your upcoming subscription.";break;case"subscriptions_update_success":text="Your subscription was updated successfully";break;case"subscriptions_update_error":text="An error occurred while trying to update your subscription. Please try again later.";break;case"shipping_address_update_success":text="Your shipping address was updated successfully.";break;case"shipping_address_update_error":text="Something went wrong when trying to change your shipping address. Please try again later.";break;case"sms_success":text="Your SMS settings have been successfully saved.";break;case"sms_error":text="An error occurred when we attempted to save your SMS settings.";break;case"sms_unsub_success":text="You have successfully unsubscribed from SMS notifications.";break;case"sms_unsub_error":text="An error occurred when trying to unsubscribe you from SMS notifications.";break;case"out_of_stock_error":text="Sorry, the product you are trying to renew is out of stock. Please try again later.";break;case"payment_method_update_error":text="Something went wrong when trying to update your payment method. Please try again later.";break;case"payment_method_create_error":text="Something went wrong when trying to create your payment method. Please try again later.";break;case"payment_method_update_success":text="Your Payment Method have been successfully saved.";break}$("form",form).prepend($("<h2 />",{html:text}));form.appendTo("body")};var showCreditCardResponse=function(message){removeOverlay();var form=buildUpdateForm(false,"confirm_response");text=message;$("form",form).prepend($("<h2 />",{html:text}));form.appendTo("body")};var getFrequencyText=function(frequency){switch(frequency){case"7 Days":frequency="Ship every week";break;case"14 Days":case"Biweekly":frequency="Ship every 2 weeks";break;case"21 Days":frequency="Ship every 3 weeks";break;case"Month":case"28 Days":case"29 Days":case"30 Days":case"Monthly":frequency="Ship every 4 weeks";break;case"35 Days":frequency="Ship every 5 weeks";break;case"42 Days":frequency="Ship every 6 weeks";break;case"49 Days":frequency="Ship every 7 weeks";break;case"56 Days":frequency="Ship every 8 weeks";break;default:var frequencySplit=frequency.split(" ");if(frequencySplit[1]=="Days"&&parseInt(frequencySplit[0])%7==0){frequency="Ship every "+Math.floor(parseInt(frequencySplit[0])/7)+" weeks"}}return frequency};var hideSubscriptionUpdateForm=function(){removeOverlay()};var buildUpdateForm=function(identifier,type){var html=$(paymentForms[type].html);var form=html.is("form")?html:$("form",html);type=type||"credit_card";if(type==="credit_card"){var year=(new Date).getFullYear();var yearSelect=$("[name=cc_expy]",form);for(var y=0;y<10;y++){var yearVal=year+y;yearSelect.append('<option value="'+yearVal+'">'+yearVal+"</option>")}}var countrySelect=$("[name=country]",form);$("<option />",{value:"",html:"Choose a Country"}).appendTo(countrySelect);$(countries).each(function(i,countryName){$("<option />",{value:countryName,html:countryName}).appendTo(countrySelect)});if(identifier){form.append('<input type="hidden" name="identifier" value="'+identifier+'" />')}var wrapper=$('<div id="payment-form-overlay" />');wrapper.append(html);return wrapper};var updateFormStateField=function(resp,form){var input=$("[name=state]",form);var isTextInput=input.is("[type=text]");if(resp.data.states.length>0){if(isTextInput){$("<select />",{name:"state",id:"payment-state"}).addClass("form-select").insertAfter(input);input.attr("name","_state").hide()}var select=$("[name=state]",form).html("");$("<option />",{value:"",html:resp.data.prefix}).appendTo(select);$.each(resp.data.states,function(i,state){$("<option />",{value:state.id,html:state.name}).appendTo(select)})}else{if(!isTextInput){input.remove();$("[name=_state]").attr("name","state").show()}}};var showPaymentMethods=function(loginInst){var data={customer_token:loginInst.token,id:loginInst.appId};var container=".account-payment-methods";MINIBC.request(data,"/apps/recurring/storefront/payments","post","json").pipe(function(data){defaultGateway=data.gateway;if(data.token){gatewayEncToken=data.token}return renderPaymentMethodList(data.profiles)}).then(function(){bindPaymentMethodListEvent(container)}).fail(function(){var content=$("<p>",{html:"An error occurred when attempting to retrieve your saved payment methods. Please try again later"}).addClass("ErrorMessage");renderPage({heading:"Payment Methods",desc:"Your saved payment methods are shown below. Click 'Update' to update your payment information",content:content},container)})};var renderPage=function(data,container){var rendered=$.Deferred();var pageTitle=$("<h2 />");pageTitle.html(data.heading);var infoMessage=$('<div class="InfoMessage" />');infoMessage.text(data.desc);var contentWrapper=$('<div class="BlockContent" />');$("<div />").append(pageTitle).append(infoMessage).append(data.content).appendTo(contentWrapper);$(container).append(contentWrapper);rendered.resolve();return rendered.promise()};var renderProfileBox=function(title,content){return'<li class="address">'+'<div class="panel panel--address">'+'<div class="panel-body">'+'<h5 class="address-title">'+title+"</h5>"+'<div class="address-details">'+content+"</div>"+"</div>"+"</div>"+"</li>"};var renderCreditCardProfile=function(profile){var cardNumber=$("<span>",{html:"**** **** **** "+profile.last4}).addClass("cc-num");var expm=$("<span>",{html:profile.expm}).addClass("cc-expm");var expy=$("<span>",{html:profile.expy}).addClass("cc-expy");var expiry=$("<span>").addClass("cc-expiry").append(expm).append("/").append(expy);var item=$(renderProfileBox(profile.type,"")).attr("data-profile-type","credit_card");$("<div>").addClass("cc-info").append(cardNumber).append(expiry).appendTo($(".address-details",item));$("<button>",{html:"Edit"}).addClass("button button--primary button--small edit-btn").attr("data-id",profile.id).appendTo($(".address-details",item));if(profile.enableDelete){$("<button>",{html:"Delete"}).addClass("button button--small delete-btn").attr("data-id",profile.id).appendTo($(".address-details",item))}return item};var renderBankAccountProfile=function(profile){var bankName=$("<span>",{html:profile.bank_name}).addClass("bank-name");var routingNumber=$("<span>",{html:"****"+profile.routing_last4}).addClass("bank-routing");var accountNumber=$("<span>",{html:"****"+profile.account_last4}).addClass("bank-account");var bankNumber=$("<span>").addClass("bank-number").append(routingNumber).append(accountNumber);var item=$(renderProfileBox("Bank Account","")).attr("data-profile-type","bank_account");$("<div>").addClass("bank-info").append(bankName).append(bankNumber).appendTo($(".address-details",item));if(profile.enableDelete){$("<button>",{html:"Delete"}).addClass("button button--small delete-btn").attr("data-id",profile.id).appendTo($(".address-details",item))}return item};var renderPaymentMethodList=function(profiles){var rendered=$.Deferred();var form=$("[data-edit-account-form]");var container=$('<div class="account-payment-methods" />').css("display","none");var item,list=$('<ul class="addressList" />');if(profiles.length>0){for(var i=0;i<profiles.length;i++){var profile=profiles[i];if(typeof profile.last4!=="undefined"){item=renderCreditCardProfile(profile)}else{item=renderBankAccountProfile(profile)}$(item).appendTo(list)}}var newBtn='<li class="address">'+'<a class="panel panel--address panel--newAddress new-btn" href="#">'+'<span class="panel-body">'+'<span class="address-addNew">'+'<span class="address-symbol">+</span>'+'<h5 class="address-title">New Payment</h5>'+"</span>"+"</span>"+"</a>"+"</li>";$(newBtn).appendTo(list);container.append(list).insertAfter(form);rendered.resolve(list);return rendered.promise()};var showPaymentUpdateForm=function(paymentId,element){var item=$(element).parents(".address");var list=item.parent("ul");var type=item.attr("data-profile-type");if(!type){type="credit_card"}var form=buildUpdateForm(paymentId,type);$("form",form).prepend($("<h2 />",{html:"Update Payment Method"})).addClass("form--payment");list.addClass("editing");item.addClass("active");form.appendTo("body");initPaymentForm(form)};var hidePaymentUpdateForm=function(){var list=$(".account-payment-methods");list=list["selector"];removeOverlay();$(".account-item",list).removeClass("active");$(list).removeClass("editing")};var showCreatePaymentForm=function(){var form=buildUpdateForm(false,"credit_card");$("form",form).prepend($("<h2 />",{html:"Add New Payment Method"})).addClass("form--payment form--payment_create");form.appendTo("body");initPaymentForm(form)};var removeOverlay=function(){$("#payment_modal .button-cancel").removeAttr("disabled").trigger("click");$("#payment-form-overlay").remove();$("#ui-datepicker-div").hide()};var validatePaymentForm=function(form){form=$(form);if(form.is(".payment-form--bank_account")){return true}if(!isAddressValid(form)){return false}var ccNum=form.find("[name=cc_num]");var ccExpMonth=form.find("[name=cc_expm]");var ccExpYear=form.find("[name=cc_expy]");var ccCode=form.find("[name=cc_cvv]");if(ccNum.val()===""){alert("Please enter the card number only, no spaces or dashes");ccNum.focus();ccNum.select();return false}if(ccExpMonth.val()===""){alert("Please enter the expiry month");ccExpMonth.focus();ccExpMonth.select();return false}if(ccExpYear.val()===""){alert("Please enter the expiry year");ccExpYear.focus();ccExpYear.select();return false}if(ccCode.val()===""){alert("Please enter the card cvv");ccCode.focus();ccCode.select();return false}return true};var isAddressValid=function(form){form=$(form);var input;var error=false;var inputs=[{field:"street_1",element:form.find("[name=address1]")},{field:"city",element:form.find("[name=city]")},{field:"state",element:form.find("[name=state]")},{field:"country",element:form.find("[name=country]")},{field:"phone",element:form.find("[name=phone]")},{field:"zip",element:form.find("[name=zip]")},{field:"first_name",element:form.find("[name=firstName]")},{field:"last_name",element:form.find("[name=lastName]")}];for(var i=0;i<inputs.length;i++){input=inputs[i];if($(input.element).length>0){if($(input.element).val()===""){if(input.field==="state"){if($(input.element).is("select")){$(input.element).addClass("form-input--error");error=true}}else{$(input.element).addClass("form-input--error");error=true}}else{$(input.element).removeClass("form-input--error")}}}return!error};var tokenizePayment=function(paymentForm){var progress=new $.Deferred;if(!gatewayEncToken||gatewayEncToken===""||paymentForm.find("[name=payment_select]:checked").val()==="existing"){progress.resolve("");return progress.promise()}if(defaultGateway==="square"){gatewayData.square.client.requestCardNonce();var checkInterval=setInterval(function(){if(typeof gatewayData.square.nonceResponse==="object"){clearInterval(checkInterval);var response=gatewayData.square.nonceResponse;gatewayData.square.nonceResponse=false;$(".sq-input.form-input--error").removeClass("form-input--error");if(response.errors){var errorItem;var errorMap={cardNumber:"cc_num",expirationDate:"cc_expiry",cvv:"cc_cvv",postalCode:"payment-zip"};for(var x=0;x<response.errors.length;x++){errorItem=response.errors[x];if(errorMap[errorItem.field]){console.log("#"+errorMap[errorItem.field]);$("#"+errorMap[errorItem.field]).addClass("form-input--error")}}var error=response.errors.shift();progress.reject(error.message)}else{progress.resolve(response.nonce)}}},250)}else if(defaultGateway==="stripe"&&typeof Stripe!=="undefined"&&Stripe.version===3){progress.resolve("create_setup_intent")}else{var cardholderName=$.trim($("[name=firstName]",paymentForm).val()+$("[name=lastName]",paymentForm).val());var cardData={number:$("[name=cc_num]",paymentForm).val(),expirationMonth:$("[name=cc_expm]",paymentForm).val(),expirationYear:$("[name=cc_expy]",paymentForm).val(),cvv:$("[name=cc_cvv]",paymentForm).val()};if(cardholderName){cardData.cardholderName=cardholderName}if(typeof Stripe!=="undefined"&&Stripe.setPublishableKey){Stripe.setPublishableKey(gatewayEncToken);Stripe.card.createToken({number:cardData.number,exp_month:cardData.expirationMonth,exp_year:cardData.expirationYear,cvc:cardData.cvv},function(status,response){if(response.error){progress.reject(response.error.message)}else{progress.resolve(response.id)}})}else if(typeof braintree!=="undefined"){if(braintree.VERSION.indexOf("3.")===0){braintree.client.create({authorization:gatewayEncToken},function(createErr,client){cardData.billingAddress={streetAddress:$("#payment-address-1").val(),postalCode:$("#payment-zip",paymentForm).val()};var data={creditCard:cardData};client.request({endpoint:"payment_methods/credit_cards",method:"post",data:data},function(requestErr,response){if(requestErr){progress.reject()}else{progress.resolve(response.creditCards[0].nonce)}})})}else{var client=new braintree.api.Client({clientToken:gatewayEncToken});client.tokenizeCard(cardData,function(err,nonce){if(err)progress.reject();progress.resolve(nonce)})}}else if(typeof Accept!=="undefined"){var auth=gatewayEncToken.split(".");var authData={clientKey:auth[1],apiLoginID:auth[0]};var ccData={fullName:cardData.cardholderName,cardNumber:cardData.number,month:cardData.expirationMonth,year:cardData.expirationYear,cardCode:cardData.cvv};var secureData={authData:authData,cardData:ccData};Accept.dispatchData(secureData,function(resp){if(resp.messages.resultCode==="Error"){progress.reject()}else{progress.resolve(resp.opaqueData.dataValue)}})}else if(typeof eCrypt!=="undefined"){var encrypted=eCrypt.encryptValue(cardData.number,gatewayEncToken);progress.resolve(encrypted)}else{progress.resolve("")}}return progress.promise()};var updatePayment=function(form,metadata){form=$(form);metadata=metadata||{};var paymentMethodId=form.find("[name=identifier]").val();var data={payment_method_id:paymentMethodId,customer_token:loginInst.token,id:loginInst.appId,metadata:metadata};if(form.is(".payment-form--bank_account")){var acctType=form.find("[name=acct_type]");var acctName=form.find("[name=acct_name]");var bankName=form.find("[name=bank_name]");var routingNum=form.find("[name=routing_num]");var accountNum=form.find("[name=account_num]");data.profile={acct_type:acctType.val(),acct_name:acctName.val(),bank_name:bankName.val(),routing_num:routingNum.val(),account_num:accountNum.val()}}else{var ccNum=form.find("[name=cc_num]");var ccExpMonth=form.find("[name=cc_expm]");var ccExpYear=form.find("[name=cc_expy]");var ccCode=form.find("[name=cc_cvv]");data.profile={num:ccNum.val(),code:ccCode.val(),exp_m:ccExpMonth.val(),exp_y:ccExpYear.val()}}var address1=form.find("[name=address1]");var address2=form.find("[name=address2]");var phone=form.find("[name=phone]");var firstName=form.find("[name=firstName]");var lastName=form.find("[name=lastName]");var country=form.find("[name=country]");var state=form.find("[name=state]");var city=form.find("[name=city]");var zip=form.find("[name=zip]");data.address={first_name:firstName.val(),last_name:lastName.val(),address1:address1.val(),address2:address2.val(),city:city.val(),state:state.val(),country:country.val(),phone:phone.val(),zip:zip.val()};form.find(".btns").children().attr("disabled","disabled");form.find("input[type=submit]").val("Saving...");var url="/apps/recurring/storefront/payments/";if(typeof paymentMethodId!=="undefined"){url+=paymentMethodId}else{url+="create"}return tokenizePayment(form).pipe(function(token){if(token&&token!==""){data.profile={nonce:token};if(defaultGateway==="square"){if(gatewayData.square.cardData){data.profile.last4=gatewayData.square.cardData.last_4;data.profile.exp_m=gatewayData.square.cardData.exp_month.toString();data.profile.exp_y=gatewayData.square.cardData.exp_year;if(gatewayData.square.cardData.exp_month<10){data.profile.exp_m="0"+data.profile.exp_m}if(gatewayData.square.postalCode!==""){data.address.zip=gatewayData.square.postalCode}}}else if(defaultGateway==="ewayrapid"){data.profile.exp_m=ccExpMonth.val();data.profile.exp_y=ccExpYear.val();if(typeof eCrypt!=="undefined"){data.profile.code=eCrypt.encryptValue(ccCode.val(),gatewayEncToken)}}else{data.profile.exp_m=ccExpMonth.val();data.profile.exp_y=ccExpYear.val();if(data.cc_number){data.profile.last4=data.cc_number.substr(-4,4)}}delete data.cc_number;delete data.cc_cvv}return MINIBC.request(data,url,"post","json")})};var createPaymentMethod=function(form,metadata){form=$(form);if(!validatePaymentForm(form)){return false}updatePayment(form,metadata).done(function(resp){if(resp.action==="authorization"){if(defaultGateway==="stripe"&&Stripe.version===3){var stripe=gatewayData.stripe.client;var cardElement=gatewayData.stripe.card;var actionData=resp.data;var intentData;if(typeof actionData.token!=="undefined"){intentData={payment_method:actionData.token}}else{intentData={payment_method:{card:cardElement,billing_details:actionData.billing_details}}}stripe.confirmCardSetup(actionData.secret,intentData).then(function(confirmResp){if(confirmResp.setupIntent){createPaymentMethod(form,confirmResp)}else if(confirmResp.error){showCreditCardResponse(confirmResp.error.message);form.find(".btns").children().removeAttr("disabled");form.find("input[type=submit]").val("Save")}else{form.find(".btns").children().removeAttr("disabled");form.find("input[type=submit]").val("Save")}},function(){showConfirmationResponse("payment_method_update_error");form.find(".btns").children().removeAttr("disabled");form.find("input[type=submit]").val("Save")})}}else if(resp.success===true){resp.enableDelete=true;var profileItem,insertItem=false;if(resp.card){var expiry=resp.expiry.split("/");profileItem=renderCreditCardProfile(resp);$(".cc-num",profileItem).html(resp.card);$(".cc-expm",profileItem).html(expiry[0]);$(".cc-expy",profileItem).html(expiry[1]);insertItem=true}else if(resp.routing_last4){profileItem=renderBankAccountProfile(resp);$(".bank-name",profileItem).html(resp.bank_name);$(".bank-routing",profileItem).html("****"+resp.routing_last4);$(".bank-account",profileItem).html("****"+resp.account_last4);insertItem=true}if(insertItem){profileItem.insertBefore($(".account-payment-methods .address:last-child"))}showConfirmationResponse("payment_method_update_success")}}).fail(function(err){showConfirmationResponse("payment_method_update_error");form.find(".btns").children().removeAttr("disabled");form.find("input[type=submit]").val("Save")})};var updatePaymentMethod=function(form,metadata){form=$(form);if(!validatePaymentForm(form)){return false}var paymentMethodId=form.find("[name=identifier]").val();updatePayment(form,metadata).done(function(resp){if(resp.action==="authorization"){if(defaultGateway==="stripe"&&Stripe.version===3){var stripe=gatewayData.stripe.client;var cardElement=gatewayData.stripe.card;var actionData=resp.data;var intentData;if(typeof actionData.token!=="undefined"){intentData={payment_method:actionData.token}}else{intentData={payment_method:{card:cardElement,billing_details:actionData.billing_details}}}stripe.confirmCardSetup(actionData.secret,intentData).then(function(confirmResp){if(confirmResp.setupIntent){updatePaymentMethod(form,confirmResp)}else if(confirmResp.error){var dialogType=paymentMethodId?"payment_method_update_error":"payment_method_create_error";showCreditCardResponse(confirmResp.error.message);form.find(".btns").children().removeAttr("disabled");form.find("input[type=submit]").val("Save")}else{form.find(".btns").children().removeAttr("disabled");form.find("input[type=submit]").val("Save")}},function(){var dialogType=paymentMethodId?"payment_method_update_error":"payment_method_create_error";showConfirmationResponse(dialogType);form.find(".btns").children().removeAttr("disabled");form.find("input[type=submit]").val("Save")})}}else if(resp.success===true){var wrapper,listItem=$("[data-id="+paymentMethodId+"]").closest(".address-details");if(resp.card){wrapper=listItem.find(".cc-info");wrapper.parents(".address-details").siblings(".address-title").html(resp.type);wrapper.children(".cc-num").html(resp.card);wrapper.children(".cc-expiry").html(resp.expiry)}else if(resp.routing_last4){wrapper=listItem.find(".bank-info");wrapper.find(".bank-name").html(resp.bank_name);wrapper.find(".bank-routing").html("****"+resp.routing_last4);wrapper.find(".bank-account").html("****"+resp.account_last4)}hidePaymentUpdateForm();alert("Your payment method was updated successfully.")}}).fail(function(){var message=paymentMethodId?"An error occurred while trying to update your payment method. Please try again later.":"An error occurred while trying to create your payment method. Please try again later.";alert(message);form.find(".btns").children().removeAttr("disabled");form.find("input[type=submit]").val("Save")})};var deletePaymentMethod=function(paymentId){var parent=$(".delete-btn[data-id="+paymentId+"]").closest(".address");if(confirm("You're about to delete this payment method. Are you sure?")){MINIBC.request({},"/apps/recurring/storefront/payments/"+paymentId+"/delete","post","json").then(function(resp){if(resp.success===true){alert("Your payment method was deleted successfully.");$(parent).remove()}}).fail(function(){alert("An error occurred while trying to delete your payment method. Please try again later.");return false})}};var bindPaymentMethodListEvent=function(container){$(container).on("click",".edit-btn",function(e){e.preventDefault();showPaymentUpdateForm($(this).attr("data-id"),this)}).on("click",".delete-btn",function(e){e.preventDefault();deletePaymentMethod($(this).attr("data-id"))}).on("click",".new-btn",function(e){e.preventDefault();showCreatePaymentForm()});$("body").on("submit",".payment-form.form--payment",function(e){e.preventDefault();if($(this).is(".form--payment_create")){createPaymentMethod(this)}else{updatePaymentMethod(this)}}).on("click",".payment-form .button-cancel",function(e){e.preventDefault();hidePaymentUpdateForm();return false})};var loadPaymentFormTemplates=function(){mbc.request({stencil:true},"/apps/recurring/storefront/payments/templates","post","json").done(function(resp){if(!resp.success){return}paymentForms=resp.templates})};var showModal=function(){var modal=$("#payment_modal");modal.on("click",".button-cancel, .modal-close",function(e){e.preventDefault();modal.foundation("reveal","close").fadeOut(200).promise().done(function(){$(this).remove()});$(".modal-background").fadeOut(200).promise().done(function(){$(this).remove()});return false}).foundation("reveal","open")};var loadCountries=function(){mbc.request({stencil:true},"/apps/recurring/storefront/countries","post","json").done(function(resp){countries=resp})};var loadStates=function(countryName){return $.getJSON("/remote/v1/country-states/"+countryName)};var loadTimeZones=function(){mbc.request({stencil:true},"/apps/recurring/storefront/timezones","post","json").done(function(resp){timeZones=resp})};var injectSubscriptionMenuLinks=function(){var navBar=$(".navBar .navBar-section");var orderLink=navBar.find("li:first");var subsLink=$('<li class="navBar-item"/>').prop("data-type","subscriptions").css("cursor","pointer");subsLink.append($('<a class="navBar-action" href="/my-autoships">AutoShips</a>'));navBar.find("li:nth-child(2)").replaceWith(subsLink);var mobileNavMenu=$(".navPage-subMenu .navPage-subMenu-list");var mobileSubsLink=$('<li class="navPage-subMenu-item"/>').prop("data-type","subscriptions").prop("data-heading","AutoShips");mobileSubsLink.append($('<a class="navPage-subMenu-action navPages-action" href="/my-autoships">AutoShips</a>'));mobileNavMenu.children("li:nth-child(2)").replaceWith(mobileSubsLink)};var injectSubscriptionListButton=function(){var navBar=$(".navBar .navBar-section");var orderLink=navBar.find("li:first").addClass("navBar-action").prop("data-type","orders").prop("data-heading","Orders").css("cursor","pointer");var subsLink=$('<li class="navBar-item"/>').prop("data-type","subscriptions").prop("data-heading","AutoShips").css("cursor","pointer");subsLink.append($('<a class="navBar-action" href="/my-autoships">AutoShips</a>'));navBar.find("li:nth-child(2)").replaceWith(subsLink);var mobileNavMenu=$(".navPage-subMenu .navPage-subMenu-list");var mobileOrdersLink=mobileNavMenu.children("li:first-child").prop("data-type","orders").prop("data-heading","Orders");var mobileSubsLink=$('<li class="navPage-subMenu-item"/>').prop("data-type","subscriptions").prop("data-heading","AutoShips");mobileSubsLink.append($('<a class="navPage-subMenu-action navPages-action" href="/my-autoships">AutoShips</a>'));mobileNavMenu.children("li:nth-child(2)").replaceWith(mobileSubsLink);$(".account-heading").hide();subsLink.on("click",function(){window.location.hash="#"+$(this).prop("data-type");if(window.location.search+"?action=order_status"){$(this).addClass("is-active");orderLink.removeClass("is-active");switchOrderContent($(this).prop("data-type"))}});orderLink.on("click",function(){window.location.hash="#"+$(this).prop("data-type");if(window.location.search+"?action=order_status"){$(this).addClass("is-active");subsLink.removeClass("is-active");switchOrderContent($(this).prop("data-type"));$(".account-heading").hide()}});mobileSubsLink.on("click",function(){window.location.hash="#"+$(this).prop("data-type");if(window.location.search+"?action=order_status"){$(this).find("a").addClass("is-active");mobileOrdersLink.find("a").removeClass("is-active");switchOrderContent($(this).prop("data-type"));$(".page-heading").html($(this).prop("data-heading"));$(".mobileMenu-toggleIcon").click()}});mobileOrdersLink.on("click",function(){window.location.hash="#"+$(this).prop("data-type");if(window.location.search+"?action=order_status"){$(this).find("a").addClass("is-active");mobileSubsLink.find("a").removeClass("is-active");switchOrderContent($(this).prop("data-type"));$(".page-heading").html($(this).prop("data-heading"))}});if(window.location.hash=="#subscriptions"){$(".page-heading").html("Subscriptions");interval=setInterval(function(){if($(".account-list.orders-list").length>0){clearInterval(interval);subsLink.click();showSubscriptionsList();mobileSubsLink.find("a").addClass("is-active");mobileOrdersLink.find("a").removeClass("is-active")}},500)}$(".account-list").addClass("orders-list");$(".pagination").addClass("orders-pagination")};var showSubscriptionsList=function(){var subsLink=$(".navBar .navBar-section li:nth-child(2)");var mobileSubsLink=$(".navPage-subMenu .navPage-subMenu-list li:nth-child(2)");var mobileOrdersLink=$(".navPage-subMenu .navPage-subMenu-list li:nth-child(1)");setTimeout(function(){subsLink.click();mobileSubsLink.find("a").addClass("is-active");mobileOrdersLink.find("a").removeClass("is-active")},1e3)};var injectPaymentListButton=function(){var accountHeading=$("<h3 />").addClass("account-heading settings-heading");var detailsLink=$("<a />",{html:"Account Details"}).prop("data-type","details").addClass("active");var paymentsLink=$("<a />",{html:"Payment Methods"}).prop("data-type","payments");accountHeading.append(detailsLink).append(paymentsLink).insertBefore("form[data-edit-account-form]");accountHeading.on("click","a:not(.active)",function(){$(".active",accountHeading).removeClass("active");$(this).addClass("active");switchAccountContent($(this).prop("data-type"))})};var switchOrderContent=function(type){var ordersList=$(".account-list.orders-list");var ordersPagination=$(".pagination.orders-pagination");var subsList=$(".account-list.subs-list");if(type==="orders"){subsList.hide();ordersList.show();ordersPagination.show()}else{ordersList.hide();ordersPagination.hide();subsList.show()}};var switchAccountContent=function(type){var accountForm=$("[data-edit-account-form]");var payments=$(".account-payment-methods");if(type==="details"){payments.hide();accountForm.show()}else{accountForm.hide();payments.show()}};var initPaymentForm=function(form){if(defaultGateway==="square"){var expiryLabel=$(".payment--new .form-label:eq(1)",form);expiryLabel.next(".form-row--half").remove();expiryLabel.attr("for","cc_expiry");$('<input type="text" id="cc_expiry" name="cc_expiry" class="form-input" />').insertAfter(expiryLabel);var squareClient=new SqPaymentForm({applicationId:gatewayEncToken,inputClass:"sq-input",autoBuild:false,cardNumber:{elementId:"cc_num",placeholder:""},expirationDate:{elementId:"cc_expiry",placeholder:""},cvv:{elementId:"cc_cvv",placeholder:""},postalCode:{elementId:"payment-zip",placeholder:""},callbacks:{paymentFormLoaded:function(){$("form",form).css("visibility","visible")},cardNonceResponseReceived:function(errors,nonce,cardData){gatewayData.square.nonceResponse={errors:errors,nonce:nonce,cardData:cardData};if(cardData){gatewayData.square.postalCode=cardData.billing_postal_code;gatewayData.square.cardData=cardData}}}});squareClient.build();gatewayData.square={client:squareClient,nonceResponse:false,postalCode:"",cardData:false}}else if(defaultGateway==="stripe"){if(typeof Stripe!=="undefined"&&Stripe.version===3){$(".payment--new",form).html('<div id="mbc-card-element" class="form-input" />');var stripe=Stripe(gatewayEncToken);var elements=stripe.elements();var card=elements.create("card",{hidePostalCode:true});card.mount("#mbc-card-element");gatewayData.stripe={client:stripe,card:card}}}};var bindEvents=function(){$("body").on("change",".form-select-wrapper select",function(e){var selected=$(this).find("option:checked").val();if(!selected)selected="";$(this).siblings(".form-selected-text").html(selected)}).on("change",".payment-form select[name=country]",function(e){var form=$(this).closest(".payment-form"),countryName=this.options[e.target.selectedIndex].text;loadStates(countryName).done(function(resp){updateFormStateField(resp,form)})})};var loadSharedAssets=function(){loadDefaultCSS();loadPaymentFormTemplates();loadCountries();bindEvents()};this.init=function(login){loginInst=login;if(loginInst.loggedIn!==true){document.location.assign("/login.php")}var urlParams=document.location.search;if(urlParams.indexOf("order_status")>-1&&"false"==="false"){loadSharedAssets();injectSubscriptionListButton();showSubscriptions(loginInst);return}else{injectSubscriptionMenuLinks()}if(urlParams.indexOf("account_details")>-1){loadSharedAssets();injectPaymentListButton();showPaymentMethods(loginInst)}}}})(window.jQuery,MINIBC)}
if(typeof MINIBC!=="undefined"){(function($,mbc){if(typeof mbc.RecurringPayments==="undefined")mbc.RecurringPayments={};mbc.RecurringPayments.Login=function(){var self=this;this.loginChecked=$.Deferred();this.loggedIn=false;this.token=false;this.appId="tby5hk0sdm3a2vmzyipyp9sc73ypvuy";this.getCustomerToken=function(){return mbc.getCustomerToken(self.appId).pipe(function(token){self.token=token;return mbc.verifyCustomerToken(self.appId,token)})};var checkLoginStatus=function(){self.getCustomerToken(self.appId).pipe(function(data){self.loggedIn=true;self.customer=data;if(data["exp_time"]!=="undefined"){var exp_time=typeof data["exp_time"]==="number"?data["exp_time"]*1e3:-1;var now=new Date;var refresh_time=exp_time-now.getTime();if(exp_time>0){setTimeout(function(){checkLoginStatus()},refresh_time)}}}).fail(function(){self.loggedIn=false;self.token=false}).always(function(){self.loginChecked.resolve()})};this.init=function(){checkLoginStatus()}}})(window.jQuery,MINIBC)}
(function($,Login,Checkout,Account,FinishOrder,Unsubscribe){$(function(){if(!Login)return;var uri=window.location.pathname,params=window.location.search;if(uri.indexOf("/checkout/order-confirmation")===0){}else if(uri.indexOf("/checkout")===0||uri==="/account.php"||uri==="/login.php"&&params.indexOf("account_created")>-1){var login=new Login;login.init();login.loginChecked.then(function(){if(uri.indexOf("/checkout")===0){if(!Checkout)return;var checkout=new Checkout;checkout.init(login)}else{if(!Account)return;var account=new Account;account.init(login)}})}else if(uri==="{{ not_configured }}"){if(!Unsubscribe)return;var unsubscribe=new Unsubscribe;unsubscribe.init()}var loadPaymentFormTemplates=function(){MINIBC.request({stencil:true},"/apps/recurring/storefront/payments/templates","post","json").done(function(resp){if(!resp.success){return}paymentForms=resp.templates})};var loadDefaultCSS=function(){return MINIBC.request({legal:true},"/apps/recurring/storefront/css","post","text").done(function(resp){var customCss=$('link[href*="custom.css"]');var defaultCss=$('<style type="text/css" />');defaultCss.html(resp);if(customCss.length>0){defaultCss.insertBefore(customCss)}else{$("head").append(defaultCss)}})};var paymentForms={};var product_id=$("input[name=product_id]").attr("value");if($("input[name=product_id]").length!==0){product_id=$("input[name=original_product_id]").attr("value")}if(uri!=="/checkout.php"&&uri!=="/checkout"&&uri!=="/login.php"&&uri!=="/finishorder.php"&&uri!=="/account.php"&&uri!=="/cart.php"){MINIBC.request({},"/apps/recurring/storefront/product/"+product_id+"/isSubscription","post","text").done(function(resp){var product=JSON.parse(resp);loadPaymentFormTemplates();loadDefaultCSS();if(product.is_subscription){$("#form-action-addToCart").click(function(e){showLegalConfirmationForm(product)})}else{enableButtonModal(product)}})}function enableButtonModal(product){$("#form-action-addToCart").click(function(e){var option_select=$("select[data-product-attribute-subscriptions-select]");if(option_select.length!=0){if(option_select.val()!=""){e.preventDefault();var selected_product_id=option_select.find(":selected").attr("data-product-id");MINIBC.request({},"/apps/recurring/storefront/product/"+selected_product_id+"/isSubscription","post","text").done(function(resp){var product=JSON.parse(resp);if(product.is_subscription){showLegalConfirmationForm(product)}else{alert("product no setup correctly!")}})}}});$("body").on("click","#legal-form .button-cancel",function(e){e.preventDefault();hideLegalConfirmationForm();return false})}function showLegalConfirmationForm(product){var form=buildUpdateForm(123,"legal_confirmation");var text1="${name}&nbsp;".replace("${name}",product.product_name);var text2=" | ${frequency} Subscription".replace("${frequency}",product.frequency);var page_qty=$(".form-input--incrementTotal").val();if(!page_qty)page_qty=1;var newText=form[0].innerHTML.replace("${frequency}",product.frequency).replace("${name}",product.product_name).replace("${price}",parseFloat(product.price*page_qty).toFixed(2)).replace("${weight_lb}",product.weight_lb).replace("${weight_oz}",product.weight_oz).replace("${quantity}",page_qty).replace("${img_url}",product.img_url);form[0].innerHTML=newText;$("#legal-form",form).addClass("form--subscription").prepend('<span style="float:right; font-size:26px;margin-top:8px; cursor:pointer;" id="close-legal">&#215;</span>').prepend('<h3 style="display: inline-block; text-align: center; width: 95%">'+text1+' <span style="color:#36b0c9; font-size:35px;">'+text2+"</span></h3>");form.appendTo("form[data-cart-item-add]");$("#close-legal").click(function(){hideLegalConfirmationForm()})}function hideLegalConfirmationForm(){removeOverlay()}var removeOverlay=function(){$("#payment_modal .button-cancel").removeAttr("disabled").trigger("click");$("#payment-form-overlay").remove()};var buildUpdateForm=function(identifier,type){var html=$(paymentForms[type].html);var form=html.is("form")?html:$("form",html);if(identifier){form.append('<input type="hidden" name="identifier" value="'+identifier+'" />')}var wrapper=$('<div id="payment-form-overlay" />');wrapper.append(html);return wrapper}})})(window.jQuery,MINIBC.RecurringPayments.Login,MINIBC.RecurringPayments.Checkout,MINIBC.RecurringPayments.Account,MINIBC.SavedPayments.FinishOrder,MINIBC.SavedPayments.Unsubscribe);
var promoCartPage=function(promo,_affirm_config,$,mbc){var getCart=function(){return $.ajax({url:"/api/storefront/carts",headers:{Accept:"application/json"},dataType:"json"})};var getCheckoutByID=function(){return $.ajax({url:"/api/storefront/checkouts/"+cart_id,headers:{Accept:"application/json"},dataType:"json"})};var getProductInfo=function(){var progress=new $.Deferred;if(product_ids!=undefined){var data={id:product_ids};mbc.request(data,"/apps/affirm/storefront/product","get","json").done(function(resp){progress.resolve(resp)}).fail(function(resp){progress.reject()})}else{progress.reject()}return progress.promise()};var getProductIDs=function(checkout){var result=[];var items=checkout.cart.lineItems;var keys=Object.keys(items);var itemsArray=keys.map(function(i){return items[i]});if(itemsArray.length==0){return undefined}itemsArray.forEach(function(itemList){if(itemList.length>0){itemList.forEach(function(item){result.push(item.productId)})}});return result.join(",")};var getElementForPromoInjecting=function(){if(promo[page]&&promo[page].theme=="default"){var el_by_default=document.getElementsByClassName("cart-totals");if(el_by_default.length>0){return el_by_default[0]}else{return undefined}}else{if(promo[page].selector==""){return undefined}else{var el_by_id=document.getElementById(promo[page].selector);var el_by_class=document.getElementsByClassName(promo[page].selector);if(el_by_id!=null){return el_by_id}else if(el_by_class.length>0){return el_by_class[0]}else{return undefined}}}};var buildPromoMessage=function(data){var item=document.createElement("P");item.style.marginBottom="0px";item.classList.add("affirm-as-low-as");item.setAttribute("data-page-type","cart");item.setAttribute("data-amount",amount);if(data.logo_color!="default"){item.setAttribute("data-affirm-color",data.logo_color)}if(data.logo_type!="default"){item.setAttribute("data-affirm-type",data.logo_type)}if(data.promo_id!=""){item.setAttribute("data-promo-id",data.promo_id)}if(categoty_list!=""){item.setAttribute("data-category",categoty_list)}if(sku_list!=""){item.setAttribute("data-sku",sku_list)}if(brand_list!=""){item.setAttribute("data-brand",brand_list)}return item};var setStyle=function(element,data){element.style.display="inline-block";element.style.height=data.container_style.height;element.style.width=data.container_style.width;element.style.textAlign="right";return element};var getProductInfoData=function(data){var result="";var keys=Object.keys(data);for(var i=0;i<keys.length;i++){if(data[keys[i]]!=="false"){result+=data[keys[i]]+","}}return result.substring(0,result.length-1)};var displayPromo=function(){if(injecting_element!=undefined){var min=0;if(promo[page].minimum!=""){var merchant_min_value=parseInt(parseFloat(promo[page].minimum)*100);if(merchant_min_value>min){min=merchant_min_value}}if(amount>min){var data=promo[page];div.id="afffirm-promo-box";div.appendChild(buildPromoMessage(data));div=setStyle(div,data);injecting_element.appendChild(div);watchForChangeOnCartPage();(function(l,g,m,e,a,f,b){var d,c=l[m]||{},h=document.createElement(f),n=document.getElementsByTagName(f)[0],k=function(a,b,c){return function(){a[b]._.push([c,arguments])}};c[e]=k(c,e,"set");d=c[e];c[a]={};c[a]._=[];d._=[];c[a][b]=k(c,a,b);a=0;for(b="set add save post open empty reset on off trigger ready setProduct".split(" ");a<b.length;a++)d[b[a]]=k(c,e,b[a]);a=0;for(b=["get","token","url","items"];a<b.length;a++)d[b[a]]=function(){};h.async=!0;h.src=g[f];n.parentNode.insertBefore(h,n);delete g[f];d(g);l[m]=c})(window,_affirm_config,"affirm","checkout","ui","script","ready")}}};var watchForChangeOnCartPage=function(){var time;var check=function(){var el=document.getElementById("afffirm-promo-box");if(el==undefined){getCheckoutByID().done(function(checkout){var new_amount=parseInt(parseFloat(checkout.grandTotal)*100);var element=getElementForPromoInjecting();element.appendChild(div);document.getElementById("afffirm-promo-box").childNodes[0].setAttribute("data-amount",new_amount);affirm.ui.refresh()}).fail(function(err){console.error(err)})}};time=setInterval(check,1e3)};var page="cart";var product_ids="";var injecting_element=getElementForPromoInjecting();var cart_id="";var div=document.createElement("DIV");var categoty_list;var sku_list;var brand_list;var amount;if(promo[page].status){getCart().done(function(cart){if(cart[0]&&cart[0].id)cart_id=cart[0].id;getCheckoutByID().done(function(checkout){product_ids=getProductIDs(checkout);amount=parseInt(parseFloat(checkout.grandTotal)*100);getProductInfo().done(function(product_info){categoty_list=getProductInfoData(product_info.data["categories"]);sku_list=getProductInfoData(product_info.data["skus"]);brand_list=getProductInfoData(product_info.data["brands"]);displayPromo()}).fail(function(result){})}).fail(function(err){console.error(err)})}).fail(function(){console.error(err)})}};
var promoProductPage=function(promo,_affirm_config,$,mbc){var getProductID=function(){var el=document.getElementsByName("product_id");if(el.length>0){return el[0].value}else{return undefined}};var getElementForPromoInjecting=function(class_name){var el_by_default=document.getElementsByClassName(class_name);if(el_by_default.length>0){return el_by_default[0]}else{el_by_default=document.getElementById(class_name);return el_by_default}};var watchForChangeOnProductPage=function(){$(document).ajaxComplete(function(event,xhr,settings){var response=JSON.parse(xhr.responseText);if(settings.data!=undefined){if(settings.data.indexOf("getProductAttributeDetails")>-1){var price=parseInt(parseFloat(response.details.unformattedPrice)*100);if(promo[page].inline_pricing){price=getInlinePrice()}var el=document.getElementById("afffirm-promo-box");if(el!=undefined){el.childNodes[0].setAttribute("data-amount",price);affirm.ui.refresh()}}if(settings.data.indexOf("getProductAttributeDetails")>-1){var price=parseInt(parseFloat(response.details.unformattedPrice)*100);if(promo[page].inline_pricing){price=getInlinePrice()}var el=document.getElementById("afffirm-promo-box");if(el!=undefined){el.childNodes[0].setAttribute("data-amount",price);affirm.ui.refresh()}}}if(_affirm_config.option_selector!=undefined){$("."+_affirm_config.option_selector).on("change",function(){setTimeout(function(){var price_raw=$("."+_affirm_config.price_selector).html();var price=parseInt(parseFloat(Number(price_raw.replace(/[^0-9.-]+/g,"")))*100);if(promo[page].inline_pricing){price=getInlinePrice()}var el=document.getElementById("afffirm-promo-box");if(el!=undefined){el.childNodes[0].setAttribute("data-amount",price);affirm.ui.refresh()}},1200)})}})};var buildPromoMessage=function(data){var item=document.createElement("P");item.style.marginBottom="0px";item.classList.add("affirm-as-low-as");item.setAttribute("data-page-type","product");item.setAttribute("data-amount",amount);if(data.logo_color!="default"){item.setAttribute("data-affirm-color",data.logo_color)}if(data.logo_type!="default"){item.setAttribute("data-affirm-type",data.logo_type)}if(data.promo_id!=""){item.setAttribute("data-promo-id",data.promo_id)}if(categoty_list!=""){item.setAttribute("data-category",categoty_list)}if(sku_list!=""){item.setAttribute("data-sku",sku_list)}if(brand_list!=""){item.setAttribute("data-brand",brand_list)}return item};var setStyle=function(element,data){element.style.display="inline-block";element.style.height=data.container_style.height;element.style.width=data.container_style.width;element.style.textAlign="left";return element};var getProductInfo=function(){var progress=new $.Deferred;if(product_id!=undefined){var data={id:product_id};mbc.request(data,"/apps/affirm/storefront/product","get","json").then(function(resp){progress.resolve(resp)}).fail(function(resp){progress.reject()})}else{progress.reject()}return progress.promise()};var getProductInfoData=function(data){var result="";var keys=Object.keys(data);for(var i=0;i<keys.length;i++){if(data[keys[i]]!=="false"){result+=data[keys[i]]+","}}return result.substring(0,result.length-1)};var displayPromo=function(){if(injecting_element!=undefined){var min=0;if(promo[page].minimum!=""){var merchant_min_value=parseInt(parseFloat(promo[page].minimum)*100);if(merchant_min_value>min){min=merchant_min_value}}if(amount>min){var data=promo[page];var div=document.createElement("DIV");div.id="afffirm-promo-box";div.appendChild(buildPromoMessage(data));div=setStyle(div,data);injecting_element.appendChild(div);watchForChangeOnProductPage();if(promo[page].inline_pricing)productOptionChange();console.log("_affirm_config Window:",window._affirm_config);(function(m,g,n,d,a,e,h,c){var b=m[n]||{},k=document.createElement(e),p=document.getElementsByTagName(e)[0],l=function(a,b,c){return function(){a[b]._.push([c,arguments])}};b[d]=l(b,d,"set");var f=b[d];b[a]={};b[a]._=[];f._=[];b._=[];b[a][h]=l(b,a,h);b[c]=function(){b._.push([h,arguments])};a=0;for(c="set add save post open empty reset on off trigger ready setProduct".split(" ");a<c.length;a++)f[c[a]]=l(b,d,c[a]);a=0;for(c=["get","token","url","items"];a<c.length;a++)f[c[a]]=function(){};k.async=!0;k.src=g[e];p.parentNode.insertBefore(k,p);delete g[e];f(g);m[n]=b})(window,window._affirm_config,"affirm","checkout","ui","script","ready","jsReady")}}};var productOptionChange=function(){$("body").on("click",function(e){setTimeout(function(){var new_price=getInlinePrice();var el=document.getElementById("afffirm-promo-box");if(el==undefined){data=promo[page];var div=document.createElement("DIV");div.id="afffirm-promo-box";div.appendChild(buildPromoMessage(data));div=setStyle(div,data);injecting_element.appendChild(div);var element=$(".price .price--withoutTax .product_price");element.append(div);div.setAttribute("data-amount",new_price);affirm.ui.refresh();el=div}if(!isNaN(new_price)&&new_price&&new_price!=amount){amount=new_price;el.childNodes[0].setAttribute("data-amount",new_price);affirm.ui.refresh()}},1e3)})};var displayPromoQuick=function(quick_injecting_element){if(quick_injecting_element!=undefined){var min=0;if(promo[page].minimum!=""){var merchant_min_value=parseInt(parseFloat(promo[page].minimum)*100);if(merchant_min_value>min){min=merchant_min_value}}var priceSelector=".previewCartCheckout-price";var price=$(priceSelector).html().trim();var formatted_price=Number(price.replace(/[^0-9.-]+/g,""));formatted_price=Math.abs(parseFloat(formatted_price)*100);if(formatted_price>min){if("selector"in promo.quick_cart&&promo.quick_cart.selector!=""){var class_name=promo.quick_cart.selector;var el_by_default=document.getElementsByClassName(class_name);if(el_by_default.length>0){quick_injecting_element=el_by_default[0]}else if(el_by_default.length===0){quick_injecting_element=document.getElementById(class_name)}}var promo_config={field:"ala",amount:formatted_price,logo_color:promo.quick_cart.logo_color=="default"?"blue":promo.quick_cart.logo_color,logo_type:promo.quick_cart.logo_type=="default"?"logo":promo.quick_cart.logo_type,page_type:"product",show_cta:true};$.ajax({url:(_affirm_config.api_endpoint?"https://www.affirm.com/api/":"https://www.affirm.com/api/")+"promos/v2/"+_affirm_config.public_api_key+"?"+serialize(promo_config),type:"GET"}).done(function(res){var data=promo.quick_cart;var div=document.createElement("DIV");div.id="afffirm-promo-box-quick";var item=buildPromoMessage(data);item.innerHTML=res.promo.html_ala;item.style.marginTop="1rem";div.appendChild(item);div=setStyle(div,data);quick_injecting_element.appendChild(div);setTimeout(function(){var el=document.getElementById("afffirm-promo-box-quick");if(el){el.childNodes[0].setAttribute("data-amount",formatted_price);affirm.ui.refresh()}},500)}).fail(function(err){console.log("err",err)})}}};var getInlinePrice=function(){var target=".price-section--withoutTax .price--withoutTax";if(promo[page].inline_pricing_target&&promo[page].inline_pricing_target!="")target=promo[page].inline_pricing_target;if($(target).length===0)return false;var price=$(target).html();if(price.indexOf("-")>-1){price=price.split("-");price=parseFloat(price[0].replace(/[^0-9\.]/g,""))}else{price=parseFloat(price.replace(/[^0-9\.]/g,""))}return price*100};var serialize=function(obj){var str=[];for(var p in obj)if(obj.hasOwnProperty(p)){str.push(encodeURIComponent(p)+"="+encodeURIComponent(obj[p]))}return str.join("&")};var page="product";var product_id=getProductID();var injecting_element=getElementForPromoInjecting("productView-product");if(!injecting_element){injecting_element=getElementForPromoInjecting("productView-details")}if(promo[page].selector&&promo[page].selector!=""){injecting_element=getElementForPromoInjecting(promo[page].selector)}var categoty_list;var sku_list;var brand_list;var amount;if(promo[page].status){getProductInfo().then(function(product_info){categoty_list=getProductInfoData(product_info.data["categories"]);sku_list=getProductInfoData(product_info.data["skus"]);brand_list=getProductInfoData(product_info.data["brands"]);amount=product_info.data["amount"];if(promo[page].inline_pricing){amount=getInlinePrice();if(!amount)amount=product_info.data["amount"]}displayPromo();$("#form-action-addToCart").on("click",function(){setTimeout(function(){var quick_injecting_element=getElementForPromoInjecting("previewCartCheckout");displayPromoQuick(quick_injecting_element)},2e3)});$(".modal-close").on("click",function(){var el=document.getElementById("afffirm-promo-box");if(el!=undefined){el.childNodes[0].setAttribute("data-amount",amount);affirm.ui.refresh()}})}).fail(function(result){})}};
var promoCategoryPage=function(promo,_affirm_config,$,mbc){var getProductInfo=function(product_id){var progress=new $.Deferred;if(product_id!=undefined){var data={id:product_id};mbc.request(data,"/apps/affirm/storefront/product","get","json").then(function(resp){progress.resolve(resp)}).fail(function(resp){progress.reject()})}else{progress.reject()}return progress.promise()};var getProductInfoData=function(data){var result="";var keys=Object.keys(data);for(var i=0;i<keys.length;i++){if(data[keys[i]]!=="false"){result+=data[keys[i]]+","}}return result.substring(0,result.length-1)};var getProductInfoData=function(data){var result="";var keys=Object.keys(data);for(var i=0;i<keys.length;i++){if(data[keys[i]]!=="false"){result+=data[keys[i]]+","}}return result.substring(0,result.length-1)};var buildPromoMessage=function(data,amount,categoty_list,sku_list,brand_list){var item=document.createElement("P");item.style.marginBottom="0px";item.classList.add("affirm-as-low-as");item.setAttribute("data-page-type","category");item.setAttribute("data-amount",amount);if(data.logo_color!="default"){item.setAttribute("data-affirm-color",data.logo_color)}if(data.logo_type!="default"){item.setAttribute("data-affirm-type",data.logo_type)}if(data.promo_id!=""){item.setAttribute("data-promo-id",data.promo_id)}if(categoty_list!=""){item.setAttribute("data-category",categoty_list)}if(sku_list!=""){item.setAttribute("data-sku",sku_list)}if(brand_list!=""){item.setAttribute("data-brand",brand_list)}return item};var setStyle=function(element,data){element.style.display="inline-block";element.style.height=data.container_style.height;element.style.width=data.container_style.width;element.style.textAlign="right";return element};var displayPromo=function(){var min=0;if(promo[page].minimum!=""){var merchant_min_value=parseInt(parseFloat(promo[page].minimum));if(merchant_min_value>min){min=merchant_min_value}}var target_products=promo[page].selector&&promo[page].selector!=""?promo[page].selector:"#product-listing-container .product";var products_length=$(target_products).length;var count=0;var total=0;$(target_products).each(function(key,item){var price_target=".price--withoutTax";if(promo[page].price_selector&&promo[page].price_selector.length>3)price_target=promo[page].price_selector;var html_price=$(price_target,item).html();if(!html_price||html_price.length===0)return true;var price=$(price_target,item).html().replace(/[^0-9\.\-]/g,"");if(promo[page].inline_pricing&&price.indexOf("-")>-1){price=price.split("-");price=price[0].replace(/[^0-9\.]/g,"")}var id=$("img",item).attr("src").replace(/https:\/\/([^\/]*)\/([^\/]*)\/([^\/]*)\/([^\/]*)\/([^\/]*)\/([^\/]*)\/([^\/]*)\/([^\/]*)(.*)/,"$7");if(id==="img"&&$("img",item).attr("data-src")){id=$("img",item).attr("data-src").replace(/https:\/\/([^\/]*)\/([^\/]*)\/([^\/]*)\/([^\/]*)\/([^\/]*)\/([^\/]*)\/([^\/]*)\/([^\/]*)(.*)/,"$7")}if(isNaN(id)){$(item).find("a").each(function(){keyx=$(this).attr("data-product-id");if(keyx){id=keyx}})}total++;getProductInfo(id).done(function(product_info){if(price&&parseFloat(price)>min){console.log("Use this affirm code!");var categoty_list=getProductInfoData(product_info.data["categories"]);var sku_list=getProductInfoData(product_info.data["skus"]);var brand_list=getProductInfoData(product_info.data["brands"]);var data=promo[page];var div=document.createElement("DIV");div.id="afffirm-promo-box-"+id;div.appendChild(buildPromoMessage(data,Math.round(price*100),categoty_list,sku_list,brand_list));div=setStyle(div,data);var target_body=promo[page].selector_container&&promo[page].selector_container!=""?"."+promo[page].selector_container:".card-body";$(target_body,item).append(div);$.ajax({url:affirm.config.frontend_url+"/api/promos/v2/"+_affirm_config.public_api_key,method:"GET",data:{field:"ala",amount:Math.round(price*100),logo_color:promo[page].logo_color==="default"?"blue":promo[page].logo_color,logo_type:promo[page].logo_type==="default"?"logo":promo[page].logo_type,page_type:"product",show_cta:true},success:function(affirm_data){var html=affirm_data.promo.html_ala;$("#afffirm-promo-box-"+id+" .affirm-as-low-as").html(html);$("#afffirm-promo-box-"+id+" .affirm-as-low-as").css({"text-align":"left"});$("#afffirm-promo-box-"+id+" .affirm-as-low-as a").remove();count++;if(count===products_length||count===total)affirm.ui.refresh()},error:function(affirm_error){count++;if(count===products_length||count===total)affirm.ui.refresh()}})}else{count++;if(count===products_length||count===total)affirm.ui.refresh()}})})};var page="category";if(promo[page].status){(function(l,g,m,e,a,f,b){var d,c=l[m]||{},h=document.createElement(f),n=document.getElementsByTagName(f)[0],k=function(a,b,c){return function(){a[b]._.push([c,arguments])}};c[e]=k(c,e,"set");d=c[e];c[a]={};c[a]._=[];d._=[];c[a][b]=k(c,a,b);a=0;for(b="set add save post open empty reset on off trigger ready setProduct".split(" ");a<b.length;a++)d[b[a]]=k(c,e,b[a]);a=0;for(b=["get","token","url","items"];a<b.length;a++)d[b[a]]=function(){};h.async=!0;h.src=g[f];n.parentNode.insertBefore(h,n);delete g[f];d(g);l[m]=c})(window,_affirm_config,"affirm","checkout","ui","script","ready");displayPromo()}};
(function($,mbc){var metaData={platform_type:"BigCommerce",platform_version:"BeAPartOf - 1.0",platform_affirm:"1.0"};var store_data={};function defer(){if(window.jQuery){var Checkout=function(){var checkoutStatus="pending";var checkoutId="";var paymentSubmitted=false;var selectors={placeOrderBtn:"#checkout-payment-continue"};var getCart=function(){var progress=new $.Deferred;$.ajax({url:"/api/storefront/carts",headers:{Accept:"application/json"},dataType:"json"}).done(function(resp){var cart=resp.shift();progress.resolve(cart)}).fail(function(){progress.reject()});return progress.promise()};var getStoreCredit=function(customerId){var progress=new $.Deferred;if(customerId<=0){progress.resolve(0)}else{mbc.request({},"/apps/affirm/customers/"+customerId+"/credit","get","json").done(function(resp){progress.resolve(resp.store_credit)}).fail(function(){progress.resolve(0)})}return progress.promise()};var getDiscounts=function(cart){var discounts={};(function(data){data.forEach(function(item,index){discounts[item.code]={discount_amount:item.used,discount_display_name:"Gift Certificate #"+item.code}})})(cart.giftCertificates);(function(data){data.forEach(function(item,index){discounts[item.code]={discount_amount:item.discountedAmount,discount_display_name:item.displayName}})})(cart.coupons);return discounts};var getBillingInformation=function(cart){var billing=cart.billingAddress;return{name:{first:billing.firstName,last:billing.lastName},address:{line1:billing.address1,line2:billing.address2,city:billing.city,state:billing.stateOrProvinceCode,zipcode:billing.postalCode,country:billing.countryCode},phone_number:billing.phone,email:billing.email}};var getProductCategories=function(cart){var result=[];var items=cart.cart.lineItems;var keys=Object.keys(items);var itemsArray=keys.map(function(i){return items[i]});var progress=new $.Deferred;itemsArray.forEach(function(itemList){if(itemList.length>0){itemList.forEach(function(item){result.push(item.productId)})}});var mbc_data={id:result.join(",")};mbc.request(mbc_data,"/apps/affirm/storefront/product","get","json").done(function(resp){progress.resolve(resp.data.categories)}).fail(function(){progress.reject()});return progress.promise()};var getProductCategoriesResults=function(categories,id){return categories[id].split(",")};var bindEvents=function(){$("html").on("click",selectors.placeOrderBtn,function(e){var id=$(".optimizedCheckout-form-checklist-checkbox:checked").attr("id");if(paymentSubmitted||id!=="radio-cod"){return true}e.preventDefault();if(checkoutStatus!=="ready"){return false}if(checkoutStatus==="error"){return false}disableFinishOrderButton()});var unhideAffirm=function(){var paymentMethod=$('.form-checklist label[for="radio-cod"]');if(paymentMethod.length!==0){paymentMethod.css("display","block");shouldAffirmBeDisplayed();clearInterval(unhideAffirmCheck)}};var unhideAffirmCheck=setInterval(unhideAffirm,1e3)};var disableFinishOrderButton=function(){$(selectors.placeOrderBtn).attr("disabled",true)};var init=function(){disableFinishOrderButton();getCart().done(function(cart){checkoutId=cart.id;checkoutStatus="ready";bindEvents()}).fail(function(){checkoutStatus="error"})};return{init:init}};var shouldAffirmBeDisplayed=function(){if(store_data.hideAffirm){hideAffirm()}else{$.ajax({url:"/api/storefront/carts",headers:{Accept:"application/json"},dataType:"json"}).success(function(cart){var cartAmount=parseFloat(cart[0].cartAmount);var min=parseFloat(store_data.min_order);var max=parseFloat(store_data.max_order);if(cartAmount>min&&cartAmount<max){showAffirm()}else{hideAffirm()}}).fail(function(result){hideAffirm()})}};var showAffirm=function(){setInterval(function(){var data=Array.prototype.slice.call(document.getElementsByClassName("paymentProviderHeader-name"));if(data.length>0){$('.form-checklist label[for="radio-cod"]').css("display","block");data.forEach(function(item){if(item.innerHTML.includes("Affirm")||item.innerHTML.includes("Monthly Payments")){item.innerHTML="<p style='height:25px;margin:0px;display:flex;align-items:flex-end'><img src='https://cdn-assets.affirm.com/images/blue_logo-transparent_bg.png' style='height:25px;'> <span style='height:15px;margin-left:5px;';>Monthly Payments</span></p>";item.id="affirm-payment-option";document.getElementById("radio-cod").addEventListener("click",function(){if(document.getElementById("radio-cod").checked){showPaymentOption()}})}})}},500)};var hideAffirm=function(){setInterval(function(){var data=Array.prototype.slice.call(document.getElementsByClassName("paymentProviderHeader-name"));if(data.length>0){data.forEach(function(item){if(item.innerHTML.includes("Affirm")||item.innerHTML.includes("Monthly")){var affirmOption=document.getElementById("affirm-payment-option");if(affirmOption){affirmOption.parentNode.outerHTML=""}else{item.parentNode.parentNode.parentNode.parentNode.outerHTML=""}}})}},500)};var showPaymentOption=function(){if(document.getElementById("radio-cod").checked){var item=document.getElementById("affirm-payment-option");var parent=item.parentElement.parentElement.parentElement.parentElement.parentElement;parent.getElementsByClassName("form-checklist-body")[0].innerHTML="You will be redirected to Affirm to securely complete your purchase. Just fill out a few pieces of basic information and get a real-time decision. Checking your eligibility won't affect your credit score."}};var showCustomLoading=function(){var check=function(){if(document.getElementsByTagName("body")[0]!=undefined){var el=document.getElementById("affirm-custom-loading");if(el==undefined){var loading=document.createElement("DIV");loading.id="affirm-custom-loading";loading.style.width="100%";loading.style.height="100%";loading.style.zIndex="1000";loading.style.backgroundColor="rgb(245, 245, 245)";loading.style.position="fixed";loading.style.top="0px";loading.style.left="0px";loading.style.display="flex";loading.style.alignItems="flex-start";loading.style.justifyContent="center";loading.style.opacity="0.9";var message=document.createElement("P");message.style.fontFamily="font-family: 'proxima-nova-regular', -apple-system,BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;";message.style.fontSize="15px";message.style.color="#FFFFFF";message.style.backgroundColor="black";message.style.lingHeight="1.7";message.style.fontWeight="400";message.style.borderRadius="10px";message.style.padding="8px 16px 8px 16px";message.style.margin="90px 0px 0px 0px";var textnode=document.createTextNode("Loading");message.appendChild(textnode);loading.appendChild(message);document.getElementsByTagName("body")[0].appendChild(loading)}else{document.getElementById("affirm-custom-loading").style.display="flex"}clearInterval(time)}};var time=setInterval(check,1e3)};var hideCustomLoading=function(){document.getElementById("affirm-custom-loading").style.display="none"};var redirect=function(message,path){if(confirm(message)){window.location.replace(path)}else{window.location.replace(path)}};var setStoreHash=function(){console.log("loading configuration");mbc.request({},"/apps/affirm/storefront/config","get","json").done(function(data){store_data=data;window._affirm_config={script:data.endpoint,api_endpoint:data.api_endpoint,option_selector:data.optionSelector?data.optionSelector:"product-options",price_selector:data.priceSelector?data.priceSelector:"price--withoutTax",public_api_key:data.public_api_key};if(data.region=="0"){window._affirm_config.locale="en_US";window._affirm_config.country_code="USA"}if(data.region=="1"){window._affirm_config.locale="fr_CA";window._affirm_config.country_code="CAN"}if(window.location.pathname=="/checkout"){(function(l,g,m,e,a,f,b){var d,c=l[m]||{},h=document.createElement(f),n=document.getElementsByTagName(f)[0],k=function(a,b,c){return function(){a[b]._.push([c,arguments])}};c[e]=k(c,e,"set");d=c[e];c[a]={};c[a]._=[];d._=[];c[a][b]=k(c,a,b);a=0;for(b="set add save post open empty reset on off trigger ready setProduct".split(" ");a<b.length;a++)d[b[a]]=k(c,e,b[a]);a=0;for(b=["get","token","url","items"];a<b.length;a++)d[b[a]]=function(){};h.async=!0;h.src=g[f];n.parentNode.insertBefore(h,n);delete g[f];d(g);l[m]=c})(window,_affirm_config,"affirm","checkout","ui","script","ready");$.ajax({url:"/api/storefront/carts",headers:{Accept:"application/json"},dataType:"json"}).done(function(cart){if(cart[0]&&cart[0].id){var cart_id=cart[0].id;localStorage.setItem("cart_id",cart_id)}}).fail(function(cart){console.error(cart)})}else{if(data.promotional!=""){if(window.location.pathname.includes("/cart.php")){promoCartPage(JSON.parse(data.promotional),_affirm_config,$,mbc)}else if(window.location.pathname.includes("/order-confirmation")){var cart_id=localStorage.getItem("cart_id");submitAffirmAnalytics(cart_id,mbc,_affirm_config)}else if($("#product-listing-container").length>0&&$('[itemtype="http://schema.org/Product"]').length===0){promoCategoryPage(JSON.parse(data.promotional),undefined,$,mbc)}else{promoProductPage(JSON.parse(data.promotional),undefined,$,mbc)}}}}).fail(function(result){console.error("FAILED to get storefront config",result)})};setStoreHash()}else{setTimeout(defer,1e3)}}defer()})(window.jQuery,MINIBC);
var submitAffirmAnalytics=function(cart_id,mbc,_affirm_config){console.log("call start");console.log(cart_id);mbc.request({},"/apps/affirm/storefront/"+cart_id+"/analytic","get","json").done(function(resp){if(resp.order&&resp.product){console.log("Calling trackOrderConfirmed");var orderData=JSON.parse(resp.order);var productData=JSON.parse(resp.product);console.log("Date preview",orderData,productData);(function(l,g,m,e,a,f,b){var d,c=l[m]||{},h=document.createElement(f),n=document.getElementsByTagName(f)[0],k=function(a,b,c){return function(){a[b]._.push([c,arguments])}};c[e]=k(c,e,"set");d=c[e];c[a]={};c[a]._=[];d._=[];c[a][b]=k(c,a,b);a=0;for(b="set add save post open empty reset on off trigger ready setProduct".split(" ");a<b.length;a++)d[b[a]]=k(c,e,b[a]);a=0;for(b=["get","token","url","items"];a<b.length;a++)d[b[a]]=function(){};h.async=!0;h.src=g[f];n.parentNode.insertBefore(h,n);delete g[f];d(g);l[m]=c})(window,_affirm_config,"affirm","checkout","ui","script","ready");affirm.ui.ready(function(){trackOrderConfirmedObj={currency:orderData["currency"],orderId:orderData["orderId"],paymentMethod:orderData["paymentMethod"],total:orderData["total"]};console.log("Date preview3",trackOrderConfirmedObj);affirm.analytics.trackOrderConfirmed(trackOrderConfirmedObj,null,true)})}}).fail(function(e){console.log("failed");console.log(e)})};